/*
 * Generated by Flecha Roja Technologies Auto Generator
 *
 * Created on January 9, 2003, 11:31 AM
 */
package com.unify.webcenter.action;

import java.io.IOException;
import java.util.*;
import java.util.logging.*;

import java.sql.Timestamp;
import javax.servlet.*;
import javax.servlet.http.*;

import org.apache.struts.action.*;
import org.apache.commons.beanutils.*;

import com.unify.webcenter.data.*;
import com.unify.webcenter.broker.*;
import com.unify.webcenter.form.*;
import com.unify.webcenter.conf.TMSConfigurator;
import com.unify.webcenter.tools.excelFile;
import com.unify.webcenter.tools.loadTimeZone;
import java.io.OutputStream;
import java.math.BigDecimal;
import java.util.ArrayList;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;

/**
 * <p>This action works with both JSP and Velocity templates.
 * The type of template to be used is defined in the Struts configuration
 * file.</p>
 *
 * <p>The action support an <i>action</i> URL parameter. This URL parameter
 * controls what this action class does. The following values are supported:</p>
 * <ul>
 *   <li>save    Save the record
 *   <li>delete	 Delete the record
 *   <li>edit    Edit the record
 *   <li>show	 Show the record
 * </ul>
 *
 *
 * @author Administrator
 */
public class reportsAction extends Action {

    private static Logger logger = Logger.getLogger("com.unify");

    /** Creates a new instance of calendarAction */
    public reportsAction() {

    }

    /**
     * Handle server requests
     *
     * @param mapping The ActionMapping used to select this instance
     * @param actionForm The optional ActionForm bean for this request (if any)
     * @param request The HTTP request we are processing
     * @param response The HTTP response we are creating
     *
     * @exception IOException if an input/output error occurs
     * @exception ServletException if a servlet exception occurs
     */
    public ActionForward execute(ActionMapping mapping,
            ActionForm form,
            HttpServletRequest request,
            HttpServletResponse response)
            throws IOException, ServletException {
        String action;
        HttpSession session;
        reportsBroker broker;
        organizationsBroker brokerOrg;
        projectsBroker brokerProjects;
        membersBroker brokerMembers;
        type_tasksBroker brokerTaskType;
        teamsBroker brokerTeams;
        schedulesBroker scheduleBroker;
        String company = null;
        topicsBroker brokerTopics;

        session = request.getSession(false);

        // Si la sesion es nula, se debe redireccionar al login.
        if (session == null || session.getAttribute("login") == null) {

            // forward to display the home page
            return (mapping.findForward("login"));
        } else {
             //Set the selected tab
            session.setAttribute("current","reports");
            broker = new reportsBroker();
            brokerOrg = new organizationsBroker();
            brokerProjects = new projectsBroker();
            brokerMembers = new membersBroker();
            brokerTaskType = new type_tasksBroker();
            brokerTeams = new teamsBroker();
            brokerTopics = new topicsBroker();
            loadTimeZone timeZone = new loadTimeZone();
            try {

                if (form == null) {
                    System.out.println(" Creating new reportsForm bean under key " + mapping.getAttribute());
                    form = new reportsForm();
                }
                // Se atrapa el formulario
                reportsForm thisForm = (reportsForm) form;

                // Se obtiene la referencia al loginData dentro de la session.
                loginData user = (loginData) session.getAttribute("login");
                TMSConfigurator tms = new TMSConfigurator(user);
                company = tms.getCompany(user);
                request.setAttribute("version", TMSConfigurator.getVersion());
                // Se agrega al contexto la informacion del usuario
                request.setAttribute("userInfo", user);

                // fetch action from form
                action = ((reportsForm) form).getOperation();

                servlet.log("[DEBUG] reportsAction at perform(): Action is " + action);
                // Se agrega el link para el menu con la ruta

                System.out.println("ACTION. "+ action );


                if (action != null && (action.equals("add")|| action.equals("addTaskChange2"))) {
                    // Se agrega el link para el menu con la ruta

                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport"));


                    // Se trae la lista de todas las organizaciones.
                    request.setAttribute("list_organizations", getListing(brokerOrg, "name", "ASC", user.getId_account()));

                    /* El caso de la lista de miembros se debe modificar para que refleje las reglas nuevas
                    solicitadas por Luis Cardenas. A saber:
                    1.Si el usuario es ADMIN, entonces debe quedar tal cual esta hoy dia, es decir,
                    que le muestra todos los usuarios para hacer el reporte.
                    2.El el usuario es un lider de proyecto, debe mostrarle solo los usuarios que forman parte de
                    sus equipos de trabajo.
                    3.Si el usuario es un razo, el usuario por default es el usuario mismo, no como ahora que
                    un razo puede emitir un reporte de cualquier miembro.
                     */
                    if (user.isAdmin()) {
                        request.setAttribute("list_members", getListing(brokerMembers, "name", "ASC", user.getId_account()));
                        request.setAttribute("list_projects", getListing(brokerProjects, "name", "ASC", user.getId_account()));

                    } else {
                        teamsData teamValue;
                        teamsData teamValue2;
                        //Iterator e = brokerTeams.getListByMember("id", "ASC", user.getid(), user.getId_account());
                        projectsData projectData;
                        ArrayList listProject = new ArrayList();
                        Hashtable hashMembers = new Hashtable();
                        Hashtable hashProjects = new Hashtable();
                        
                        
                        brokerProjects.getMembersByProject2(String.valueOf(user.getid()), listProject, user.getId_account());
                        
                        /*while (e.hasNext()) {
                            teamValue = new teamsData();
                            teamValue = (teamsData) e.next();
                            projectData = new projectsData();
                            projectData = (projectsData) brokerProjects.getData(teamValue.getprojects(), user.getId_account());
                            listProject.add(projectData);
                            Iterator e2 = brokerTeams.getListByProject("id", "ASC", teamValue.getprojects(), 0, user.getId_account());
                            while (e2.hasNext()) {
                                teamValue2 = new teamsData();
                                teamValue2 = (teamsData) e2.next();
                                hashMembers.put("" + teamValue2.getmembers(),
                                        brokerMembers.getData(teamValue2.getmembers(), user.getId_account()));
                            }
                        }*/
                       /* membersData mem = (membersData) brokerMembers.getData(user.getid(), user.getId_account());
                        hashMembers.put("" + user.getid(), mem);*/
                        //Una vez que han sido procesados todos se procede a sacarlos
                        // del hash
                        /*Iterator col = hashMembers.values().iterator();
                        ArrayList lista = new ArrayList();*/
                        // Se pasan a un iterador y se ordenan para finalmente agregarlos
                        // al contexto.
                        /*while (col.hasNext()) {
                            lista.add(col.next());
                        }
                        Collections.sort(lista);*/
                        request.setAttribute("list_projects", listProject);
                        /*if (user.getprofile().equals("1")) {
                            request.setAttribute("list_members", lista);
                        } else {*/
                            // Es un usuario raso, se debe mostrar en la lista solo a el.
                            ArrayList lista2 = new ArrayList();
                            membersData mem2 = (membersData) brokerMembers.getData(user.getid(), user.getId_account());
                            lista2.add(mem2);
                            request.setAttribute("list_members", lista2);
                        //}
                    }
                    //Se define un Calendar.
                    Calendar now = Calendar.getInstance();
                    String hoy = "" + now.get(Calendar.YEAR) +
                            "-" + (now.get(Calendar.MONTH) + 1) +
                            "-" + now.get(Calendar.DAY_OF_MONTH);
                    // Se extrae el componente dia, mes y a?o del start_date
                    request.setAttribute("startDate1", hoy);
                    request.setAttribute("startDate2", hoy);
                    request.setAttribute("dueDate1", hoy);
                    request.setAttribute("dueDate2", hoy);
                    request.setAttribute("endDate1", hoy);
                    request.setAttribute("endDate2", hoy);

                    Iterator e = brokerTaskType.getList("description", "ASC", user.getId_account());
                    ArrayList listaTipoTasks = new ArrayList();
                    while (e.hasNext()) {
                        listaTipoTasks.add(e.next());
                    }
                    request.setAttribute("listTypeTasks", listaTipoTasks);


                    // En el caso de la operacion add, se despliega el formulario.
                    request.setAttribute("company", company);
                    if (!action.equals("addTaskChange2"))
                    return (mapping.findForward("displayAddForm"));
                    else
                    return (mapping.findForward("displayAddTaskStatusForm"));
                    // En el caso de la operacion add, se despliega el formulario.
                   /* request.setAttribute("company", company);
                    return (mapping.findForward("displayAddForm"));*/

                } else if (action != null && action.equals("delete")) {
                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = broker.getItems(fields, user.getId_account());

                    request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                    request.setAttribute("items", items);
                    request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayReports"));
                    request.setAttribute("do", request.getRequestURI());

                    // forward to display the list
                    request.setAttribute("company", company);
                    return (mapping.findForward("confirmDelete"));

                } else if (action != null && action.equals("applyDelete")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";
                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }

                    ArrayList items = broker.getItems(fields, user.getId_account());

                    // Se procede con el borrado de cada una de ellas.
                    reportsData dataDelete;
                    for (int i = 0; i < items.size(); i++) {
                        dataDelete = (reportsData) items.get(i);

                        // We delete the object in the DBMS
                        broker.delete(dataDelete);
                    }
                    request.setAttribute("company", company);
                    // forward to display the list
                    return (mapping.findForward("listing"));

                } else if (action != null && (action.equals("execute") || action.equals("sort")|| action.equals("executeTask"))) {
                    // Se trata de la ejecucion del reporte, se procede a invocar el
                    // metodo en el broker para generar el reportte de tareas.

                    if (action.equals("executeTask")){ 
                        request.setAttribute("menuRoute",
                                "<a href='./admin.do'>" +
                                ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Administration") + "</a>&nbsp;/&nbsp;" 
                                + "</a><a href='./reports.do?operation=addTaskChange2'>"
                                 + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayTaskChange")
                                + "</a>&nbsp;/&nbsp;"
                            + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));
                    
                    }else{
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>"
                            + ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports")
                            + "</a>&nbsp;/&nbsp;<a href='./reports.do?operation=add'>"
                            + ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport")
                            + "</a>&nbsp;/&nbsp;"
                            + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));

                        
                    }    
                    if (action.equals("sort")) {
                        // Se trata de un sort, tenemos que tomar la lista separadas por ,
                        // y convertirla en un String[]
                        thisForm.setprojects(request.getParameter("list_projects").split(","));
                        thisForm.setmembers(request.getParameter("list_members").split(","));
                        thisForm.setpriorities(request.getParameter("list_priorities").split(","));
                        thisForm.setstatus(request.getParameter("list_status").split(","));
                        thisForm.settypetasks(request.getParameter("list_typetasks").split(","));
       
                        request.setAttribute("sortcolumn",  thisForm.getsortColumn());
                    }
                    // Se guardan en el contexto
                    
                    String subs0="";
                    String subs="";
                    String subs1="";
                    String subs2="";
                    String subs3="";
                    String str0[]= new String[1];
                    String str[]= new String[1];
                    String str1[]= new String[1];
                    String str2[]= new String[1];
                    String str3[]= new String[1];
                    String listing_projects= "";
                    if (request.getParameter("listing_projects")==null){
                                if (thisForm.getprojects().length >1){
                                    for (int i=0; i<thisForm.getprojects().length; i++){
                                        if (i+1 != thisForm.getprojects().length){
                                            listing_projects=listing_projects + thisForm.getprojects()[i]+",";
                                        }else{
                                            listing_projects=listing_projects+thisForm.getprojects()[i];
                                        }
                                    }
                                }else{
                                     listing_projects=thisForm.getprojects()[0];
                                }
                        request.setAttribute("listing_projects", listing_projects);
                        request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
                    }else{
                        subs0= request.getParameter("listing_projects");
                        if(subs0.contains(",")){
                            request.setAttribute("list_projects", convertToString(subs0.split(",")));
                             thisForm.setprojects(subs0.split(","));
                        }else{
                            str0[0]= subs0;
                            request.setAttribute("list_projects", str0);
                             thisForm.setprojects(str0);
                        }
                        request.setAttribute("listing_projects", request.getParameter("listing_projects"));
                    }
                    String listing_members= "";
                    if (request.getParameter("listing_members")==null){
                                if (thisForm.getmembers().length >1){
                                    for (int i=0; i<thisForm.getmembers().length; i++){
                                        if (i+1 != thisForm.getmembers().length){
                                            listing_members=listing_members + thisForm.getmembers()[i]+",";
                                        }else{
                                            listing_members=listing_members+thisForm.getmembers()[i];
                                        }
                                    }
                                }else{
                                     listing_members=thisForm.getmembers()[0];
                                }
                        request.setAttribute("listing_members", listing_members);
                        request.setAttribute("list_members", convertToString(thisForm.getmembers()));
                    }else{
                        subs= request.getParameter("listing_members");
                        if(subs.contains(",")){
                            request.setAttribute("list_members", convertToString(subs.split(",")));
                             thisForm.setmembers(subs.split(","));
                        }else{
                            str[0]= subs;
                            request.setAttribute("list_members", str);
                             thisForm.setmembers(str);
                        }
                        request.setAttribute("listing_members", request.getParameter("listing_members"));
                    }
                    
                    String listing_priorities= "";
                    if (request.getParameter("listing_priorities")==null){
                                if (thisForm.getpriorities().length >1){
                                    for (int i=0; i<thisForm.getpriorities().length; i++){
                                        if (i+1 != thisForm.getpriorities().length){
                                            listing_priorities=listing_priorities + thisForm.getpriorities()[i]+",";
                                        }else{
                                            listing_priorities=listing_projects+thisForm.getpriorities()[i];
                                        }
                                    }
                                }else{
                                     listing_priorities=thisForm.getpriorities()[0];
                                }
                        request.setAttribute("listing_priorities", listing_priorities);
                        request.setAttribute("list_priorities", convertToString(thisForm.getpriorities()));
                    }else{
                        subs1= request.getParameter("listing_priorities");
                        if(subs1.contains(",")){
                            request.setAttribute("list_priorities", convertToString(subs1.split(",")));
                             thisForm.setpriorities(subs1.split(","));
                        }else{
                            str1[0]= subs1;
                            request.setAttribute("list_priorities", str1);
                             thisForm.setpriorities(str1);
                        }
                        request.setAttribute("listing_priorities", request.getParameter("listing_priorities"));
                    }
              String listing_status= "";
                    if (request.getParameter("listing_status")==null){
                                if (thisForm.getstatus().length >1){
                                    for (int i=0; i<thisForm.getstatus().length; i++){
                                        if (i+1 != thisForm.getstatus().length){
                                            listing_status=listing_status + thisForm.getstatus()[i]+",";
                                        }else{
                                            listing_status=listing_status+thisForm.getstatus()[i];
                                        }
                                    }
                                }else{
                                     listing_status=thisForm.getstatus()[0];
                                }
                        request.setAttribute("listing_status", listing_status);
                        request.setAttribute("list_status", convertToString(thisForm.getstatus()));
                    }else{
                        subs2= request.getParameter("listing_status");
                        if(subs2.contains(",")){
                            request.setAttribute("list_status", convertToString(subs2.split(",")));
                             thisForm.setstatus(subs2.split(","));
                        }else{
                            str2[0]= subs2;
                            request.setAttribute("list_status", str2);
                             thisForm.setstatus(str2);
                        }
                        request.setAttribute("listing_status", request.getParameter("listing_status"));
                    }
                              
                        String listing_typetasks= "";
                    if (request.getParameter("listing_typetasks")==null){
                                if (thisForm.gettypetasks().length >1){
                                    for (int i=0; i<thisForm.gettypetasks().length; i++){
                                        if (i+1 != thisForm.gettypetasks().length){
                                            listing_typetasks=listing_typetasks + thisForm.gettypetasks()[i]+",";
                                        }else{
                                            listing_typetasks=listing_typetasks+thisForm.gettypetasks()[i];
                                        }
                                    }
                                }else{
                                     listing_typetasks=thisForm.gettypetasks()[0];
                                }
                        request.setAttribute("listing_typetasks", listing_typetasks);
                        request.setAttribute("list_typetasks", convertToString(thisForm.gettypetasks()));
                    }else{
                        subs3= request.getParameter("listing_typetasks");
                        if(subs3.contains(",")){
                            request.setAttribute("list_typetasks", convertToString(subs3.split(",")));
                             thisForm.settypetasks(subs3.split(","));
                        }else{
                            str3[0]= subs3;
                            request.setAttribute("list_typetasks", str3);
                             thisForm.settypetasks(str3);
                        }
                        request.setAttribute("listing_typetasks", request.getParameter("listing_typetasks"));
                    }
                                        
                    request.setAttribute("spreadfix", thisForm.getspreadfix());
                    request.setAttribute("FechaInicio", request.getParameter("FechaInicio"));
                    request.setAttribute("FechaFinal", request.getParameter("FechaFinal"));
                    request.setAttribute("startDate1", request.getParameter("startDate1"));
                    request.setAttribute("startDate2", request.getParameter("startDate2"));
                    request.setAttribute("FechaEntrega", request.getParameter("FechaEntrega"));
                    request.setAttribute("dueDate1", request.getParameter("dueDate1"));
                    request.setAttribute("dueDate2", request.getParameter("dueDate2"));
                    request.setAttribute("FechaFinal", request.getParameter("FechaFinal"));
                    request.setAttribute("endDate1", request.getParameter("endDate1"));
                    request.setAttribute("endDate2", request.getParameter("endDate2"));
                    request.setAttribute("tareaCobrable", request.getParameter("tareaCobrable"));
                    request.setAttribute("tickStatus", request.getParameter("tickStatus"));
                    request.setAttribute("projStatus", request.getParameter("projStatus"));
                    request.setAttribute("published", request.getParameter("published"));
                    
                    String charge=thisForm.getTareaCobrable();
                    if (thisForm.getTareaCobrable()!= null){
                    if (thisForm.getTareaCobrable().equals("")){
                        charge="ALL";
                    }
                    }
                    Iterator e = broker.getReportByTasks(thisForm.getprojects(), thisForm.getmembers(),
                            thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),
                            request.getParameter("FechaInicio"),
                            request.getParameter("startDate1"), request.getParameter("startDate2"),
                            request.getParameter("FechaEntrega"),
                            request.getParameter("dueDate1"), request.getParameter("dueDate2"),
                            request.getParameter("FechaFinal"),
                            request.getParameter("endDate1"), request.getParameter("endDate2"),
                            thisForm.getsortColumn(), thisForm.getsortOrder(),
                            thisForm.getspreadfix(), user.getId_account(), thisForm.getPages(), charge, request.getParameter("published"));
                    
                     Iterator e1 = broker.getReportByTasksWithoutPaging(thisForm.getprojects(), thisForm.getmembers(),
                            thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),
                            request.getParameter("FechaInicio"),
                            request.getParameter("startDate1"), request.getParameter("startDate2"),
                            request.getParameter("FechaEntrega"),
                            request.getParameter("dueDate1"), request.getParameter("dueDate2"),
                            request.getParameter("FechaFinal"),
                            request.getParameter("endDate1"), request.getParameter("endDate2"),
                            thisForm.getsortColumn(), thisForm.getsortOrder(),
                            thisForm.getspreadfix(), user.getId_account(), charge,request.getParameter("published"));
                    // Debemos convertir el iterador en un arraylist.
                     
                    ArrayList lista = new ArrayList(); 
                    int count=0;
                    while (e.hasNext()) {
                        lista.add(e.next());
                    }
                    while (e1.hasNext()) {
                        e1.next();
                        count++;
                    }
                    setPages(count, request, "listPagesFiles");

                    // Se regresa al contexto la lista de todas las tareas que satisfacen
                    // la consulta estipulada.
                    request.setAttribute("list_report", lista);
                    request.setAttribute("total", ""+count);

                    // Y el resto de parametros del reporte
                    request.setAttribute("FechaInicio", request.getParameter("FechaInicio"));
                    request.setAttribute("startDate1", request.getParameter("startDate1"));
                    request.setAttribute("startDate2", request.getParameter("startDate2"));
                    request.setAttribute("FechaEntrega", request.getParameter("FechaEntrega"));
                    request.setAttribute("dueDate1", request.getParameter("dueDate1"));
                    request.setAttribute("dueDate2", request.getParameter("dueDate2"));
                    request.setAttribute("FechaFinal", request.getParameter("FechaFinal"));
                    request.setAttribute("endDate1", request.getParameter("endDate1"));
                    request.setAttribute("endDate2", request.getParameter("endDate2"));

                    if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                        // Negamos el tipo de ordenamiento
                        if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                            thisForm.setsortOrder("DESC");
                    request.setAttribute("sortOrder", "DESC");
                    request.setAttribute("sortLastOrder", "ASC");
                        } else {
                            thisForm.setsortOrder("ASC");
                    request.setAttribute("sortOrder", "ASC");
                    request.setAttribute("sortLastOrder", "DESC");
                        }
                    }
                    
                   request.setAttribute("sortOrder", thisForm.getsortOrder());
                    request.setAttribute("company", company);
                    // forward to display the list
                    if(!action.equals("executeTask")){
                    System.out.println("REPx6");
                        // forward to display the list
                        return (mapping.findForward("viewReport"));
                    }else{
                        // forward to display the list
                        return (mapping.findForward("viewReportChangeTask"));
                    }

                } else if (action != null && action.equals("view")) {
                    // Se trata de ver o reejecutar un reporte
                    reportsData data = (reportsData) broker.getData(thisForm.getid(), user.getId_account());

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));

                    // Se trata de un sort, tenemos que tomar la lista separadas por ,
                    // y convertirla en un String[]
                    thisForm.setprojects(data.getprojects().split(","));
                    thisForm.setmembers(data.getmembers().split(","));
                    thisForm.setpriorities(data.getpriorities().split(","));
                    thisForm.setstatus(data.getstatus().split(","));
                    thisForm.settypetasks(data.gettypetasks().split(","));

                    
                     // Se guardan en el contexto
//                    String subs="";
//                    String str[]= new String[1];
//                    
//                    String listing_projects= "";
//                    
//                    if (request.getParameter("listing_projects")==null){
//                        for (int i=0; i<thisForm.getprojects().length; i++){
//                            listing_projects=thisForm.getprojects()[i]+",";
//                        }
//                        request.setAttribute("listing_projects", listing_projects);
//                        request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
//                    }else{
//                        subs= request.getParameter("listing_projects").substring(0, request.getParameter("listing_projects").length()-1);
//                        if(subs.contains(",")){
//                            request.setAttribute("list_projects", convertToString(subs.split(",")));
//                             thisForm.setprojects(subs.split(","));
//                        }else{
//                            str[0]= subs;
//                            request.setAttribute("list_projects", convertToString(str));
//                             thisForm.setprojects(str);
//                        }
//                        request.setAttribute("listing_projects",  request.getParameter("listing_projects"));
//                    }
//                    
//                    String listing_members= "";
//                    if (request.getParameter("listing_members")==null){
//                        for (int i=0; i<thisForm.getmembers().length; i++){
//                            listing_members=thisForm.getmembers()[i]+",";
//                        }
//                        request.setAttribute("listing_members", listing_members);
//                        request.setAttribute("list_members", convertToString(thisForm.getmembers()));
//                    }else{
//                        subs= request.getParameter("listing_members").substring(0, request.getParameter("listing_members").length()-1);
//                        
//                        if(subs.contains(",")){
//                            request.setAttribute("list_members", convertToString(subs.split(",")));
//                             thisForm.setmembers(subs.split(","));
//                        }else{
//                            str[0]= subs;
//                            request.setAttribute("list_members", convertToString(str));
//                             thisForm.setmembers(str);
//                        }
//                        request.setAttribute("listing_members", request.getParameter("listing_members"));
//                    }
//                    
//                    String listing_priorities= "";
//                    if (request.getParameter("listing_priorities")==null){
//                        for (int i=0; i<thisForm.getpriorities().length; i++){
//                            listing_priorities=thisForm.getpriorities()[i]+",";
//                        }
//                        request.setAttribute("listing_priorities", listing_priorities);
//                        request.setAttribute("list_priorities", convertToString(thisForm.getpriorities()));
//                    }else{
//                        //String subs= request.getParameter("listing_priorities");
//                        request.getParameter("listing_priorities").substring(0, request.getParameter("listing_priorities").length()-1);
//                        subs= request.getParameter("listing_priorities").substring(0, request.getParameter("listing_priorities").length()-1);
//                        if(subs.contains(",")){
//                            request.setAttribute("list_priorities", convertToString(subs.split(",")));
//                             thisForm.setpriorities(subs.split(","));
//                        }else{
//                            str[0]= subs;
//                            request.setAttribute("list_priorities", convertToString(str));
//                             thisForm.setpriorities(str);
//                        }
//                        request.setAttribute("listing_priorities", request.getParameter("listing_priorities"));
//                    }
//                    
//                    String listing_status= "";    
//                    if (request.getParameter("listing_status")==null){
//                        for (int i=0; i<thisForm.getstatus().length; i++){
//                        listing_status=thisForm.getstatus()[i]+",";
//                    }
//                        request.setAttribute("listing_status", listing_status);
//                        request.setAttribute("list_status", convertToString(thisForm.getstatus()));
//                    }else{
//                        subs= request.getParameter("listing_status").substring(0, request.getParameter("listing_status").length()-1);
//                        if(subs.contains(",")){
//                            request.setAttribute("list_status", convertToString(subs.split(",")));
//                             thisForm.setstatus(subs.split(","));
//                        }else{
//                            str[0]= subs;
//                            request.setAttribute("list_status", convertToString(str));
//                             thisForm.setstatus(str);
//                        }
//                        request.setAttribute("listing_status", request.getParameter("listing_status"));
//                    }                       
//                    
//                    String listing_typetasks= "";    
//                    if (request.getParameter("listing_typetasks")==null || request.getParameter("listing_typetasks").equals("")){
//                        for (int i=0; i<thisForm.gettypetasks().length; i++){
//                        listing_typetasks=thisForm.gettypetasks()[i]+","; 
//                    }
//                        request.setAttribute("listing_typetasks", listing_typetasks);
//                        request.setAttribute("list_typetasks", convertToString(thisForm.gettypetasks()));
//                    }else{
//                        subs= request.getParameter("listing_typetasks").substring(0, request.getParameter("listing_typetasks").length()-1);
//                        if(subs.contains(",")){
//                            request.setAttribute("list_typetasks", convertToString(subs.split(",")));
//                             thisForm.settypetasks(subs.split(","));
//                        }else{
//                            str[0]= subs;
//                            request.setAttribute("list_typetasks", convertToString(str));
//                             thisForm.settypetasks(str);
//                        }
//                        request.setAttribute("listing_typetasks", request.getParameter("listing_typetasks"));
//                    }          
//                    
//                    // Se guardan en el contexto
//                    request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
//                    request.setAttribute("list_members", convertToString(thisForm.getmembers()));
//                    request.setAttribute("list_priorities", convertToString(thisForm.getpriorities()));
//                    request.setAttribute("list_status", convertToString(thisForm.getstatus()));
//                    request.setAttribute("list_typetasks", convertToString(thisForm.gettypetasks()));
//                    
                    
                    String subs0="";
                    String subs="";
                    String subs1="";
                    String subs2="";
                    String subs3="";
                    String str0[]= new String[1];
                    String str[]= new String[1];
                    String str1[]= new String[1];
                    String str2[]= new String[1];
                    String str3[]= new String[1];
                    String listing_projects= "";
                    if (request.getParameter("listing_projects")==null){
                                if (thisForm.getprojects().length >1){
                                    for (int i=0; i<thisForm.getprojects().length; i++){
                                        if (i+1 != thisForm.getprojects().length){
                                            listing_projects=listing_projects + thisForm.getprojects()[i]+",";
                                        }else{
                                            listing_projects=listing_projects+thisForm.getprojects()[i];
                                        }
                                    }
                                }else{
                                     listing_projects=thisForm.getprojects()[0];
                                }
                        request.setAttribute("listing_projects", listing_projects);
                        request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
                    }else{
                        subs0= request.getParameter("listing_projects");
                        if(subs0.contains(",")){
                            request.setAttribute("list_projects", convertToString(subs0.split(",")));
                             thisForm.setprojects(subs0.split(","));
                        }else{
                            str0[0]= subs0;
                            request.setAttribute("list_projects", str0);
                             thisForm.setprojects(str0);
                        }
                        request.setAttribute("listing_projects", request.getParameter("listing_projects"));
                    }
                    String listing_members= "";
                    if (request.getParameter("listing_members")==null){
                                if (thisForm.getmembers().length >1){
                                    for (int i=0; i<thisForm.getmembers().length; i++){
                                        if (i+1 != thisForm.getmembers().length){
                                            listing_members=listing_members + thisForm.getmembers()[i]+",";
                                        }else{
                                            listing_members=listing_members+thisForm.getmembers()[i];
                                        }
                                    }
                                }else{
                                     listing_members=thisForm.getmembers()[0];
                                }
                        request.setAttribute("listing_members", listing_members);
                        request.setAttribute("list_members", convertToString(thisForm.getmembers()));
                    }else{
                        subs= request.getParameter("listing_members");
                        if(subs.contains(",")){
                            request.setAttribute("list_members", convertToString(subs.split(",")));
                             thisForm.setmembers(subs.split(","));
                        }else{
                            str[0]= subs;
                            request.setAttribute("list_members", str);
                             thisForm.setmembers(str);
                        }
                        request.setAttribute("listing_members", request.getParameter("listing_members"));
                    }
                    
                    String listing_priorities= "";
                    if (request.getParameter("listing_priorities")==null){
                                if (thisForm.getpriorities().length >1){
                                    for (int i=0; i<thisForm.getpriorities().length; i++){
                                        if (i+1 != thisForm.getpriorities().length){
                                            listing_priorities=listing_priorities + thisForm.getpriorities()[i]+",";
                                        }else{
                                            listing_priorities=listing_projects+thisForm.getpriorities()[i];
                                        }
                                    }
                                }else{
                                     listing_priorities=thisForm.getpriorities()[0];
                                }
                        request.setAttribute("listing_priorities", listing_priorities);
                        request.setAttribute("list_priorities", convertToString(thisForm.getpriorities()));
                    }else{
                        subs1= request.getParameter("listing_priorities");
                        if(subs1.contains(",")){
                            request.setAttribute("list_priorities", convertToString(subs1.split(",")));
                             thisForm.setpriorities(subs1.split(","));
                        }else{
                            str1[0]= subs1;
                            request.setAttribute("list_priorities", str1);
                             thisForm.setpriorities(str1);
                        }
                        request.setAttribute("listing_priorities", request.getParameter("listing_priorities"));
                    }
              String listing_status= "";
                    if (request.getParameter("listing_status")==null){
                                if (thisForm.getstatus().length >1){
                                    for (int i=0; i<thisForm.getstatus().length; i++){
                                        if (i+1 != thisForm.getstatus().length){
                                            listing_status=listing_status + thisForm.getstatus()[i]+",";
                                        }else{
                                            listing_status=listing_status+thisForm.getstatus()[i];
                                        }
                                    }
                                }else{
                                     listing_status=thisForm.getstatus()[0];
                                }
                        request.setAttribute("listing_status", listing_status);
                        request.setAttribute("list_status", convertToString(thisForm.getstatus()));
                    }else{
                        subs2= request.getParameter("listing_status");
                        if(subs2.contains(",")){
                            request.setAttribute("list_status", convertToString(subs2.split(",")));
                             thisForm.setstatus(subs2.split(","));
                        }else{
                            str2[0]= subs2;
                            request.setAttribute("list_status", str2);
                             thisForm.setstatus(str2);
                        }
                        request.setAttribute("listing_status", request.getParameter("listing_status"));
                    }
                              
                        String listing_typetasks= "";
                    if (request.getParameter("listing_typetasks")==null){
                                if (thisForm.gettypetasks().length >1){
                                    for (int i=0; i<thisForm.gettypetasks().length; i++){
                                        if (i+1 != thisForm.gettypetasks().length){
                                            listing_typetasks=listing_typetasks + thisForm.gettypetasks()[i]+",";
                                        }else{
                                            listing_typetasks=listing_typetasks+thisForm.gettypetasks()[i];
                                        }
                                    }
                                }else{
                                     listing_typetasks=thisForm.gettypetasks()[0];
                                }
                        request.setAttribute("listing_typetasks", listing_typetasks);
                        request.setAttribute("list_typetasks", convertToString(thisForm.gettypetasks()));
                    }else{
                        subs3= request.getParameter("listing_typetasks");
                        if(subs3.contains(",")){
                            request.setAttribute("list_typetasks", convertToString(subs3.split(",")));
                             thisForm.settypetasks(subs3.split(","));
                        }else{
                            str3[0]= subs3;
                            request.setAttribute("list_typetasks", str3);
                             thisForm.settypetasks(str3);
                        }
                        request.setAttribute("listing_typetasks", request.getParameter("listing_typetasks"));
                    }
                    
           
                    
                    Iterator e = broker.getReportByTasks(thisForm.getprojects(), thisForm.getmembers(),
                            thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),
                            data.getind_range_start_date(),
                            data.getstart_date_start(), data.getend_date_start(),
                            data.getind_range_due_date(),
                            data.getstart_date_due(), data.getend_date_due(),
                            data.getind_range_end_date(),
                            data.getstart_date_end(), data.getend_date_end(),
                            thisForm.getsortColumn(), thisForm.getsortOrder(),
                            data.getspreadfix(), user.getId_account(), thisForm.getPages(), data.getChargeable(), null);
                                        
                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList(); 
                    while (e.hasNext()) {
                        lista.add(e.next());
                    }

                            Iterator e1 = broker.getReportByTasksWithoutPaging(thisForm.getprojects(), thisForm.getmembers(),
                            thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),
                            data.getind_range_start_date(),
                            data.getstart_date_start(), data.getend_date_start(),
                            data.getind_range_due_date(),
                            data.getstart_date_due(), data.getend_date_due(),
                            data.getind_range_end_date(),
                            data.getstart_date_end(), data.getend_date_end(),
                            thisForm.getsortColumn(), thisForm.getsortOrder(),
                            data.getspreadfix(), user.getId_account(), thisForm.getTareaCobrable(), null);
    
                    int count=0;
                    while (e1.hasNext()) {
                        e1.next();
                        count++;
                    }
                    setPages(count, request, "listPagesFiles");
                    
                    // Se regresa al contexto la lista de todas las tareas que satisfacen
                    // la consulta estipulada.
                    request.setAttribute("list_report", lista);
                    request.setAttribute("total", ""+count);

                    // Y el resto de parametros del reporte
                    request.setAttribute("FechaInicio", data.getind_range_start_date());
                    request.setAttribute("startDate1", data.getstart_date_start());
                    request.setAttribute("startDate2", data.getend_date_start());
                    request.setAttribute("FechaEntrega", data.getind_range_due_date());
                    request.setAttribute("dueDate1", data.getstart_date_due());
                    request.setAttribute("dueDate2", data.getend_date_due());
                    request.setAttribute("FechaFinal", data.getind_range_end_date());
                    request.setAttribute("endDate1", data.getstart_date_end());
                    request.setAttribute("endDate2", data.getend_date_end());
                    request.setAttribute("spreadfix", data.getspreadfix());
                    request.setAttribute("company", company);
                    
                    
                    // forward to display the list
                    return (mapping.findForward("viewReport"));

                } else if (action != null && action.equals("applyAdd")) {
                    // Se trata de guardar este reporte en la base de datos.
                    reportsData data = new reportsData();

                    // Se estipulan todos los campos propios del reporte
                    data.setid(0);
                    data.setname(thisForm.getname());
                    data.setowner(user.getid());
                    data.setmembers(request.getParameter("list_members"));
                    data.setspreadfix(request.getParameter("spreadfix"));
                    data.setpriorities(request.getParameter("list_priorities"));
                    data.setprojects(request.getParameter("list_projects"));
                    data.setstatus(request.getParameter("list_status"));
                    data.settypetasks(request.getParameter("list_typetasks"));
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("startDate1").toString());
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("startDate2").toString());
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("dueDate1").toString());
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("dueDate2").toString());
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("endDate1").toString());
                     servlet.log("[ERROR] Report Action: " +    request.getParameter("endDate2").toString());
                    data.setstart_date_start(Timestamp.valueOf(
                            request.getParameter("startDate1") + " 12:00:00.00"));
                    data.setend_date_start(Timestamp.valueOf(
                            request.getParameter("startDate2") + " 12:00:00.00"));
                    data.setstart_date_due(Timestamp.valueOf(
                            request.getParameter("dueDate1") + " 12:00:00.00"));
                    data.setend_date_due(Timestamp.valueOf(
                            request.getParameter("dueDate2") + " 12:00:00.00"));
                    data.setstart_date_end(Timestamp.valueOf(
                            request.getParameter("endDate1") + " 12:00:00.00"));
                    data.setend_date_end(Timestamp.valueOf(
                            request.getParameter("endDate2") + " 12:00:00.00"));
                    data.setind_range_due_date(request.getParameter("FechaEntrega"));
                    data.setind_range_start_date(request.getParameter("FechaInicio"));
                    data.setind_range_end_date(request.getParameter("FechaFinal"));
                    data.setChargeable(request.getParameter("tareaCobrable"));

                    // We set the create date & time
                    data.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    data.setId_account(user.getId_account());
                    // We add the new record.
                    broker.add(data);
                    request.setAttribute("company", company);
                    // forward to display the list
                    return (mapping.findForward("listing"));
                } else if (action != null && (action.equals("addQuery")||action.equals("addQuery1")
                        ||action.equals("addQuery2") )) {
                    // Se agrega el link para el menu con la ruta

                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport"));


                    // Se trae la lista de todas las organizaciones.
                    request.setAttribute("list_organizations", getListing(brokerOrg, "name", "ASC", user.getId_account()));

                    /* El caso de la lista de miembros se debe modificar para que refleje las reglas nuevas
                    solicitadas por Luis Cardenas. A saber:
                    1.Si el usuario es ADMIN, entonces debe quedar tal cual esta hoy dia, es decir,
                    que le muestra todos los usuarios para hacer el reporte.
                    2.El el usuario es un lider de proyecto, debe mostrarle solo los usuarios que forman parte de
                    sus equipos de trabajo.
                    3.Si el usuario es un razo, el usuario por default es el usuario mismo, no como ahora que
                    un razo puede emitir un reporte de cualquier miembro.
                     */
                    if (user.isAdmin()) {
                        request.setAttribute("list_members", getListing(brokerMembers, "name", "ASC", user.getId_account()));
                        request.setAttribute("list_projects", getListing(brokerProjects, "name", "ASC", user.getId_account()));

                    } else {
                        teamsData teamValue;
                        teamsData teamValue2;
                        Iterator e = brokerTeams.getListByMember("id", "ASC", user.getid(), user.getId_account());
                        projectsData projectData;
                        ArrayList listProject = new ArrayList();
                     /*   Hashtable hashMembers = new Hashtable();
                        while (e.hasNext()) {
                            teamValue = new teamsData();
                            teamValue = (teamsData) e.next();
                            projectData = new projectsData();
                            projectData = (projectsData) brokerProjects.getData(teamValue.getprojects(), user.getId_account());
                            listProject.add(projectData);
                            Iterator e2 = brokerTeams.getListByProject("id", "ASC", teamValue.getprojects(), 0, user.getId_account());
                            while (e2.hasNext()) {
                                teamValue2 = new teamsData();
                                teamValue2 = (teamsData) e2.next();
                                hashMembers.put("" + teamValue2.getmembers(),
                                        brokerMembers.getData(teamValue2.getmembers(), user.getId_account()));
                            }
                        }
                        membersData mem = (membersData) brokerMembers.getData(user.getid(), user.getId_account());
                        hashMembers.put("" + user.getid(), mem);*/
                        //Una vez que han sido procesados todos se procede a sacarlos
                        // del hash
                       /* Iterator col = hashMembers.values().iterator();
                        ArrayList lista = new ArrayList();*/
                        // Se pasan a un iterador y se ordenan para finalmente agregarlos
                        // al contexto.
                     /*   while (col.hasNext()) {
                            lista.add(col.next());
                        }
                        Collections.sort(lista);*/
                        
                        brokerProjects.getMembersByProject2(String.valueOf(user.getid()), listProject, user.getId_account());
                        request.setAttribute("list_projects", listProject);
                       /* if (user.getprofile().equals("1")) {
                            request.setAttribute("list_members", lista);
                        } else {*/
                            // Es un usuario raso, se debe mostrar en la lista solo a el.
                            ArrayList lista2 = new ArrayList();
                            membersData mem2 = (membersData) brokerMembers.getData(user.getid(), user.getId_account());
                            lista2.add(mem2);
                            request.setAttribute("list_members", lista2);
                       /* }*/
                    }
                    //Se define un Calendar.
                    Calendar now = Calendar.getInstance();
                    String hoy = "" + now.get(Calendar.YEAR) +
                            "-" + (now.get(Calendar.MONTH) + 1) +
                            "-" + now.get(Calendar.DAY_OF_MONTH);
                    // Se extrae el componente dia, mes y a?o del start_date
                    request.setAttribute("startDate1", hoy);
                    request.setAttribute("startDate2", hoy);
                    request.setAttribute("endDate1", hoy);
                    request.setAttribute("endDate2", hoy);

                    Iterator e = brokerTaskType.getList("description", "ASC", user.getId_account());
                    ArrayList listaTipoTasks = new ArrayList();
                    while (e.hasNext()) {
                        listaTipoTasks.add(e.next());
                    }

                    String typeOf="0";
                    if (action.equals("addQuery1")){typeOf="1";
                    }else{
                        if (action.equals("addQuery2")){
                        typeOf="2";
                        }

                    }

                    request.setAttribute ("typeOf", typeOf);
                    request.setAttribute("listTypeTasks", listaTipoTasks);
                    request.setAttribute("query", "%");
                    // En el caso de la operacion add, se despliega el formulario.
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAddQueryForm"));

                } else if (action != null && action.equals("addQueryTickets")) {
                        request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport"));
                    
                    if (user.isAdmin()) {
                        request.setAttribute("list_projects", getListing(brokerProjects, "name", "ASC", user.getId_account()));
                    }else{
                        ArrayList listProject = new ArrayList();
                        brokerProjects.getMembersByProject2(String.valueOf(user.getid()), listProject, user.getId_account());
                        request.setAttribute("list_projects", listProject);
                    }
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAddQueryTickForm"));
                }else if (action != null && action.equals("executeQueryTick")){
                    int count=0;
                    String subs="";
                    String listing_projects= "";
                    String str[]= new String[1];
                    if (request.getParameter("listing_projects")==null){
                                if (thisForm.getprojects().length >1){
                                    for (int i=0; i<thisForm.getprojects().length; i++){
                                        if (i != thisForm.getprojects().length-1){
                                            listing_projects=listing_projects + thisForm.getprojects()[i]+",";
                                        }else{
                                            listing_projects=listing_projects+thisForm.getprojects()[i];
                                        }
                                    }
                                }else{
                                     listing_projects=thisForm.getprojects()[0];
                                }
                        request.setAttribute("listing_projects", listing_projects);
                        request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
                    }else{
                        subs= request.getParameter("listing_projects");
                        
                        if(subs.contains(",")){
                             thisForm.setprojects(subs.split(","));
                        }else{
                            str[0]= subs;
                             thisForm.setprojects(str);
                        }
                            listing_projects=subs;
                            request.setAttribute("listing_projects", subs);
                     //   request.setAttribute("listing_projects", request.getParameter("listing_projects"));
                    }
                       Iterator e;
                       //  e = brokerTopics.getListByMember(thisForm.getsortColumnTopics(),
                        //        thisForm.getsortOrderTopics(),
                        //        idMember, currentPage, accountId);
                       e = broker.getReportByTickets(thisForm.getprojects(), request.getParameter("projStatus"), 
                               request.getParameter("tickStatus"), "last_post", "ASC",
                                thisForm.getQuery(),user.getId_account(), thisForm.getPages());
                            // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();
                    topicsData topicData = new topicsData();
                    while (e.hasNext()) {
                        topicData = (topicsData) e.next();
                        topicData.setlast_post(Timestamp.valueOf(topicData.convTimeZone(topicData.getlast_post(), user.getTime_zone())));
                        lista.add(topicData);
                        count++;
                    }
                    
                    
                    setPages(broker.getCount().intValue(), request, "listPagesFiles");
                    
                    request.setAttribute("listTopics", lista);
                       request.setAttribute("projStatus",request.getParameter("projStatus"));
                       request.setAttribute("tickStatus",request.getParameter("tickStatus"));
                     // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>&nbsp;/&nbsp;<a href='./reports.do?operation=addQueryTickets'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport") +
                            "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));
                    
                    request.setAttribute("totalReg", ""+broker.getCount().intValue());
                    request.setAttribute("company", company);
                    // forward to display the list
                        return (mapping.findForward("viewReportTick"));
                
                }else if (action != null && action.equals("executeQuery")) {

                    // Se trata de la ejecucion del reporte, se procede a invocar el
                    // metodo en el broker para generar el reportte de tareas.

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>&nbsp;/&nbsp;<a href='./reports.do?operation=addQuery'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addReport") +
                            "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));

                    
                    if (action.equals("sort")) {
                        // Se trata de un sort, tenemos que tomar la lista separadas por ,
                        // y convertirla en un String[]
                        thisForm.setprojects(request.getParameter("list_projects").split(","));
                        thisForm.setmembers(request.getParameter("list_members").split(","));
                        thisForm.setpriorities(request.getParameter("list_priorities").split(","));
                        thisForm.setstatus(request.getParameter("list_status").split(","));
                        thisForm.settypetasks(request.getParameter("list_typetasks").split(","));
                    } else {
                        thisForm.setsortColumn("taskid,day,to_date(day || hour_start, 'RRRR-MM-DDHH:MI am')");
                    }

                    // Se guardan en el contexto
                    String subs0="";
                    String subs="";
                    String subs1="";
                    String subs2="";
                    String subs3="";
                    String str0[]= new String[1];
                    String str[]= new String[1];
                    String str1[]= new String[1];
                    String str2[]= new String[1];
                    String str3[]= new String[1];
                    String listing_projects= "";
                    
                    if (request.getParameter("listing_projects")==null){
                                if (thisForm.getprojects().length >1){
                                    for (int i=0; i<thisForm.getprojects().length; i++){
                                        if (i != thisForm.getprojects().length-1){
                                            listing_projects=listing_projects + thisForm.getprojects()[i]+",";
                                        }else{
                                            listing_projects=listing_projects+thisForm.getprojects()[i];
                                        }
                                    }
                                }else{
                                     listing_projects=thisForm.getprojects()[0];
                                }
                        request.setAttribute("listing_projects", listing_projects);
                        request.setAttribute("list_projects", convertToString(thisForm.getprojects()));
                    }else{
                        subs= request.getParameter("listing_projects");
                        
                        if(subs.contains(",")){
                             thisForm.setprojects(subs.split(","));
                        }else{
                            str[0]= subs;
                             thisForm.setprojects(str);
                        }
                            listing_projects=subs;
                            request.setAttribute("listing_projects", subs);
                     //   request.setAttribute("listing_projects", request.getParameter("listing_projects"));
                    }
                    System.out.println("listing_projects "+ listing_projects);
                    
                    String listing_members= "";
                    if (request.getParameter("listing_members")==null){
                                if (thisForm.getmembers().length >1){
                                    for (int i=0; i<thisForm.getmembers().length; i++){
                                        if (i != thisForm.getmembers().length-1){
                                            listing_members=listing_members + thisForm.getmembers()[i]+",";
                                        }else{
                                            listing_members=listing_members+thisForm.getmembers()[i];
                                        }
                                    }
                                }else{
                                     listing_members=thisForm.getmembers()[0];
                                }
                        request.setAttribute("listing_members", listing_members);
                        request.setAttribute("list_members", convertToString(thisForm.getmembers()));
                    }else{
                        subs0= request.getParameter("listing_members");
                        if(subs0.contains(",")){
                             thisForm.setmembers(subs0.split(","));
                        }else{
                            str0[0]= subs0;
                             thisForm.setmembers(str0);
                        }
                        listing_members=subs0;
                        request.setAttribute("listing_members", subs0);
                    }
                     
                    System.out.println("listing_members "+ listing_members);  
                    
                    String listing_priorities= "";
                    if (request.getParameter("listing_priorities")==null){
                                if (thisForm.getpriorities().length >1){
                                    for (int i=0; i<thisForm.getpriorities().length; i++){
                                        if (i != thisForm.getpriorities().length-1){
                                            listing_priorities=listing_priorities + thisForm.getpriorities()[i]+",";
                                        }else{
                                            listing_priorities=listing_priorities+thisForm.getpriorities()[i];
                                        }
                                    }
                                }else{
                                     listing_priorities=thisForm.getpriorities()[0];
                                }
                        request.setAttribute("listing_priorities", listing_priorities);
                        request.setAttribute("list_priorities", convertToString(thisForm.getpriorities()));
                    }else{
                        subs1= request.getParameter("listing_priorities");
                        if(subs1.contains(",")){
                        //    request.setAttribute("listing_priorities", convertToString(subs1.split(",")));
                             thisForm.setpriorities(subs1.split(","));
                        }else{
                            str1[0]= subs1;
                        //    request.setAttribute("listing_priorities", str1);
                             thisForm.setpriorities(str1);
                        }
                        listing_priorities=subs1;
                        request.setAttribute("listing_priorities", subs1);
                    }
                    System.out.println("listing_priorities "+ listing_priorities);                     
                             
                    String listing_status= "";  
                    if (request.getParameter("listing_status")==null){
                                if (thisForm.getstatus().length >1){
                                    for (int i=0; i<thisForm.getstatus().length; i++){
                                        if (i != thisForm.getstatus().length-1){
                                            listing_status=listing_status + thisForm.getstatus()[i]+",";
                                        }else{
                                            listing_status=listing_status+thisForm.getstatus()[i];
                                        }
                                    }
                                }else{
                                     listing_status=thisForm.getstatus()[0];
                                }
                        request.setAttribute("listing_status", listing_status);
                        request.setAttribute("list_status", convertToString(thisForm.getstatus()));
                    }else{
                        subs2= request.getParameter("listing_status");
                        if(subs2.contains(",")){
                          //  request.setAttribute("listing_status", convertToString(subs0.split(",")));
                             thisForm.setstatus(subs2.split(","));
                        }else{
                            str2[0]= subs2;
                          //  request.setAttribute("listing_status", str0);
                             thisForm.setmembers(str2);
                        }
                        listing_status=subs2;
                        request.setAttribute("listing_status", subs2);
                    }         
                                        
                    System.out.println("listing_status "+ listing_status); 
                    
                                        String listing_typetasks= "";  
                                        
                    if (request.getParameter("listing_typetasks")==null){
                                if (thisForm.gettypetasks().length >1){
                                    for (int i=0; i<thisForm.gettypetasks().length; i++){
                                        if (i != thisForm.gettypetasks().length-1){
                                            listing_typetasks=listing_typetasks + thisForm.gettypetasks()[i]+",";
                                        }else{
                                            listing_typetasks=listing_typetasks+thisForm.gettypetasks()[i];
                                        }
                                    }
                                }else{
                                     listing_typetasks=thisForm.gettypetasks()[0];
                                }
                        request.setAttribute("listing_typetasks", listing_typetasks);
                        request.setAttribute("list_typetasks", convertToString(thisForm.gettypetasks()));
                    }else{
                        subs3= request.getParameter("listing_typetasks");
                        if(subs3.contains(",")){
                      //      request.setAttribute("listing_typetasks", convertToString(subs0.split(",")));
                             thisForm.settypetasks(subs3.split(","));
                        }else{
                            str3[0]= subs3;
                       //     request.setAttribute("listing_typetasks", str0);
                             thisForm.settypetasks(str3);
                        }
                        listing_typetasks=subs3;
                        request.setAttribute("listing_typetasks",subs3);
                    }         
                                        
                    System.out.println("listing_typetasks "+ listing_typetasks); 
                                        
                    request.setAttribute("query", thisForm.getQuery());
                
                     if (request.getParameter("tipoReporte").equals("day")){
                        thisForm.setsortColumn("day");
                     }
                  
                    request.setAttribute("pages", ""+thisForm.getPages());
                    request.setAttribute("tipoReporte", request.getParameter("tipoReporte"));
                    
                    request.setAttribute("tareaCobrable", request.getParameter("tareaCobrable"));
                    request.setAttribute("tickStatus", request.getParameter("tickStatus"));
                    request.setAttribute("projStatus", request.getParameter("projStatus"));
                    
                    Iterator e = broker.getReportByTasks2(thisForm.getprojects(), listing_members.split(","),
                            thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(),
                            request.getParameter("FechaInicio"),
                            request.getParameter("startDate1"), request.getParameter("startDate2"),
                            thisForm.getsortColumn(), "ASC",
                            thisForm.getQuery(), user.getId_account(), thisForm.getPages(), thisForm.getTareaCobrable());
                    
                    
                    Iterator e2 = broker.getReportByTasksWithhoutPaging(thisForm.getprojects(), listing_members.split(","),
                            thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(),
                            request.getParameter("FechaInicio"),
                            request.getParameter("startDate1"), request.getParameter("startDate2"),
                            thisForm.getsortColumn(), "ASC",
                            thisForm.getQuery(), user.getId_account(), thisForm.getTareaCobrable());
                       
                                
                   
                                        
                    boolean bandAll = false;

                    if (!"ALL".equalsIgnoreCase(request.getParameter("FechaInicio"))) {
                        bandAll = true;
                    }
                    String fechaI =  request.getParameter("startDate1");
                    String fechaF =  request.getParameter("startDate2");

                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();
                    ArrayList listaSchedule = new ArrayList();
                    ArrayList listaExcel = new ArrayList();
                    ArrayList repetidos = new ArrayList();
                    schedulesData scheduleData;

                    tasksData data;

                    BigDecimal totGenHour = new BigDecimal("0");
                    BigDecimal totGenMin = new BigDecimal("0");
                    BigDecimal totHour = new BigDecimal("0");
                    BigDecimal totMin = new BigDecimal("0");
                    
                    BigDecimal totGenHourEx = new BigDecimal("0");
                    BigDecimal totGenMinEx = new BigDecimal("0");
                    BigDecimal totHourEx = new BigDecimal("0");
                    BigDecimal totMinEx = new BigDecimal("0");

                            int cc=0;
                            while(e2.hasNext()){
                        scheduleData = new schedulesData();
                        scheduleData.setparentTask(new tasksData());
                        data = new tasksData();
                        scheduleData = (schedulesData) e2.next();
                        data = (tasksData) scheduleData.getparentTask();
                        
                        
                        if (!repetidos.contains(String.valueOf(scheduleData.getdate()))) {
                            
                            if (repetidos.size() > 0) {
                                if (totMinEx.toString().length() == 1) {
                                       Collections.sort(lista, new Comparator() {
                                        public int compare(Object o1, Object o2) {
                                              schedulesData sd2 = (schedulesData)o1;
                                              schedulesData sd1 = (schedulesData)o2;
                                              return sd2.getStartDate().compareTo(sd1.getStartDate());

                                        }
                                    }); 
                                    
                                    listaExcel.add(new reportTasksData(lista, totHourEx + ":0" + totMinEx));
                                } else {
                                    Collections.sort(lista, new Comparator() {
                                        public int compare(Object o1, Object o2) {
                                              schedulesData sd2 = (schedulesData)o1;
                                              schedulesData sd1 = (schedulesData)o2;
                                              return sd2.getStartDate().compareTo(sd1.getStartDate());

                                        }
                                    }); 
                                    listaExcel.add(new reportTasksData(lista, totHourEx + ":" + totMinEx));
                                    
                                }
                                lista = new ArrayList();
                                repetidos = new ArrayList();
                            }
                            scheduleBroker = new schedulesBroker();
                                totHourEx = scheduleBroker.getTotalTaskRealHoursByDay(scheduleData.getId_account(), scheduleData.getdate(), thisForm.getmembers(), 
                                        thisForm.getprojects(), thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(), thisForm.getQuery(), thisForm.getTareaCobrable());
                                totMinEx = scheduleBroker.getTotalTaskRealMinutesByDay(scheduleData.getId_account(), scheduleData.getdate(), thisForm.getmembers(), 
                                        thisForm.getprojects(), thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(), thisForm.getQuery(), thisForm.getTareaCobrable());

                            scheduleBroker.close();
                            totGenHourEx = totGenHourEx.add(totHourEx);
                            totGenMinEx = totGenMinEx.add(totMinEx);
                            boolean band = false;
                            String[] split_min = null;
                            String replace_min = "";
                            while (!band) {
                                if (totMinEx.compareTo(new BigDecimal("59")) == 1) {
                                    totMinEx = totMinEx.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                                    replace_min = totMinEx.toString().replace('.', ',');
                                    split_min = replace_min.split(",");
                                    totHourEx = totHourEx.add(new BigDecimal(split_min[0]));
                                    totMinEx = new BigDecimal("0." + split_min[1]);
                                    totMinEx = totMinEx.multiply(new BigDecimal("60"));
                                    if (totMinEx.toString().replace('.', ',').split(",").length > 1) {
                                        replace_min = totMinEx.toString().replace('.', ',');
                                        split_min = replace_min.split(",");
                                        totMinEx = new BigDecimal(split_min[0]);
                                    }
                                } else {
                                    band = true;
                                }
                            }

                            data.setTotalScheduledHours(new BigDecimal(totHourEx + "." + totMinEx));
                            repetidos.add(String.valueOf(scheduleData.getdate()));
                            scheduleData.setparentTask(data);
                        }

                        lista.add(scheduleData);

                                cc++;
                            }
                            
                    if (repetidos.size() == 1) {
                        if (totMinEx.toString().length() == 1) {
                            listaExcel.add(new reportTasksData(lista, totHourEx + ":0" + totMinEx));
                        } else {
                            listaExcel.add(new reportTasksData(lista, totHourEx + ":" + totMinEx));
                        }
                    }
                            
                    
                            
                            
                            
                            
                    
                    boolean band = false;
                    String[] split_min = null;
                    String replace_min = "";
                    while (!band) {
                        if (totGenMinEx.compareTo(new BigDecimal("59")) == 1) {
                            totGenMinEx = totGenMinEx.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                            replace_min = totGenMinEx.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            totGenHourEx = totGenHourEx.add(new BigDecimal(split_min[0]));
                            totGenMinEx = new BigDecimal("0." + split_min[1]);
                            totGenMinEx = totGenMinEx.multiply(new BigDecimal("60"));
                            if (totGenMinEx.toString().replace('.', ',').split(",").length > 1) {
                                replace_min = totGenMinEx.toString().replace('.', ',');
                                split_min = replace_min.split(",");
                                totGenMinEx = new BigDecimal(split_min[0]);
                            }
                        } else {
                            band = true;
                        }
                    }        
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            lista= new ArrayList();
                            repetidos = new ArrayList();
                    if (request.getParameter("tipoReporte").equals("day"))
                    {
                        while (e.hasNext()) {
                        scheduleData = new schedulesData();
                        scheduleData.setparentTask(new tasksData());
                        data = new tasksData();
                        scheduleData = (schedulesData) e.next();
                        data = (tasksData) scheduleData.getparentTask();
                        
                        
                        if (!repetidos.contains(String.valueOf(scheduleData.getdate()))) {
                            
                            if (repetidos.size() > 0) {
                                if (totMin.toString().length() == 1) {
                                       Collections.sort(lista, new Comparator() {
                                        public int compare(Object o1, Object o2) {
                                              schedulesData sd2 = (schedulesData)o1;
                                              schedulesData sd1 = (schedulesData)o2;
                                              return sd2.getStartDate().compareTo(sd1.getStartDate());

                                        }
                                    }); 
                                    
                                    listaSchedule.add(new reportTasksData(lista, totHour + ":0" + totMin));
                                } else {
                                    Collections.sort(lista, new Comparator() {
                                        public int compare(Object o1, Object o2) {
                                              schedulesData sd2 = (schedulesData)o1;
                                              schedulesData sd1 = (schedulesData)o2;
                                              return sd2.getStartDate().compareTo(sd1.getStartDate());

                                        }
                                    }); 
                                    listaSchedule.add(new reportTasksData(lista, totHour + ":" + totMin));
                                    
                                }
                                lista = new ArrayList();
                                repetidos = new ArrayList();
                            }
                            scheduleBroker = new schedulesBroker();
                                totHour = scheduleBroker.getTotalTaskRealHoursByDay(scheduleData.getId_account(), scheduleData.getdate(), thisForm.getmembers(), 
                                        thisForm.getprojects(), thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(), thisForm.getQuery(), thisForm.getTareaCobrable());
                                totMin = scheduleBroker.getTotalTaskRealMinutesByDay(scheduleData.getId_account(), scheduleData.getdate(), thisForm.getmembers(), 
                                        thisForm.getprojects(), thisForm.getpriorities(), listing_status.split(","), thisForm.gettypetasks(), thisForm.getQuery(), thisForm.getTareaCobrable());

                            scheduleBroker.close();
                            totGenHour = totGenHour.add(totHour);
                            totGenMin = totGenMin.add(totMin);
                            band = false;
                            split_min = null;
                            replace_min = "";
                            while (!band) {
                                if (totMin.compareTo(new BigDecimal("59")) == 1) {
                                    totMin = totMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                                    replace_min = totMin.toString().replace('.', ',');
                                    split_min = replace_min.split(",");
                                    totHour = totHour.add(new BigDecimal(split_min[0]));
                                    totMin = new BigDecimal("0." + split_min[1]);
                                    totMin = totMin.multiply(new BigDecimal("60"));
                                    if (totMin.toString().replace('.', ',').split(",").length > 1) {
                                        replace_min = totMin.toString().replace('.', ',');
                                        split_min = replace_min.split(",");
                                        totMin = new BigDecimal(split_min[0]);
                                    }
                                } else {
                                    band = true;
                                }
                            }

                            data.setTotalScheduledHours(new BigDecimal(totHour + "." + totMin));
                            repetidos.add(String.valueOf(scheduleData.getdate()));
                            scheduleData.setparentTask(data);
                        }
                        lista.add(scheduleData);
                    }
                    }else{
                    while (e.hasNext()) {
                        scheduleData = new schedulesData();
                        scheduleData.setparentTask(new tasksData());
                        data = new tasksData();
                        scheduleData = (schedulesData) e.next();
                        data = (tasksData) scheduleData.getparentTask();
                        if (!repetidos.contains(new Integer(data.getid()))) {
                            if (repetidos.size() > 0) {
                                if (totMin.toString().length() == 1) {
                                    listaSchedule.add(new reportTasksData(lista, totHour + ":0" + totMin));
                                } else {
                                    listaSchedule.add(new reportTasksData(lista, totHour + ":" + totMin));
                                }
                                lista = new ArrayList();
                                repetidos = new ArrayList();
                            }
                            scheduleBroker = new schedulesBroker();
                            if (bandAll) {

                                totHour = scheduleBroker.getTotalTaskRealHoursbyDate(data.getid(), fechaI,fechaF, scheduleData.getId_account());
                                totMin = scheduleBroker.getTotalTaskRealMinutesbyDate(data.getid(), fechaI,fechaF, scheduleData.getId_account());
                            } else {
                                totHour = scheduleBroker.getTotalTaskRealHours(data.getid(), scheduleData.getId_account());
                                totMin = scheduleBroker.getTotalTaskRealMinutes(data.getid(), scheduleData.getId_account());
                            }
                            scheduleBroker.close();
                            totGenHour = totGenHour.add(totHour);
                            totGenMin = totGenMin.add(totMin);
                            band = false;
                            split_min = null;
                            replace_min = "";
                            while (!band) {
                                if (totMin.compareTo(new BigDecimal("59")) == 1) {
                                    totMin = totMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                                    replace_min = totMin.toString().replace('.', ',');
                                    split_min = replace_min.split(",");
                                    totHour = totHour.add(new BigDecimal(split_min[0]));
                                    totMin = new BigDecimal("0." + split_min[1]);
                                    totMin = totMin.multiply(new BigDecimal("60"));
                                    if (totMin.toString().replace('.', ',').split(",").length > 1) {
                                        replace_min = totMin.toString().replace('.', ',');
                                        split_min = replace_min.split(",");
                                        totMin = new BigDecimal(split_min[0]);
                                    }
                                } else {
                                    band = true;
                                }
                            }

                            data.setTotalScheduledHours(new BigDecimal(totHour + "." + totMin));
                            repetidos.add(new Integer(data.getid()));
                            scheduleData.setparentTask(data);
                        }

                        lista.add(scheduleData);
                    }
                    }
                    if (repetidos.size() == 1) {
                        if (totMin.toString().length() == 1) {
                            listaSchedule.add(new reportTasksData(lista, totHour + ":0" + totMin));
                        } else {
                            listaSchedule.add(new reportTasksData(lista, totHour + ":" + totMin));
                        }
                    }
                    
                    

                    // Se regresa al contexto la lista de todas las tareas que satisfacen
                    // la consulta estipulada.
                    request.setAttribute("list_report", listaSchedule);
                    
                    
                     band = false;
                    split_min = null;
                    replace_min = "";
                    while (!band) {
                        if (totGenMin.compareTo(new BigDecimal("59")) == 1) {
                            totGenMin = totGenMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                            replace_min = totGenMin.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            totGenHour = totGenHour.add(new BigDecimal(split_min[0]));
                            totGenMin = new BigDecimal("0." + split_min[1]);
                            totGenMin = totGenMin.multiply(new BigDecimal("60"));
                            if (totGenMin.toString().replace('.', ',').split(",").length > 1) {
                                replace_min = totGenMin.toString().replace('.', ',');
                                split_min = replace_min.split(",");
                                totGenMin = new BigDecimal(split_min[0]);
                            }
                        } else {
                            band = true;
                        }
                    }
                    if (totGenMin.toString().length() == 1) {
                        request.setAttribute("total", totGenHour + ":0" + totGenMin);
                    } else {
                        request.setAttribute("total", totGenHour + ":" + totGenMin);
                    }

                    // Y el resto de parametros del reporte
                    request.setAttribute("FechaInicio", request.getParameter("FechaInicio"));
                    request.setAttribute("startDate1", request.getParameter("startDate1"));
                    request.setAttribute("startDate2", request.getParameter("startDate2"));
                    request.setAttribute("FechaEntrega", request.getParameter("FechaEntrega"));
                    request.setAttribute("FechaFinal", request.getParameter("FechaFinal"));
                    request.setAttribute("endDate1", request.getParameter("endDate1"));
                    request.setAttribute("endDate2", request.getParameter("endDate2"));

                    if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                        // Negamos el tipo de ordenamiento
                        if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                            thisForm.setsortOrder("DESC");
                        } else {
                            thisForm.setsortOrder("ASC");
                        }
                    }
                    
                    
                    System.out.println("AQ " + totGenHour + ":0" + totGenMin);
                      System.out.println("TOTAL#  "+ totGenHour + ":0" + totGenMin);
         setPages(cc, request, "listPagesFiles");
                    request.setAttribute("totalReg", ""+cc);
                    
//                    getTotals(broker,thisForm, request, response, user, bandAll, fechaI, fechaF,company );
////                        if(totGenMin.intValue()%60!=0){
////                            totGenHour.add(BigDecimal.valueOf(Double.parseDouble((String.valueOf(totGenMin.intValue()/60)))));
////                            totGenMin= totGenMin.ZERO;
////                        }
//                    if (totGenMin.toString().length() == 1) {
//                        request.setAttribute("total", totGenHour + ":0" + totGenMin);
//                    } else {
//                        request.setAttribute("total", totGenHour + ":" + totGenMin);
//                    }
//                    //Generamos el archivo Excel
//                     String param= String.valueOf(request.getParameter("excel"));
//                           if (param.equals("1") && request.getParameter("tipoReporte").equals("day"))
//                        {
//                               String realHours= "";
//                            if (totGenMin.toString().length() == 1) {
//                                realHours=totGenHour + ":0" + totGenMin;
//                            } else {
//                                realHours=totGenHour + ":" + totGenMin;
//                            }
//                            HSSFWorkbook wb = (HSSFWorkbook) excelFile.excelFileInformeDetalladoDeTareasporDia(company, fechaI, fechaF, listaSchedule,user.getlanguage(), 
//                                    realHours, request.getParameter("FechaInicio"));
//                         
//                            response.setContentType("application/x-download");
//                            response.setHeader("Content-Disposition", "attachment; filename=InformeDetalladoDeTareas.xls");
//                            
//                            try {
//                                OutputStream out = response.getOutputStream();
//                                // write the workbook to the output stream,
//                                // remembering to close our file
//                                wb.write(out);
//                                out.flush();
//                                out.close();
//                            } catch (IOException ex) {
//                                ex.printStackTrace();
//                            }
//                        }
                    
                           //Generamos el archivo Excel
                     String param= String.valueOf(request.getParameter("excel"));
                           if (param.equals("1") && request.getParameter("tipoReporte").equals("day"))
                        {
                               String realHours= "";
                            if (totGenMinEx.toString().length() == 1) {
                                realHours=totGenHourEx + ":0" + totGenMinEx;
                            } else {
                                realHours=totGenHourEx + ":" + totGenMinEx;
                            }
                            HSSFWorkbook wb = (HSSFWorkbook) excelFile.excelFileInformeDetalladoDeTareasporDia(company, fechaI, fechaF, listaExcel,user.getlanguage(), 
                                    realHours, request.getParameter("FechaInicio"));
                         
                            response.setContentType("application/x-download");
                            response.setHeader("Content-Disposition", "attachment; filename=InformeDetalladoDeTareas.xls");
                            
                            try {
                                OutputStream out = response.getOutputStream();
                                // write the workbook to the output stream,
                                // remembering to close our file
                                wb.write(out);
                                out.flush();
                                out.close();
                            } catch (IOException ex) {
                                ex.printStackTrace();
                            }
                        }
                    
                    
                    request.setAttribute("company", company);
                    // forward to display the list
                        return (mapping.findForward("viewReportTask"));


                } else if (action != null && (action.equals("executeQuery1")|| action.equals("executeQuery2")))
                {
                    ArrayList tasksList= new ArrayList();
                    ArrayList schList= new ArrayList();
                    ArrayList projectsList= new ArrayList();
                    ArrayList costsList= new ArrayList();
                    Iterator it =null;
                    
                                projectsBroker pBroker= new projectsBroker();
                    if (action.equals("executeQuery1")){
                            //it = broker.getReportByTask3(thisForm.getprojects(), thisForm.getmembers(),thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),request.getParameter("FechaInicio")
                            //,request.getParameter("startDate1"), request.getParameter("startDate2") ,thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), user.getId_account(), thisForm.getCostoCobrable());
                            //,request.getParameter("startDate1"), request.getParameter("startDate2") ,thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), user.getId_account(), thisForm.getCostoCobrable());
                        projectsList= broker.getProjectReporteGastos(thisForm.getprojects(), thisForm.getmembers(),thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),request.getParameter("FechaInicio")
                            ,request.getParameter("startDate1"), request.getParameter("startDate2") ,thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), user.getId_account(), thisForm.getCostoCobrable());
                       
                            /*while (it.hasNext()){
                                tasksData tData= (tasksData)it.next();

                                projectsData pData= (projectsData)pBroker.getData(tData.getproject());
                                 if (!containsElement(projectsList,pData.getname())){projectsList.add(pData);}

                                tasksList.add(tData);

                                if (!it.hasNext()){pBroker.close();}
                            }*/
                    }else
                    {
                        //        tasksBroker tskBroker= new tasksBroker();
                            //    projectsBroker pBroker= new projectsBroker();
                        System.out.println("aqui1");
                        //it = broker.getMasterReportByTasks2(thisForm.getprojects(), thisForm.getmembers(), thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(), request.getParameter("FechaInicio"),request.getParameter("startDate1"), request.getParameter("startDate2"), thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), user.getId_account());
                        projectsList= broker.getProjectReportInformeCostos(thisForm.getprojects(), thisForm.getmembers(), thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(), request.getParameter("FechaInicio"),request.getParameter("startDate1"), request.getParameter("startDate2"), thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), user.getId_account());
                       
                        /*for (int i=0; i< it2.size(); i++){
                            projData= new projectsData();
                            projData=(projectsData)it2.get(i);
                            listAll.add(broker.getProjectReportInformeCostos(projData.getId_account(), projData.getid()));
                        }   */
                        /*while (it2.hasNext()){
                            counter= counter+1;
                            System.out.println("CONT: "+counter);
                                schedulesData schData= (schedulesData)it.next();
                                  tasksData tskData= (tasksData)tskBroker.getData(schData.gettaskid());
                                
                                projectsData pData= (projectsData)pBroker.getData(tskData.getproject());
                                if (!containsElement(projectsList,pData.getname())){projectsList.add(pData);}
                                schList.add(schData);
                                if (!it.hasNext()){pBroker.close(); tskBroker.close();}
                            }
                    
                    */
                    }
                    HSSFWorkbook wb = null;
                    if (action.equals("executeQuery1")){
                        
                        Iterator it1 = broker.getReportCosts(thisForm.getsortColumn(), thisForm.getsortOrder(),
                        user.getId_account(), thisForm.getCostoCobrable());

                        while (it1.hasNext()){
                            costsData cData= (costsData)it1.next();
                            System.out.println(cData.getDescription());
                      
                            costsList.add(cData);
                        }
                        wb = (HSSFWorkbook) excelFile.excelFileReporteGastos(company, request.getParameter("startDate1"),
                        request.getParameter("startDate2"),tasksList, projectsList, costsList, user.getlanguage(),request.getParameter("FechaInicio"),
                        thisForm.getmembers(), thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),request.getParameter("FechaInicio"), thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery(), thisForm.getCostoCobrable());
                        response.setContentType("application/x-download");
                        response.setHeader("Content-Disposition", "attachment; filename=InformeGastos.xls");
                    }else{
                        System.out.println("aqui4");  
                        wb = (HSSFWorkbook) excelFile.excelFileInformeTiempoConsolidado(company, request.getParameter("startDate1"),
                        request.getParameter("startDate2"), projectsList, user.getlanguage(),request.getParameter("FechaInicio"),
                        thisForm.getmembers(), thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(), request.getParameter("FechaInicio"), thisForm.getsortColumn(), thisForm.getsortOrder(),thisForm.getQuery());
                        //,schList, projectsList, user.getlanguage(),request.getParameter("FechaInicio"));
                        response.setContentType("application/x-download");
                        response.setHeader("Content-Disposition", "attachment; filename=InformeTiempoConsolidado.xls");
                    }
                    try {
                        OutputStream out = response.getOutputStream();
                        // write the workbook to the output stream,
                        // remembering to close our file
                        wb.write(out);
                        out.flush();
                        out.close();
                    } catch (IOException ex) {
                        ex.printStackTrace();
                    broker.close();
                    }
                    broker.close();
                }else {


                    request.setAttribute("menuRoute",
                            "<a href='./reports.do'>" +
                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.reports") +
                            "</a>");


                    broker.close();

                    request.setAttribute("company", company);
                    // Se redirecciona a la pagina de administracion
                    return (mapping.findForward("main"));

                }
            } catch (Exception e) {
                servlet.log("[ERROR] Action at final catch: " + e.getMessage());
                logger.logp(Level.SEVERE, "reports.do", "perform",
                        "Fatal Error: " + e.toString());
                e.printStackTrace();

            } finally {
                broker.close();
                brokerOrg.close();
                brokerProjects.close();
                brokerMembers.close();
                brokerTaskType.close();
                brokerTopics.close();

            }
        }
        request.setAttribute("company", company);
        // Default if everthing else fails
        return (mapping.findForward("listing"));
    }

    // Retorna la lista de organizaciones
    private ArrayList getListing(MainBroker myBroker, String sortCol, String sortOrder, int accountId) {
        // Se obtiene el iterador sobre todos los elementos de la lista.
        Iterator e = myBroker.getList(sortCol, sortOrder, accountId);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        return lista;
    }

    /* M?todo que convierte un String[] a un String separado por comas */
    private String convertToString(String[] lista) {
        StringBuffer salida = new StringBuffer();
        for (int i = 0; i < lista.length; i++) {
            salida.append(lista[i] + ",");
        }
        return salida.toString();
    }
    
    public boolean containsElement(ArrayList list, String name)
    {
        boolean flag=false;
        Iterator e= list.iterator();
        
        projectsData projData= new projectsData();
        projectsBroker pBroker= new projectsBroker();
        while(e.hasNext())
        {
            projData=(projectsData) e.next();
            if(projData.getname().equals(name)){
                flag=true;
            }
        }
        
        
        return flag;
    }
    
    
//    // Metodo que se encarga de ordernar los files dispuestos.
//    private void sortFiles(HttpServletRequest request, tasksForm thisForm, reportsBroker reportsBroker, int accountId) {
//        // Traer los valores para desplegar la lista de files disponibles.
//        // Constituye un listado completo y para ello nos valemos del broker.                                              
//        // Y por ultimo lo agregramos al contexto
//        int currentPage = thisForm.getpageFiles();
//
//        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1     
//        if (thisForm.getsource().equalsIgnoreCase("files")) {
//            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
//                // Es un sort. Siempre se pasa a la pagina 1
//                currentPage = 1;
//                thisForm.setpageFiles(1);
//            }
//
//        }
//
//        Iterator e = reportsBroker.getList(thisForm.getsortColumnFiles(),
//                thisForm.getsortOrderFiles(),
//                thisForm.getid(),
//                currentPage, accountId);
//
//        // Debemos convertir el iterador en un arraylist.
//        ArrayList lista = new ArrayList();
//        while (e.hasNext()) {
//            lista.add(e.next());
//        }
//// Se guarda la lista de files asociados a esta tarea.
//        request.setAttribute("listFiles", lista);
//
//        // Se setea el total de paginas
//        setPages(fileBroker, request, "listPagesFiles");
//
//        if (thisForm.getsource().equalsIgnoreCase("files") &&
//                thisForm.getOperation().equalsIgnoreCase("sort")) {
//            // Negamos el tipo de ordenamiento
//            if (thisForm.getsortOrderFiles().equalsIgnoreCase("ASC")) {
//                thisForm.setsortOrderFiles("DESC");
//            } else {
//                thisForm.setsortOrderFiles("ASC");
//            }
//
//        }
//
//    }

        // Metodo que se encarga de dejar en el context una lista de todas las paginas
    // necesarias para dar cabida a los datos del ultimo comando de sql ejecutado.
    private void setPages(int max, HttpServletRequest request,
            String listName) {
        // Se guarda el total de pginas en el contexto.
        ArrayList listaPages = new ArrayList();

        // Se obtiene el total de registros reales de la ultima consulta.

int totalPage =1;

        if (max>450 ) {
            totalPage= max/450;
            totalPage+=1;
        }

        for (int i = 1; i <= totalPage; i++) {
            listaPages.add(new Integer(i));
        }
        request.setAttribute(listName, listaPages);
    }
    
    public void getTotals(reportsBroker broker, reportsForm thisForm, HttpServletRequest request,
            HttpServletResponse response,loginData user, boolean bandAll, String fechaI, String fechaF, String company ){
        
        int count=0;
        schedulesBroker scheduleBroker = new schedulesBroker();
        schedulesData scheduleData= new schedulesData();
        tasksData data = new tasksData();
                    BigDecimal totGenHour = new BigDecimal("0");
                    BigDecimal totGenMin = new BigDecimal("0");
                    BigDecimal totHour = new BigDecimal("0");
                    BigDecimal totMin = new BigDecimal("0");
                    
        ArrayList repetidos= new ArrayList();
        ArrayList listaSchedule= new ArrayList();
        ArrayList lista= new ArrayList();
           
        
         Iterator e2 = broker.getReportByTasks2(thisForm.getprojects(), thisForm.getmembers(),
            thisForm.getpriorities(), thisForm.getstatus(), thisForm.gettypetasks(),
            request.getParameter("FechaInicio"),
            request.getParameter("startDate1"), request.getParameter("startDate2"),
            thisForm.getsortColumn(), "ASC",
            thisForm.getQuery(), user.getId_account(), thisForm.getPages(),thisForm.getTareaCobrable());
         
            while (e2.hasNext()) {
                count++;
//                        scheduleData = new schedulesData();
//                        scheduleData.setparentTask(new tasksData());
//                        data = new tasksData();
//                        scheduleData = (schedulesData) e2.next();
//                        data = (tasksData) scheduleData.getparentTask();
//                        if (!repetidos.contains(new Integer(data.getid()))) {
//                            if (repetidos.size() > 0) {
//                                if (totMin.toString().length() == 1) {
//                                    listaSchedule.add(new reportTasksData(lista, totHour + ":0" + totMin));
//                                } else {
//                                    listaSchedule.add(new reportTasksData(lista, totHour + ":" + totMin));
//                                }
//                                lista = new ArrayList();
//                                repetidos = new ArrayList();
//                            }
//                            scheduleBroker = new schedulesBroker();
//                            if (bandAll) {
//
//                                totHour = scheduleBroker.getTotalTaskRealHoursbyDate(data.getid(), fechaI,fechaF, scheduleData.getId_account());
//                                totMin = scheduleBroker.getTotalTaskRealMinutesbyDate(data.getid(), fechaI,fechaF, scheduleData.getId_account());
//                            } else {
//                                totHour = scheduleBroker.getTotalTaskRealHours(data.getid(), scheduleData.getId_account());
//                                totMin = scheduleBroker.getTotalTaskRealMinutes(data.getid(), scheduleData.getId_account());
//                            }
//                            scheduleBroker.close();
//                            totGenHour = totGenHour.add(totHour);
//                            totGenMin = totGenMin.add(totMin);
//                            boolean band = false;
//                            String[] split_min = null;
//                            String replace_min = "";
//                            while (!band) {
//                                if (totMin.compareTo(new BigDecimal("59")) == 1) {
//                                    totMin = totMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
//                                    replace_min = totMin.toString().replace('.', ',');
//                                    split_min = replace_min.split(",");
//                                    totHour = totHour.add(new BigDecimal(split_min[0]));
//                                    totMin = new BigDecimal("0." + split_min[1]);
//                                    totMin = totMin.multiply(new BigDecimal("60"));
//                                    if (totMin.toString().replace('.', ',').split(",").length > 1) {
//                                        replace_min = totMin.toString().replace('.', ',');
//                                        split_min = replace_min.split(",");
//                                        totMin = new BigDecimal(split_min[0]);
//                                    }
//                                } else {
//                                    band = true;
//                                }
//                            }
//
//                            data.setTotalScheduledHours(new BigDecimal(totHour + "." + totMin));
//                            repetidos.add(new Integer(data.getid()));
//                            scheduleData.setparentTask(data);
//                        }
//
//                        lista.add(scheduleData);
//                    }
//         
//         boolean band = false;
//                    String[] split_min = null;
//                    String replace_min = "";
//                    while (!band) {
//                        if (totGenMin.compareTo(new BigDecimal("59")) == 1) {
//                            totGenMin = totGenMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
//                            replace_min = totGenMin.toString().replace('.', ',');
//                            split_min = replace_min.split(",");
//                            totGenHour = totGenHour.add(new BigDecimal(split_min[0]));
//                            totGenMin = new BigDecimal("0." + split_min[1]);
//                            totGenMin = totGenMin.multiply(new BigDecimal("60"));
//                            if (totGenMin.toString().replace('.', ',').split(",").length > 1) {
//                                replace_min = totGenMin.toString().replace('.', ',');
//                                split_min = replace_min.split(",");
//                                totGenMin = new BigDecimal(split_min[0]);
//                            }
//                        } else {
//                            band = true;
//                        }
                e2.next();
                    }
//                    if (totGenMin.toString().length() == 1) {
//                        request.setAttribute("total", totGenHour + ":0" + totGenMin);
//                    } else {
//                        request.setAttribute("total", totGenHour + ":" + totGenMin);
//                    }
                    System.out.println("TOTAL#  "+ totGenHour + ":0" + totGenMin);
         setPages(count, request, "listPagesFiles");
                    request.setAttribute("totalReg", ""+count);
                    
 
    }
    

}
