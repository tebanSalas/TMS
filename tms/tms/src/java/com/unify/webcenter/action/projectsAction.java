/*
 * Generated by Flecha Roja Technologies Auto Generator
 *
 * 
 * Created on January 9, 2003, 11:31 AM
 */
package com.unify.webcenter.action;

import java.io.IOException;
import java.util.*;
import java.util.logging.*;

import java.math.BigDecimal;
import java.text.*;

import javax.servlet.*;
import javax.servlet.http.*;

import org.apache.struts.action.*;
import org.apache.commons.beanutils.*;

import com.unify.webcenter.data.*;
import com.unify.webcenter.broker.*;
import com.unify.webcenter.form.*;
import com.unify.webcenter.charts.*;
import com.unify.webcenter.conf.TMSConfigurator;
import com.unify.webcenter.tools.StringManipulator;
import com.unify.webcenter.tools.excelFile;
import java.sql.Timestamp;
import java.util.ArrayList;
import org.apache.struts.upload.FormFile;

/**
 * <p>This action works with both JSP and Velocity templates.
 * The type of template to be used is defined in the Struts configuration
 * file.</p>
 *
 * <p>The action support an <i>action</i> URL parameter. This URL parameter
 * controls what this action class does. The following values are supported:</p>
 * <ul>
 *   <li>save    Save the record
 *   <li>delete	 Delete the record
 *   <li>edit    Edit the record
 *   <li>show	 Show the record
 * </ul>
 *
 *
 * @author Administrator
 */
public class projectsAction extends Action {

    private static Logger logger = Logger.getLogger("com.unify");

    /** Creates a new instance of calendarAction */
    public projectsAction() {

    }

    /**
     * Handle server requests.
     *
     * @param mapping The ActionMapping used to select this instance
     * @param actionForm The optional ActionForm bean for this request (if any)
     * @param request The HTTP request we are processing
     * @param response The HTTP response we are creating
     *
     * @exception IOException if an input/output error occurs
     * @exception ServletException if a servlet exception occurs
     */
    public ActionForward execute(ActionMapping mapping,
            ActionForm form,
            HttpServletRequest request,
            HttpServletResponse response)
            throws IOException, ServletException {
        String action;
        HttpSession session;
        projectsBroker projBroker;
        organizationsBroker orgBroker;
        membersBroker memBroker;
        tasksBroker brokerTasks;
        topicsBroker brokerTopics;
        teamsBroker brokerTeams;
        filesBroker fileBroker;
        costsBroker costBroker;
        risksBroker riskBroker;
        schedulesBroker brokerSchedule;
        tasksStatusLogBroker brokersl;
        assignmentsBroker assignBroker;
        type_tasksBroker typetasksBroker;
        String company = null;

        session = request.getSession(false);

        // Si la sesion es nula, se debe redireccionar al login.
        if (session == null || session.getAttribute("login") == null) {

            // forward to display the home page
            return (mapping.findForward("login"));
        } else {
            projBroker = new projectsBroker();
            orgBroker = new organizationsBroker();
            memBroker = new membersBroker();
            brokerTasks = new tasksBroker();
            brokerTopics = new topicsBroker();
            brokerTeams = new teamsBroker();
            fileBroker = new filesBroker();
            costBroker = new costsBroker();
            riskBroker = new risksBroker();
            brokerSchedule = new schedulesBroker();
            brokersl= new tasksStatusLogBroker();
            assignBroker = new assignmentsBroker();
            typetasksBroker = new type_tasksBroker();
            // Instanciar clase para el envio de correo
            com.unify.webcenter.tools.sendMail sm =
                    new com.unify.webcenter.tools.sendMail();
            try {

                if (form == null) {
                    System.out.println(" Creating new projectsForm bean under key " + mapping.getAttribute());
                    form = new projectsForm();

                }

                projectsForm thisForm = (projectsForm) form;

                // fetch action from formSystem.out.println("Action Project: "+action);

                action = ((projectsForm) form).getOperation();
                ActionErrors errors = new ActionErrors();

                servlet.log("[DEBUG] projectsAction at perform(): Action is " + action);

                // Se obtiene la referencia al loginData dentro de la session.
                loginData user = (loginData) session.getAttribute("login");
                TMSConfigurator tms = new TMSConfigurator(user);
                company = tms.getCompany(user);
                // Se agrega al contexto la informacion del usuario
                request.setAttribute("userInfo", user);

                // Determine what to do
                if (action.equals("add")) {
                    // En el caso de la operacion add, se despliega el formulario.
                    request.setAttribute("title",
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addProject"));
                    thisForm.setOperation("applyAdd");
                    thisForm.setid(0);
                    Calendar calendar = Calendar.getInstance();
                    thisForm.setcreated(new java.sql.Timestamp(calendar.getTimeInMillis()));
                    thisForm.setpublished("1");
                    thisForm.setowner(user.getid());
                    thisForm.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                    String auxmonth = "0" + (calendar.get(Calendar.MONTH) + 1);
                    String auxday = "0" + calendar.get(Calendar.DAY_OF_MONTH);

                    if (auxmonth.length() > 2) {
                        auxmonth = auxmonth.substring(1);
                    }
                    if (auxday.length() > 2) {
                        auxday = auxday.substring(1);
                    }

                    // Se extrae el componente dia, mes y a�o del start_date
                    request.setAttribute("fecha1", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);

                    // Se extrae el componente dia, mes y a�o del due_date
                    request.setAttribute("fecha2", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);

                    // Se deben cargar los listados de Organizaciones y Members para los
                    // combos correspondientes.
                    request.setAttribute("listOrganizations", getListing(orgBroker, "name", "ASC", user.getId_account()));

                    Iterator e = memBroker.getListofCompanyMembers("name", "ASC", 0, user.getId_account());

                    ArrayList listaMiembros = new ArrayList();
                    membersData memberData = new membersData();
                    while (e.hasNext()) {
                        memberData = (membersData) e.next();
                        memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));

                        listaMiembros.add(memberData);
                    }


                    request.setAttribute("listMembers", listaMiembros);
        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                typetasksBroker.close();
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addProject"));
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAddForm"));

                }
                if (action.equals("addsub")) {

                    if (request.getAttribute("proy") != null) {
                        thisForm.setProject(Integer.parseInt(request.getAttribute("proy").toString()));
                    }
                    // En el caso de la operacion add, se despliega el formulario.
                    request.setAttribute("title",
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addProject"));
                    thisForm.setOperation("applyAddSub");
                    thisForm.setid(0);
                    Calendar calendar = Calendar.getInstance();
                    thisForm.setcreated(new java.sql.Timestamp(calendar.getTimeInMillis()));
                    thisForm.setpublished("1");

                    thisForm.setProject_id(thisForm.getProject());
                    projectsData data = (projectsData) projBroker.getData(thisForm.getProject(), user.getId_account());
                    thisForm.setorganization(data.getorganization());
                    thisForm.setstatus(data.getstatus());

                    session.setAttribute("subproj", String.valueOf(thisForm.getProject()));
                    thisForm.setowner(user.getid());
                    thisForm.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    // thisForm.setstart_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    // thisForm.setend_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                    String auxmonth = "0" + (calendar.get(Calendar.MONTH) + 1);
                    String auxday = "0" + calendar.get(Calendar.DAY_OF_MONTH);

                    if (auxmonth.length() > 2) {
                        auxmonth = auxmonth.substring(1);
                    }
                    if (auxday.length() > 2) {
                        auxday = auxday.substring(1);
                    }

                    // Se extrae el componente dia, mes y a�o del start_date
                    request.setAttribute("fecha1", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);

                    // Se extrae el componente dia, mes y a�o del due_date
                    request.setAttribute("fecha2", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);

                    // Se deben cargar los listados de Organizaciones y Members para los
                    // combos correspondientes.
                    request.setAttribute("listOrganizations", getListing(orgBroker, "name", "ASC", user.getId_account()));

                    Iterator e = null;
                    // if (user.getprofile().equals("1")) {
                    //     System.out.println("Entro aca 1");
//                    e = brokerTeams.getListByProject("id", "ASC", thisForm.getProject(), 0, user.getId_account());

                    //} else {

                    /* if (user.getprofile().equals("3")) {
                    e = memBroker.getListofCompanyMembers("name", "ASC", 0, user.getId_account());
                    ArrayList listaMiembros = new ArrayList();
                    membersData memberData = new membersData();
                    while (e.hasNext()) {
                    memberData = (membersData) e.next();
                    memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));
                    listaMiembros.add(memberData);
                    }
                    request.setAttribute("listMembers", listaMiembros);
                    } else {*/
               
                    
                    if (user.getprofile().equals("0")) {
                        e = brokerTeams.getListByProjectMember("parentMember.name",
                                "ASC",
                                thisForm.getProject(),
                                user.getid(), user.getId_account());
                    } else {
                        e = brokerTeams.getListByProject("id", "ASC", thisForm.getProject(), 0, user.getId_account());
                    }

                    // }
                    // }
                    // if ((user.getprofile().equals("1")) || (user.getprofile().equals("0"))) {
                    ArrayList listaMiembros = new ArrayList();
                    teamsData teamData = new teamsData();
                    //membersData memberData = new membersData();
                    while (e.hasNext()) {
                        teamData = (teamsData) e.next();
                        membersData memberData = (membersData) memBroker.getData(teamData.getmembers(), user.getId_account());
                        //memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));
                        listaMiembros.add(memberData);
                    }

                    request.setAttribute("listMembers", listaMiembros);
                    // }
        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                typetasksBroker.close();
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addProject"));
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAddForm"));

                } else if (action.equals("showAll")) {

                    if (request.getParameter("typeOp") != null) {
                        thisForm.setTypeProject(Integer.parseInt(request.getParameter("typeOp").toString()));
                    }

                    Iterator e;
                    if (thisForm.getTypeProject() == 0) {
                        e = projBroker.getListSubProj(thisForm.getProject(), 0, user.getId_account());
                    } else {
                        e = projBroker.getListSubProj(thisForm.getProject(), thisForm.getTypeProject(), 0, user.getId_account());
                    }
                    // Se trata de un showAll de los subproyectos asociadas a un proyecto determinado.                    


                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();
                    while (e.hasNext()) {
                        lista.add(e.next());
                    }

                    // Se retorna la lista de las tareas de este proyecto nada mas.
                    request.setAttribute("listSubProj", lista);



                    projectsData projectMember = (projectsData) projBroker.getData(thisForm.getProject(), user.getId_account());
        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "<a href='./projects.do?operation=view&id=" +
                            projectMember.getid() + "'>" +
                            projectMember.getname() + "</a>&nbsp;/" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.allSubProj"));
                    request.setAttribute("company", company);
                    // Se retorna la lista de las tareas de este proyecto nada mas.

                    return (mapping.findForward("displayAllSub"));

                } else if (action.equals("edit")) {
                    // Si se trata de un edit, se debe de cargar los datos del bean
                    // en el formulario.
                    projectsData data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
           
                    projectsData data2= (projectsData) projBroker.getData(data.getProject_id(), user.getId_account());
                    
                    session.setAttribute("subprojedit", String.valueOf(data.getProject_id()));
                    session.setAttribute("sec_proj", String.valueOf(data.getSec_projects()));
                    // Se verifica que el usuario sea un member o admin, sino, NO tiene acceso.
                    if (brokerTeams.isMember(data.getid(), user.getid(), user.getId_account()) ||
                            //(user.getid() == 1)) {
                            (user.getprofile().equals("3") || user.getprofile().equals("4")) || data2.getowner()==user.getid()) {

                        if ((data.getowner() != user.getid() && data2.getowner()!=user.getid()) &&
                                (!user.getprofile().equals("3") && !user.getprofile().equals("4")) ) {
                            // (user.getid() != 1)) {  // Modify by Jury 04/05/04

                            // Si no es el mismo due�o ni el admin, no puede editarlo
                            errors.add("notOwner", new ActionError("errors.notYourProject.wrong"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (mapping.findForward("listingWithErrors"));
                        } else {
                            // se trata del due�o del proyecto.
                            request.setAttribute("title",
                                    java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.editProject"));

                            // We copy all the properties from the form to the bean.
                            PropertyUtils.copyProperties(thisForm, data);
                            thisForm.setOperation("applyEdit");

                            // Se deben cargar los listados de Organizaciones y Members para los
                            // combos correspondientes.
                            request.setAttribute("listOrganizations", getListing(orgBroker, "name", "ASC", user.getId_account()));
                            Iterator e = null;

                            //if (user.getprofile().equals("1")) {
                            // if (thisForm.getProject_id() != 0) {
                            //     e = brokerTeams.getListByProject("id", "ASC", thisForm.getProject_id(), 0, user.getId_account());
                            // } else {
                            e = brokerTeams.getListByProject("id", "ASC", thisForm.getid(), 0, user.getId_account());
                            //}

                            //} 
                            if (user.getprofile().equals("0")) {
                                /*  if (thisForm.getProject_id() != 0) {
                                e = brokerTeams.getListByProjectMember("parentMember.name",
                                "ASC",
                                thisForm.getProject_id(),
                                user.getid(), user.getId_account());
                                } else {*/
                                e = brokerTeams.getListByProjectMember("parentMember.name",
                                        "ASC",
                                        thisForm.getid(),
                                        user.getid(), user.getId_account());
                            //}
                            } else {
                                e = brokerTeams.getListByProject("id", "ASC", thisForm.getid(), 0, user.getId_account());
                            }

                            //  }
                            //}
                            //  if ((user.getprofile().equals("1")) || (user.getprofile().equals("0"))) {
                            ArrayList listaMiembros = new ArrayList();
                            teamsData teamData = new teamsData();
                            //membersData memberData = new membersData();

                            while (e.hasNext()) {
                                teamData = (teamsData) e.next();
                                membersData memberData = (membersData) memBroker.getData(teamData.getmembers(), user.getId_account());
                                memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));
                                listaMiembros.add(memberData);
                            }


                            request.setAttribute("listMembers", listaMiembros);
                            //}
                            //request.setAttribute("listMembers", getListing(memBroker, "name", "ASC"));
                            //Se define un Calendar.
                            Calendar now = Calendar.getInstance();
                            // Se extrae el componente dia, mes y a�o del start_date

                            if (thisForm.getstart_date() != null) {
                                now.setTime(thisForm.getstart_date());
                            }

                            String auxmonth = "0" + (now.get(Calendar.MONTH) + 1);
                            String auxday = "0" + now.get(Calendar.DAY_OF_MONTH);

                            if (auxmonth.length() > 2) {
                                auxmonth = auxmonth.substring(1);
                            }
                            if (auxday.length() > 2) {
                                auxday = auxday.substring(1);
                            }

                            request.setAttribute("fecha1", "" + now.get(Calendar.YEAR) +
                                    "-" + auxmonth +
                                    "-" + auxday);

                            // Se extrae el componente dia, mes y a�o del end_date
                            if (thisForm.getend_date() != null) {
                                now.setTime(thisForm.getend_date());
                            }

                            auxmonth = "0" + (now.get(Calendar.MONTH) + 1);
                            auxday = "0" + now.get(Calendar.DAY_OF_MONTH);
                            if (auxmonth.length() > 2) {
                                auxmonth = auxmonth.substring(1);
                            }
                            if (auxday.length() > 2) {
                                auxday = auxday.substring(1);
                            }
        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                            request.setAttribute("fecha2", "" + now.get(Calendar.YEAR) +
                                    "-" + auxmonth +
                                    "-" + auxday);
                            // Se agrega el link para el menu con la ruta
                            request.setAttribute("menuRoute",
                                    "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                    "<a href='./projects.do?operation=view&id=" +
                                    data.getid() + "'>" +
                                    data.getname() + "</a>&nbsp;/" +
                                    "&nbsp;" +
                                    java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.editProject"));
                            request.setAttribute("company", company);
                            return (mapping.findForward("displayEditForm"));
                        }
                    } else {        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                        // No hay acceso, se redirecciona a una pagina donde se le notifica
                        // de eso.
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/");
                        request.setAttribute("company", company);
                        return (mapping.findForward("accessDenied"));
                    }

                } else if (action.equals("view") || action.equals("sort") || action.equals("paging") || action.equals("notify")) {

                    if (session.getAttribute("project") != null) {
                        session.removeAttribute("project");
                    }
                    if (thisForm.getTypeProject() == 0) {
                        thisForm.setTypeProject(2);
                    }      
                    // Si se trata de un view, se debe de cargar los datos del bean
                    // en el formulario.
                    if (thisForm.getid() == 0) { 
                        int proy_task = Integer.parseInt(session.getAttribute("proy_task").toString());
                        thisForm.setid(proy_task);
                        session.removeAttribute("proy_task"); 
                    }       
                    //projectsData data = (projectsData) projBroker.getData(thisForm.getid());
                    projectsData data = new projectsData();
                    projectsData parentData = new projectsData();       System.out.println("VIEW4");
                    if (request.getParameter("id") != null) {
                        data = (projectsData) projBroker.getData(Integer.parseInt(request.getParameter("id").toString().trim()), user.getId_account());
                    } else {
                        data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                    }
                    if (thisForm.getProject() != 0) {
                        parentData = (projectsData) projBroker.getData(thisForm.getProject(), user.getId_account());
                        session.setAttribute("user", String.valueOf(parentData.getowner()));
                    } else {
                        session.setAttribute("user", String.valueOf(data.getowner()));
                    }
                    data.setcreated(Timestamp.valueOf(data.convTimeZone(data.getcreated(), user.getTime_zone())));
                    data.setmodified(Timestamp.valueOf(data.convTimeZone(data.getmodified(), user.getTime_zone())));
                    data.setend_date(Timestamp.valueOf(data.convTimeZone(data.getend_date(), user.getTime_zone())));
                    data.setstart_date(Timestamp.valueOf(data.convTimeZone(data.getstart_date(), user.getTime_zone())));
                    // Se verifica que el usuario sea un member, sino, NO tiene acceso.
                    if ((brokerTeams.isMember(data.getid(), user.getid(), user.getId_account())) ||
                            // (user.getid() == 1)) {
                            (user.getprofile().equals("3") || user.getprofile().equals("4"))) {

                        // Se guardan en el contexto el total de horas estimadas y reales
                        Iterator real_hours = brokerTasks.getListByProject(thisForm.getid(), user.getId_account());
                        //BigDecimal real_hours
                        //String auxRealHours = null;
                        /*BigDecimal totHour = new BigDecimal("0");
                        BigDecimal totMin = new BigDecimal("0");*/
                        BigDecimal totEst = new BigDecimal("0");
                        BigDecimal totAcum = new BigDecimal("0");
                        tasksData taskData;
                        //schedulesData scheduleData;
                        while (real_hours.hasNext()) {
                            taskData = new tasksData();
                            taskData = (tasksData) real_hours.next();
                            /*totHour = totHour.add(brokerSchedule.getTotalTaskRealHours(taskData.getid(), user.getId_account()));
                            totMin = totMin.add(brokerSchedule.getTotalTaskRealMinutes(taskData.getid(), user.getId_account()));
                             */
                            totAcum = this.addTime(taskData.getactual_time(), totAcum);
                            totEst = this.addTime(taskData.getestimated_time(), totEst);

                        }
                        /*   boolean band_min = false;
                        String[] split_min = null;
                        String replace_min = "";
                        while (!band_min) {
                        if (totMin.compareTo(new BigDecimal("59")) == 1) {
                        totMin = totMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                        replace_min = totMin.toString().replace('.', ',');
                        split_min = replace_min.split(",");
                        totHour = totHour.add(new BigDecimal(split_min[0]));
                        totMin = new BigDecimal("0." + split_min[1]);
                        totMin = totMin.multiply(new BigDecimal("60"));
                        if (totMin.toString().replace('.', ',').split(",").length > 1) {
                        replace_min = totMin.toString().replace('.', ',');
                        split_min = replace_min.split(",");
                        totMin = new BigDecimal(split_min[0]);
                        }
                        } else {
                        band_min = true;
                        }
                        }
                        if (totMin.toString().length() == 1) {
                        request.setAttribute("real_hours", totHour.toString() + ":0" + totMin.toString());
                        } else {
                        request.setAttribute("real_hours", totHour.toString() + ":" + totMin.toString());
                        }*/
                        request.setAttribute("real_hours", data.formatRealHour(totAcum));
                        // Se guardan en el contexto el total de horas estimadas y reales
                        request.setAttribute("estimated_hours",
                                data.formatRealHour(totEst));
                        // Se guardan en el contexto el total de horas estimadas y reales
                        Iterator subProjects = projBroker.getListSubProj(thisForm.getid(), user.getId_account());
                        projectsData proData;
                        //BigDecimal real_hours
                        //auxRealHours = null;
                       /* totHour = new BigDecimal("0");
                        totMin = new BigDecimal("0");*/
                        BigDecimal totAcumSub = new BigDecimal("0");
                        BigDecimal totEstSub = new BigDecimal("0");
                        //BigDecimal tot_estima = new BigDecimal("0");
                        while (subProjects.hasNext()) {
                            proData = new projectsData();
                            proData = (projectsData) subProjects.next();
                            Iterator real_hoursSubProjects = brokerTasks.getListByProject(proData.getid(), proData.getId_account());
                            //tot_estima= tot_estima.add(projBroker.getSumEstimatedHours(proData.getid(), proData.getId_account()));
                            while (real_hoursSubProjects.hasNext()) {
                                taskData = new tasksData();
                                taskData = (tasksData) real_hoursSubProjects.next();
                                //        totHour = totHour.add(brokerSchedule.getTotalTaskRealHours(taskData.getid(), user.getId_account()));
                                //        totMin = totMin.add(brokerSchedule.getTotalTaskRealMinutes(taskData.getid(), user.getId_account()));
                                totAcumSub = this.addTime(taskData.getestimated_time(), totAcumSub);
                                totEstSub = this.addTime(taskData.getestimated_time(), totEstSub);
                            /*        band_min = false;
                            split_min = null;
                            replace_min = "";
                            while (!band_min) {
                            if (totMin.compareTo(new BigDecimal("59")) == 1) {
                            totMin = totMin.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                            replace_min = totMin.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            totHour = totHour.add(new BigDecimal(split_min[0]));
                            totMin = new BigDecimal("0." + split_min[1]);
                            totMin = totMin.multiply(new BigDecimal("60"));
                            if (totMin.toString().replace('.', ',').split(",").length > 1) {
                            replace_min = totMin.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            totMin = new BigDecimal(split_min[0]);
                            }
                            } else {
                            band_min = true;
                            }
                            }*/
                            }
                        }

                        // Se guardan en el contexto el total de horas estimadas y reales
                        /*if (totMin.toString().length() == 1) {
                        request.setAttribute("real_hoursSub", totHour.toString() + ":0" + totMin.toString());
                        } else {
                        request.setAttribute("real_hoursSub", totHour.toString() + ":" + totMin.toString());
                        }*/

                        request.setAttribute("real_hoursSub", data.formatRealHour(totAcumSub));
                        request.setAttribute("estimated_hoursSub", data.formatRealHour(totEstSub));
                        // We copy all the properties from the form to the bean.
                        PropertyUtils.copyProperties(thisForm, data);
                        request.setAttribute("project", data);

                        // Desplegas la informacion adicional cuando se ve un proyecto,
                        // a saber las tareas asociadas al mismo, topicos, equipo y contenido
                        // SubProjects.
                        sortSubProjects(request, thisForm, projBroker, user.getId_account());
                        // Tasks.
 
                        sortTasks(request, thisForm, brokerTasks, user.getId_account());
                        // Topics
                        sortTopics(request, thisForm, brokerTopics, user.getTime_zone(), user.getId_account());
                        // Teams
  
                        sortTeams(request, thisForm, brokerTeams, user.getId_account());
                        // Files
                        sortFiles(request, thisForm, fileBroker, user.getTime_zone(), user.getId_account());
                        // Costs
                        sortCosts(request, thisForm, costBroker, user.getId_account());
                        // Risks
                        sortRisks(request, thisForm, riskBroker, user.getId_account());

                        // Se genera el archivo inicial de distribucion de oportunidades por 
                        // temperatura.
                        java.io.ByteArrayOutputStream map = new java.io.ByteArrayOutputStream();
                        String filename = WebChart.generatePieChart(request.getSession(),
                                new java.io.PrintWriter(map), "" + data.getid(), user.getId_account());

                        request.setAttribute("FILENAME_TASKS", filename);
                        request.setAttribute("FILENAME_TASKS_MAP", map.toString());

                        map = new java.io.ByteArrayOutputStream();
                        filename = WebChart.generatePieChartTasks(request.getSession(),
                                new java.io.PrintWriter(map), "" + data.getid());
                        request.setAttribute("FILENAME_TASKS_STATUS", filename);
                        request.setAttribute("FILENAME_TASKS_STATUS_MAP", map.toString());

                        // Se guarda el id del usuario conectado.
                        request.setAttribute("connectedUser", "" + user.getid());
                        String Dir = null;
                        if (data.getProject_id() != 0) {
                            Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + data.getname() +
                                    "</a>&nbsp;/&nbsp;";

                            boolean band = false;
                            int idSubProject = data.getProject_id();
                            projectsData subProject = new projectsData();
                            while (!band) {
                                subProject = new projectsData();
                                subProject = (projectsData) projBroker.getData(idSubProject, user.getId_account());
                                if (subProject.getname() != null) {
                                    Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + subProject.getid() + "'>" + subProject.getname() +
                                            "</a>&nbsp;/&nbsp;" + Dir;
                                    idSubProject = subProject.getProject_id();
                                } else {
                                    band = true;
                                }
                            }
                    System.out.println("ahhh");
                        } else {

                            Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + data.getname() +
                                    "</a>&nbsp;/&nbsp;";


                        }
        // Se cierran todos los brokers abiertos.
                brokersl.close();
                riskBroker.close();
                costBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                brokerSchedule.close();
                projBroker.close();
                assignBroker.close();
                typetasksBroker.close();
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                "&nbsp;" + Dir);
                        request.setAttribute("company", company);
                        request.setAttribute("projectType", String.valueOf(thisForm.getTypeProject()));
                        // Se despliega el formulario
                        
                        
                            return (mapping.findForward("displayViewForm"));
                    } else {
                        // Se cierran todos los brokers abiertos.
                brokersl.close();
                riskBroker.close();
                costBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                brokerSchedule.close();
                projBroker.close();
                assignBroker.close();
                typetasksBroker.close();
                        // No hay acceso, se redirecciona a una pagina donde se le notifica
                        // de eso.
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/");
                        request.setAttribute("company", company);
                        return (mapping.findForward("accessDenied"));
                    }

                } else if (action.equals("delete")) {
                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = projBroker.getItems(fields, user.getId_account());

                    request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                    request.setAttribute("items", items);
                    request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Project"));
                    request.setAttribute("do", request.getRequestURI());
                    request.setAttribute("company", company);
                            // Se cierran todos los brokers abiertos.
                        brokersl.close();
                costBroker.close();
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                assignBroker.close();
                typetasksBroker.close();
                    // forward to display the list
                    return (mapping.findForward("confirmDelete"));

                } else if (action.equals("applyDelete")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado
                    // get the string with ids separate by "," character, and split in array os strings

                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";
                    System.out.println(fields.length);
                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }

                    ArrayList items = projBroker.getItems(fields, user.getId_account());

                    System.out.println("length "+items.size());
                    // Se procede con el borrado de cada una de ellas.
                    projectsData dataDelete;
                    for (int i = 0; i < items.size(); i++) {
                        dataDelete = (projectsData) items.get(i);
                        if ((dataDelete.getowner() != user.getid()) &&
                                //(user.getid() != 1)) {
                                (!user.getprofile().equals("3") && !user.getprofile().equals("4"))) {
                            // Si no es el mismo due�o o el admin, no puede editarlo
                            errors.add("notOwner",
                                    new ActionError("errors.cannotDeleteProject.wrong",
                                    dataDelete.getname()));
                            saveErrors(request, errors);
                        } else {

                            Iterator e = projBroker.getListProyDelete(dataDelete.getid(), dataDelete.getId_account());

                            projectsData projData = new projectsData();
                            while (e.hasNext()) {
                                projData = (projectsData) e.next();

                                // PASO #01. BORRAR TODOS LOS COSTOS.
                                costBroker.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                // PASO #02. BORRAR LOS TOPICS/POST
                                brokerTopics.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                // PASO #03. BORRAR LOS FILES
                                fileBroker.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                // PASO #04. BORRAR LOS RIESGOS
                                riskBroker.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                // PASO #05. BORRAR TODAS LOS REGISTROS DE LA BITACORA DE TAREAS
                                brokersl.deleteAllReferencesByProject(projData.getid(), user.getId_account());
                                
                                // PASO #06. BORRAR TODAS LAS TAREAS
                                // Se puede borrar y se procede, primero con las tareas
                                brokerTasks.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                
                                // PASO #07. BORRAR LOS EQUIPOS
                                brokerTeams.deleteAllReferencesByProject(projData.getid(), user.getId_account());

                                projBroker.delete(projData);
    
                            }
                            // PASO #01. BORRAR TODOS LOS COSTOS.
                                costBroker.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());

                                // PASO #02. BORRAR LOS TOPICS/POST
                                brokerTopics.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());

                                // PASO #03. BORRAR LOS FILES
                                fileBroker.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());

                                // PASO #04. BORRAR LOS RIESGOS
                                riskBroker.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());

                                // PASO #05. BORRAR TODAS LOS REGISTROS DE LA BITACORA DE TAREAS
                                brokersl.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());
                                
                                // PASO #06. BORRAR TODAS LAS TAREAS
                                // Se puede borrar y se procede, primero con las tareas
                                brokerTasks.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());

                                
                                // PASO #07. BORRAR LOS EQUIPOS
                                brokerTeams.deleteAllReferencesByProject(dataDelete.getid(), dataDelete.getId_account());
                                
                    projBroker.delete(dataDelete);
                        }
                    }        // Se cierran todos los brokers abiertos.
                brokersl.close();
                costBroker.close();
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                brokersl.close();
                    request.setAttribute("company", company);
                    // return to the page that list the projects
                    if (errors.isEmpty()) {
                        return (mapping.findForward("listingWithErrors"));
                    } else {
                        return (mapping.findForward("listing"));
                    }


                } else if (action.equals("moveTask")) {
                    // Si la operacion es mover un subproyecto a otro proyecto.

                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = projBroker.getItems(fields, user.getId_account());
                    projectsData data2 = (projectsData) items.get(0);

                    if (user.isAdmin() || ((tasksData) items.get(0)).getparentProject().getowner() == user.getid()) {
                        // Solo un usuario administrador, o el dueno del proyecto puede mover tareas
                        String param = "";
                        request.setAttribute("fromPage", request.getParameter("fromPage"));
                        request.setAttribute("param", "" + param);
                        request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                        request.setAttribute("items", items);
                        request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources",
                                new Locale(user.getlanguage(), "")).getString("common.Task"));
                        request.setAttribute("do", request.getRequestURI());

                        if (user.isAdmin()) {
                            // Es el admin, tiene acceso a todo
                            Iterator m = brokerTeams.getListByProject("members", "ASC", data2.getid(), 0, user.getId_account());
                            ArrayList listam = new ArrayList();
                            teamsData teamData;
                            while (m.hasNext()) {
                                teamData = new teamsData();
                                teamData = (teamsData) m.next();
                                listam.add(new Integer(teamData.getmembers()));
                            }

                            // Es el admin, tiene acceso a todo
                            Iterator e = projBroker.getListProy("id", "ASC", 0, user.getId_account());
                            ArrayList lista = new ArrayList();
                            projectsData projD = new projectsData();
                            Iterator m2;
                            ArrayList listam2 = new ArrayList();
                            boolean band = true;
                            while (e.hasNext()) {
                                projD = new projectsData();
                                projD = (projectsData) e.next();
                                //lista.add(projD);
                                m2 = brokerTeams.getListByProject("members", "ASC", projD.getid(), 0, projD.getId_account());
                                listam2 = new ArrayList();
                                while (m2.hasNext()) {
                                    teamData = new teamsData();
                                    teamData = (teamsData) m2.next();
                                    listam2.add(new Integer(teamData.getmembers()));
                                }
                                band = true;
                                for (int i = 0; i < listam.size(); i++) {
                                    if (!listam2.contains((Integer) listam.get(i))) {
                                        band = false;
                                    }
                                }
                                if (band) {
                                    request.setAttribute("empty", "N");
                                    lista.add(projD);
                                }
                            }

                            while (e.hasNext()) {
                                projD = new projectsData();
                                projD = (projectsData) e.next();
                                //lista.add(projD);
                                m2 = brokerTeams.getListByProject("members", "ASC", projD.getid(), 0, projD.getId_account());
                                listam2 = new ArrayList();
                                while (m2.hasNext()) {
                                    teamData = new teamsData();
                                    teamData = (teamsData) m2.next();
                                    listam2.add(new Integer(teamData.getmembers()));
                                }
                                band = true;
                                for (int i = 0; i < listam.size(); i++) {
                                    if (!listam2.contains((Integer) listam.get(i))) {
                                        band = false;
                                    }
                                }
                                if (band) {
                                    request.setAttribute("empty", "N");
                                    lista.add(projD);
                                }
                            }
                            request.setAttribute("projectList", lista);

                        }        // Se cierran todos los brokers abiertos.
                brokersl.close();
                assignBroker.close();
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                typetasksBroker.close();
                        request.setAttribute("company", company);
                        // forward to display the list 
                        return (mapping.findForward("confirmMoveSub"));
                    }
                } else if (action.equals("moveProj")) {
                    // Si la operacion es mover un subproyecto a otro proyecto.

                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = projBroker.getItems(fields, user.getId_account());
                    projectsData data2 = (projectsData) items.get(0);

                    if (user.isAdmin() || ((tasksData) items.get(0)).getparentProject().getowner() == user.getid()) {
                        // Solo un usuario administrador, o el dueno del proyecto puede mover tareas
                        String param = "";
                        request.setAttribute("fromPage", request.getParameter("fromPage"));
                        request.setAttribute("param", "" + param);
                        request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                        request.setAttribute("items", items);
                        request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources",
                                new Locale(user.getlanguage(), "")).getString("common.Task"));
                        request.setAttribute("do", request.getRequestURI());

                        if (user.isAdmin()) {
                            // Es el admin, tiene acceso a todo
                            Iterator m = brokerTeams.getListByProject("members", "ASC", data2.getid(), 0, user.getId_account());
                            ArrayList listam = new ArrayList();
                            teamsData teamData;
                            while (m.hasNext()) {
                                teamData = new teamsData();
                                teamData = (teamsData) m.next();
                                listam.add(new Integer(teamData.getmembers()));
                            }
                            Iterator e = projBroker.getListPrincProy("id", "ASC", 0, data2.getid(), user.getId_account());
                            ArrayList lista = new ArrayList();
                            projectsData projD = new projectsData();
                            Iterator m2;
                            ArrayList listam2 = new ArrayList();
                            boolean band = true;
                            while (e.hasNext()) {
                                projD = new projectsData();
                                projD = (projectsData) e.next();
                                //lista.add(projD);
                                m2 = brokerTeams.getListByProject("members", "ASC", projD.getid(), 0, projD.getId_account());
                                listam2 = new ArrayList();
                                while (m2.hasNext()) {
                                    teamData = new teamsData();
                                    teamData = (teamsData) m2.next();
                                    listam2.add(new Integer(teamData.getmembers()));
                                }
                                band = true;
                                for (int i = 0; i < listam.size(); i++) {
                                    if (!listam2.contains((Integer) listam.get(i))) {
                                        band = false;
                                    }
                                }
                                if (band) {
                                    request.setAttribute("empty", "N");
                                    lista.add(projD);
                                }
                            }
                            request.setAttribute("projectList", lista);
                        }
                        request.setAttribute("company", company);
                        // forward to display the list 
                        return (mapping.findForward("confirmMoveProj"));
                    }
                } else if (action.equals("applyAdd")) {
                    // Se validan los datos ingresados
                    errors = thisForm.validate(mapping, request);
                    if (errors.isEmpty()) {
                        // Se trata de la aplicacion de un insert en la BD
                        projectsData data = new projectsData();
                        projectsData parentData = new projectsData();
                        // We copy all the properties from the form to the bean.
                        PropertyUtils.copyProperties(data, thisForm);
                        
                         if (thisForm.getautom_notification()==null){
                        data.setautom_notification("0");
                        }else{
                        
                        data.setautom_notification("1");
                        }
                        
                        data.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setId_account(user.getId_account());
                        // We add the new record.
                        projBroker.add(data);
                        // Y se auto agrega al equipo
                        teamsData dataNew = new teamsData();
                        dataNew.setid(0);
                        dataNew.setauthorized("0");
                        dataNew.setpublished("0");
                        dataNew.setprojects(data.getid());
                        dataNew.setmembers(data.getowner());
                        dataNew.setId_account(user.getId_account());
                        // We delete the object in the DBMS
                        brokerTeams.add(dataNew);
                        request.setAttribute("company", company);
                        // forward to display the list
                        if (data.getProject_id() > 0) {
                            return (mapping.findForward("viewProject"));
                        } else {
                            return (mapping.findForward("listing"));
                        }
                    } else {
                        // Se detecto un error de validacion, se retorna
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("displayAddFormErrors").
                                getPath() + "?operation=add"));
                    }
                } else if (action.equals("applyAddSub")) {
                    // Se validan los datos ingresados
                    errors = thisForm.validate(mapping, request);
                    if (errors.isEmpty()) {
                        // Se trata de la aplicacion de un insert en la BD
                        projectsData data = new projectsData();
                        projectsData parentData = new projectsData();
                        // We copy all the properties from the form to the bean.
                        PropertyUtils.copyProperties(data, thisForm);
                        if (session.getAttribute("subproj") != null) {
                            data.setProject_id(Integer.parseInt(session.getAttribute("subproj").toString()));
                            parentData = (projectsData) projBroker.getData(data.getProject_id(), user.getId_account());
                            session.removeAttribute("subproj");
                        }
                        // We set the create date & time
                        data.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setId_account(user.getId_account());
                        // We add the new record.
                        projBroker.add(data);
                        if (data.getProject_id() == 0) {
                            data.setSec_projects("-" + String.valueOf(data.getid()) + "-");
                        } else {
                            projectsData data2 = (projectsData) projBroker.getData(data.getProject_id(), user.getId_account());
                            data.setSec_projects(data2.getSec_projects() + "-" + String.valueOf(data.getid()) + "-");
                        }
                         if (thisForm.getautom_notification()==null){
                        data.setautom_notification("0");
                        }else{
                        data.setautom_notification("1");
                        }
                        
                        projBroker.update(data);
                        // Y se auto agrega al equipo
                        teamsData dataNew = new teamsData();
                        dataNew.setid(0);
                        dataNew.setauthorized("0");
                        dataNew.setpublished("0");
                        dataNew.setprojects(data.getid());
                        dataNew.setmembers(data.getowner());
                        dataNew.setId_account(user.getId_account());
                        // We delete the object in the DBMS
                        brokerTeams.add(dataNew);
                        
 

                             
                        //Y agrega el papa al equipo de proyecto

                        teamsData parentDataNew = new teamsData();
                        
                        
                        if (data.getProject_id() != 0) {
                            if (parentData.getowner() != data.getowner()) {


                                parentDataNew.setid(0);
                                parentDataNew.setauthorized("0");
                                parentDataNew.setpublished("0");
                                parentDataNew.setprojects(data.getid());
                                parentDataNew.setmembers(parentData.getowner());
                                parentDataNew.setId_account(user.getId_account());
                                // We delete the object in the DBMS
                                brokerTeams.add(parentDataNew);
                            }
                        }
                        
                                                    Iterator e1=null;
                            if (request.getParameter("inheritTeam").toString().equals("1")){
                                 e1 = brokerTeams.getListByProject("id", "ASC", data.getProject_id(), 0, user.getId_account());
                            }
                        teamsData teamData = new teamsData();
                            while (e1.hasNext()) {
                                teamData = (teamsData) e1.next();
                                if(!brokerTeams.isMember(data.getid(), teamData.getmembers(), teamData.getId_account()))    {                             
                                    teamData.setid(0);
                                    teamData.setpublished("0");
                                    teamData.setprojects(data.getid());
                                    teamData.setId_account(user.getId_account());
                                    //memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));
                                     brokerTeams.add(teamData);
                                }
                            }
                        
                        request.setAttribute("company", company);
                        // forward to display the list
                        if (data.getProject_id() > 0) {
                            session.setAttribute("proy_task", String.valueOf(data.getProject_id()));
                            return (mapping.findForward("viewProject"));
                        } else {
                            return (mapping.findForward("listing"));
                        }
                    } else {
                        System.out.println("error");
                        System.out.println(thisForm.getProject());
                        // Se detecto un error de validacion, se retorna
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        request.setAttribute("proy", session.getAttribute("subproj").toString());
                        return (new ActionForward(mapping.findForward("displayAddFormErrors").
                                getPath() + "?operation=addsub"));
                    }
                } else if (action.equals("applyEdit")) {
                    // Se validan los datos ingresados
                    errors = thisForm.validate(mapping, request);
                    if (errors.isEmpty()) {
                        // Se trata de la aplicacion de un update en la BD
                        projectsData data = new projectsData();
                        // We copy all the properties from the form to the bean.                        
                        PropertyUtils.copyProperties(data, thisForm);
                         if (thisForm.getautom_notification()==null){
                        data.setautom_notification("0");
                        }else{
                        
                        data.setautom_notification("1");
                        }
                        
                        data.setProject_id(Integer.parseInt(session.getAttribute("subprojedit").toString()));
                        data.setSec_projects(session.getAttribute("sec_proj").toString());
                        session.removeAttribute("subprojedit");
                        session.removeAttribute("sec_proj");
                        data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        projectsData originalProject = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                        data.setId_account(originalProject.getId_account());
                        // si hay cambio de dueno transferir todo
                        if (originalProject.getowner() != data.getowner()) {

                            // Si el dueno es nuevo, se agrega al equipo correspondiente
                            if (brokerTeams.isMember(thisForm.getid(), thisForm.getowner(), user.getId_account()) == false) {
                                teamsData dataNew = new teamsData();
                                dataNew.setid(0);
                                dataNew.setauthorized("0");
                                dataNew.setpublished("0");
                                dataNew.setprojects(thisForm.getid());
                                dataNew.setmembers(thisForm.getowner());
                                // We delete the object in the DBMS
                                brokerTeams.add(dataNew);
                            }
                        }
                                                    Iterator e1=null;
                        if (request.getParameter("inheritTeam")!=null){
                            if (request.getParameter("inheritTeam").toString().equals("1")){
                                 e1 = brokerTeams.getListByProject("id", "ASC", data.getProject_id(), 0, user.getId_account());
                            
                        teamsData teamData = new teamsData();
                            while (e1.hasNext()) {
                                teamData = (teamsData) e1.next();
                                if(!brokerTeams.isMember(data.getid(), teamData.getmembers(), teamData.getId_account()))    {                             
                                    teamData.setid(0);
                                    teamData.setpublished("0");
                                    teamData.setprojects(data.getid());
                                    teamData.setId_account(user.getId_account());
                                    //memberData.setcreated(Timestamp.valueOf(memberData.convTimeZone(memberData.getcreated(), user.getTime_zone())));
                                     brokerTeams.add(teamData);
                                }
                            }
                            }
                        }
                        
                        // We add the new record.
                        projBroker.update(data);

                        request.setAttribute("company", company);
                        // forward to display the list
                        if (data.getProject_id() > 0) {
                            session.setAttribute("proy_task", String.valueOf(data.getProject_id()));
                            return (mapping.findForward("viewProject"));
                        } else {
                            return (mapping.findForward("listing"));
                        }
                    } else {
                        // Se detecto un error de validacion, se retorna
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("displayAddFormErrors").
                                getPath() + "?operation=edit"));
                    }
                } else if (action.equals("copy")) {
                    // Se trata de la aplicacion de un copy en la BD
                    projectsData data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                    if (data.getowner() != user.getid() &&
                            //(user.getid() != 1)) {
                            (!user.getprofile().equals("3") && !user.getprofile().equals("4"))) {
                        // Si no es el mismo due�o o admin, no puede editarlo
                        errors.add("notOwner", new ActionError("errors.notYourProject.wrong"));
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (mapping.findForward("listingWithErrors"));
                    } else {
                        // We copy all the properties from the original project
                        // to the new copy project
                        projectsData copyProject = new projectsData();
                        PropertyUtils.copyProperties(copyProject, data);
                        
                         Calendar calendar = Calendar.getInstance();
                        calendar.setTimeInMillis(data.getstart_date().getTime());
                        String day;
                        String month;
                        if ((calendar.get(Calendar.MONTH) + 1) >=10){
                            month=""+(calendar.get(Calendar.MONTH) + 1);
                        }else{
                            month="0"+(calendar.get(Calendar.MONTH) + 1);
                        }
                        if (calendar.get(Calendar.DAY_OF_MONTH) >=10){
                            day=""+calendar.get(Calendar.DAY_OF_MONTH);
                        }else{
                            day="0"+calendar.get(Calendar.DAY_OF_MONTH);
                        }
                        
                        request.setAttribute("id", ""+data.getid());    
                        request.setAttribute("name", data.getname()+ "- COPIA");
                        request.setAttribute("startDate1", "" + calendar.get(Calendar.YEAR) +
                            "-" + month +
                            "-" + day);
                        request.setAttribute("startDate2", "" + calendar.get(Calendar.YEAR) +
                            "-" + month +
                            "-" + day);
                        
                         Calendar calendar2 = Calendar.getInstance();
                        calendar2.setTimeInMillis(data.getend_date().getTime());
                         if ((calendar2.get(Calendar.MONTH) + 1) >=10){
                            month=""+(calendar2.get(Calendar.MONTH) + 1);
                        }else{
                            month="0"+(calendar2.get(Calendar.MONTH) + 1);
                        }
                        if (calendar2.get(Calendar.DAY_OF_MONTH) >=10){
                            day=""+calendar2.get(Calendar.DAY_OF_MONTH);
                        }else{
                            day="0"+calendar2.get(Calendar.DAY_OF_MONTH);
                        }
                        
                        request.setAttribute("endDate1", "" + calendar2.get(Calendar.YEAR) +
                            "-" + month +
                            "-" + day);
                        request.setAttribute("endDate2", "" + calendar2.get(Calendar.YEAR) +
                            "-" + month +
                            "-" + day);

                        /*Iterator listTasks = brokerTasks.getListByProject(data.getid(), data.getId_account());
                        ArrayList listaMiembros = new ArrayList();
                        while (listTasks.hasNext()) {
                            
                        }
                        
                        
                        request.setAttribute("listMembers", listaMiembros);*/
                     }   
                    /*if (data.getowner() != user.getid() &&
                            //(user.getid() != 1)) {
                            (!user.getprofile().equals("3") && !user.getprofile().equals("4"))) {
                        // Si no es el mismo due�o o admin, no puede editarlo
                        errors.add("notOwner", new ActionError("errors.notYourProject.wrong"));
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (mapping.findForward("listingWithErrors"));
                    } else {
                        // We copy all the properties from the original project
                        // to the new copy project
                        projectsData copyProject = new projectsData();
                        PropertyUtils.copyProperties(copyProject, data);

                        java.sql.Timestamp today = new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis());

                        // Actualizamos los campos correspondientes.
                        copyProject.setid(0);

                        // We set the create date & time
                        copyProject.setcreated(today);
                        copyProject.setmodified(today);
                        copyProject.setname("Copy of " + data.getname());
                        copyProject.setstart_date(today);
                        copyProject.setend_date(today);

                        // We add the new record.
                        projBroker.add(copyProject);
                        copyProject.setSec_projects("-" + copyProject.getid() + "-");
                        projBroker.update(copyProject);
                        int projectid = copyProject.getid();

                        // SE COPIAN TODAS LAS TAREAS DEL PROYECTO.
                        Iterator e = brokerTasks.getListByProject(data.getid(), user.getId_account());
                        tasksData newTask, copyTask;

                        while (e.hasNext()) {
                            newTask = new tasksData();
                            copyTask = (tasksData) e.next();
                            newTask.setproject(projectid);
                            newTask.setId_account(copyProject.getId_account());
                            newTask.setname(copyTask.getname());
                            newTask.setdescription(copyTask.getdescription());
                            newTask.setfare(copyTask.getfare());
                            newTask.setowner(copyTask.getowner());
                            newTask.setpredecessor(copyTask.getpredecessor());
                            newTask.setpredecessor_required(copyTask.getpredecessor_required());
                            newTask.setpriority(copyTask.getpriority());
                            newTask.settolerance(copyTask.gettolerance());
                            newTask.setassigned_to(0);
                            newTask.setactual_time(new BigDecimal(0));
                            newTask.setcompletion(0);
                    System.out.println("opc a");
                            newTask.setpublished("0");
                            newTask.setstatus(2);
                            newTask.settopic(0);
                            newTask.setstart_date(today);
                            newTask.setdue_date(today);
                            newTask.setreply_quotation_date(today);
                            newTask.setsend_quotation_date(today);
                            newTask.setreal_due_date(today);
                            newTask.setestimated_time(copyTask.getestimated_time());
                            newTask.setcomments(copyTask.getcomments());
                            newTask.setcollect(copyTask.getcollect());
                            newTask.setmessage(copyTask.getmessage());
                            newTask.setcreated(today);
                            newTask.setmodified(today);
                            newTask.setassigned(today);
                            brokerTasks.add(newTask);
                        }
                        // SE COPIAN LOS RIESGOS DE UN PROYECTO.
                        riskBroker.copyAllRiskToProject(data.getid(), projectid, user.getId_account());

                        // SE COPIAN LOS MIEMBROS DEL EQUIPO
                        brokerTeams.copyAllTeamToProject(data.getid(), projectid, user.getId_account());

                        // SE COPIAN LOS COSTOS DEL PROYECTO.
                        costBroker.copyAllCostsToProject(data.getid(), projectid, user.getId_account());
                    }
                    request.setAttribute("company", company);
                    if (data.getProject_id() > 0) {
                        session.setAttribute("proy_task", String.valueOf(data.getProject_id()));
                        return (mapping.findForward("viewProject"));
                    } else {
                        return (mapping.findForward("listing"));
                    }*/
                    projBroker.close();
                       // Se agrega el link para el menu con la ruta
                    thisForm.setOperation("applyCopy");
                    
                    String Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + data.getname() +
                                    "</a>&nbsp;/&nbsp;";
                    
                    // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                "&nbsp;" + Dir +java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.copyProject"));
                   
                   /* request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.copyProject"));
                    */
                    request.setAttribute("company", company);
                    return (mapping.findForward("copyProject"));
                }else if (action.equals("applyCopy")){
                    int idProject= Integer.parseInt(request.getParameter("id"));
                    // Se trata de la aplicacion de un copy en la BD
                        projectsData data = (projectsData) projBroker.getData(idProject, user.getId_account());
                        projectsData copyProject = new projectsData();
                        
                        java.sql.Timestamp today = new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis());
                        
                        
                    // Actualizamos los campos correspondientes.
                        copyProject.setid(0);
                        
                        copyProject.setId_account(data.getId_account());
                        copyProject.setParentProject(data.getParentProject());
                        copyProject.setProject_id(data.getProject_id());
                        copyProject.setSec_projects(data.getSec_projects());
                        copyProject.setSend_email(data.getSend_email());
                        copyProject.setautom_notification(data.getautom_notification());
                        copyProject.setcreated(data.getcreated());
                        copyProject.setdescription(data.getdescription());
                        copyProject.setdetailRisks(data.getdetailRisks());
                        copyProject.setdetailTeams(data.getdetailTeams());
                        copyProject.setend_date(data.getend_date());
                        copyProject.setmodified(data.getmodified());
                        copyProject.setname(data.getname());
                        copyProject.setorganization(data.getorganization());
                        copyProject.setowner(data.getowner());
                        copyProject.setparentOrganizations(data.getparentOrganizations());
                        copyProject.setparentOwner(data.getparentOwner());
                        copyProject.setpriority(data.getpriority());
                        copyProject.setpublished(data.getpublished());
                        copyProject.setpublished_assigned(data.getpublished_assigned());
                        copyProject.setpublished_endtask(data.getpublished_endtask());
                        copyProject.setstart_date(data.getstart_date());
                        copyProject.setstatus(data.getstatus());
                        copyProject.setupload_max(data.getupload_max());
                        // We set the create date & time
                        copyProject.setcreated(today);
                        copyProject.setmodified(today);
                        copyProject.setId_account(data.getId_account());
                        copyProject.setname(request.getParameter("name"));
                        copyProject.setstart_date(Timestamp.valueOf(request.getParameter("startDate1") + " 12:00:00.00"));
                        copyProject.setend_date(Timestamp.valueOf(request.getParameter("endDate1") + " 12:00:00.00"));
                        copyProject.setorganization(data.getorganization());
                        
                           request.setAttribute("company", company);
                            
                        request.setAttribute("id", request.getParameter("id"));    
                        request.setAttribute("name", request.getParameter("name"));
                        request.setAttribute("startDate1",request.getParameter("startDate1"));
                      //  request.setAttribute("startDate2",request.getParameter("startDate2"));
                        request.setAttribute("endDate1",request.getParameter("endDate1"));
                     //   request.setAttribute("endDate2",request.getParameter("endDate2"));
                        request.setAttribute("copyfileproject",request.getParameter("copyfileproject"));
                        request.setAttribute("copyfiletask",request.getParameter("copyfiletask"));
                        request.setAttribute("assignedTo",request.getParameter("assignedTo"));    
                        request.setAttribute("estimatedTime",request.getParameter("estimatedTime"));   
                        request.setAttribute("fare",request.getParameter("fare"));   
                        
                      
                        
                        if (copyProject.getstart_date().after(copyProject.getend_date())) {
                            // La fecha final debe ser superior a la inicial 
                            errors.add("DateConflict",
                                    new ActionError("errors.project.dueDateNotsuperior"));
                            saveErrors(request, errors);
                         
                        
                             request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.copyProject"));
                    
                            return (mapping.findForward("copyProject"));
                        }
                        // We add the new record.
                        projBroker.add(copyProject);
                        copyProject.setSec_projects("-" + copyProject.getid() + "-");
                        projBroker.update(copyProject);
                        
                        int projectid = copyProject.getid();
                        
                        // SE COPIAN LOS MIEMBROS DEL EQUIPO
                        brokerTeams.copyAllTeamToProject(data.getid(), projectid, user.getId_account());
                        
                        fileBroker= new filesBroker();
                        // SE COPIAN LOS ARCHIVOS
                        if (request.getParameter("copyfileproject").equals("1"))
                        fileBroker.addProjectFiles(data.getid(), projectid, user.getId_account());
                        
                       

                        // SE COPIAN TODAS LAS TAREAS DEL PROYECTO.
                        Iterator e = brokerTasks.getListByProject(data.getid(), user.getId_account());
                         tasksData oldTask, copyTask = new tasksData();
                        int idTask=0;
                         while(e.hasNext()){
                              //oldTask= (tasksData) e.next();
                              copyTask= (tasksData) e.next();//oldTask;
                              
                              idTask= copyTask.getid();
                              copyTask.setid(0);
                              /*Se inicializan las tareas */
                              copyTask.setstatus(2);
                              if (request.getParameter("assignedTo").equals("0"))
                                  copyTask.setassigned_to(0);
                              
                              copyTask.setstart_date(Timestamp.valueOf(request.getParameter("startDate1") + " 12:00:00.00"));
                              copyTask.setdue_date(Timestamp.valueOf(request.getParameter("endDate1") + " 12:00:00.00"));
                              if (request.getParameter("estimatedTime").equals("0"))
                                  copyTask.setestimated_time(new BigDecimal(0));
                              if (request.getParameter("fare").equals("0"))
                                  copyTask.setfare(new BigDecimal(0)); 
                              
                              copyTask.setactual_time(new BigDecimal(0));
                              copyTask.setcompletion(0);
                              copyTask.setproject(projectid);
                              copyTask.setpublished("0");
                              copyTask.settopic(0);
                              copyTask.setcomments("N/A");
                              copyTask.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setreal_due_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setassigned(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setsend_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setreply_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                              copyTask.setspread_fix(" ");
                               
                              brokerTasks.add(copyTask);
                              
                              tasksStatusLogData tasksSL= new tasksStatusLogData();
                        
                            tasksSL.setId_account(user.getId_account());
                            tasksSL.setMember(user.getid());
                            tasksSL.setStatus(2);
                            tasksSL.setTask(copyTask.getid());
                            tasksSL.setCreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                            brokersl.add(tasksSL);
                            
                         if (copyTask.getassigned_to() > 0) {
                            // Si hay una asignacion real, la misma se registra en el historico
                            // de asignaciones
                            assignmentsData assignData = new assignmentsData();
                            assignData.setassigned(data.getcreated());
                            assignData.setassigned_to(copyTask.getassigned_to());
                            assignData.setid(0);
                            assignData.setowner(copyTask.getowner());
                            assignData.settask(copyTask.getid());
                            assignData.setId_account(copyTask.getId_account());
                            assignBroker.add(assignData);
                        }
                                                    
                              oldTask= (tasksData)brokerTasks.getData(idTask);
                              // SE COPIAN LOS ARCHIVOS DE LAS TAREAS
                              if (request.getParameter("copyfiletask").equals("1"))
                              fileBroker.addTaskFiles(oldTask, copyTask);
                                    
                                // Se extrae de la sesion el loginData
                                loginData login = (loginData) session.getAttribute("login");
                                membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());
                                membersData to_member = (membersData) memBroker.getData(copyTask.getassigned_to(), user.getId_account());
                                if (copyTask.getassigned_to()!=0){
                                    //Se enva notificacin al usuario a quien se le asign la tarea            
                                    sm.send("taskassignment", from_member, to_member, copyTask.getid(), new String(copyTask.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                // Adicionalmente se le envia al duenno del proyecto.
                                membersData to_owner = (membersData) memBroker.getData(copyTask.getparentProject().getowner(), user.getId_account());
                                if (to_owner.getid() != to_member.getid()) {
                                    // Evitamos enviarle dobles emails.
                                    sm.send("taskassignment", from_member, to_owner, copyTask.getid(), new String(copyTask.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                        }
                    brokersl.close();
                    brokerTasks.close();
                    projBroker.close();assignBroker.close();
                    if (data.getProject_id() > 0) {
                        session.setAttribute("proy_task", String.valueOf(data.getProject_id()));
                        return (mapping.findForward("viewProject"));
                    } else {
                        return (mapping.findForward("listing"));
                    }
                }else if (action.equals("importTasks")) {
                    // Se trata de la aplicacion de un copy en la BD
                    projectsData data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                    if (data.getowner() != user.getid() &&
                            //(user.getid() != 1)) {
                            (!user.getprofile().equals("3") && !user.getprofile().equals("4"))) {
                        // Si no es el mismo due�o o admin, no puede editarlo
                        errors.add("notOwner", new ActionError("errors.notYourProject.wrong"));
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (mapping.findForward("listingWithErrors"));
                    } else {
                        PropertyUtils.copyProperties(thisForm, data);
                        request.setAttribute("project", data);
                        request.setAttribute("projectId", ""+data.getid());
                       // Se agrega el link para el menu con la ruta
                    thisForm.setOperation("applyImport");
                    String Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + data.getname() +
                                    "</a>&nbsp;/&nbsp;";
                    
                    // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                "&nbsp;" + Dir +java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.importLabel"));
                   // request.setAttribute("menuRoute",
                   //         "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                   //         java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.importLabel"));
                    
                    request.setAttribute("company", company);
                    
                    return (mapping.findForward("importTasks"));
                    }
                }else if (action.equals("applyImport")) {
                    projectsData pData= new projectsData();
                    
                    pData= (projectsData) projBroker.getData(thisForm.getid());
                    //retrieve the file representation
                    FormFile file = thisForm.getTheFile();
                    //retrieve the file name
                    String fileName = file.getFileName();
                    // Removemos cualquier caracter invalido
                    fileName = StringManipulator.generateValidFilename(fileName);

                    //retrieve the content type
                    String contentType = file.getContentType();
                    System.out.println("FILENAME: " + fileName + " / "+contentType);
                   
                       // Se agrega el link para el menu con la ruta
                    ArrayList list=excelFile.readMassiveTaskSheet(file, "Tareas", pData);//thisForm, user.getId_account());
                    tasksData data= new tasksData();
                    
                    data= (tasksData)list.get(0);
                    /*request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.importLabel"));
                    */
                    
                      String Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + pData.getname() +
                                    "</a>&nbsp;/&nbsp;";
                    // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                "&nbsp;" + Dir +java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.importLabel"));
                   
                    request.setAttribute("company", company);
                    if (data.getHasErrors()){
                        errors.add("DateConflict",
                                        new ActionError(data.getdescription()));
                                saveErrors(request, errors);
                                
                    return (mapping.findForward("importTasks"));
                    }else{
                        Iterator e= list.iterator();
                        
                        java.sql.Timestamp today = new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis());
                        int counter= 0;
                        while(e.hasNext()){
                            counter ++;
                            data= (tasksData) e.next();
                            System.out.println("TASK NUMBER #"+counter+": "+ data.getid()+" - "+ data.getname());
                            if (data.getstart_date().after(data.getdue_date())) {
                                 // La fecha final debe ser superior a la inicial 
                                 errors.add("DateConflict",
                                         new ActionError("errors.task.dueDateNotsuperior"));
                                 saveErrors(request, errors);
                                 request.setAttribute("company", company);
                                 return (mapping.findForward("importTasks"));
                             } 
                            type_tasksData valTypeTasks = (type_tasksData) typetasksBroker.getData(data.gettype_task(), user.getId_account());
                             
                        if (valTypeTasks.getuse_prefix() != null &&
                                valTypeTasks.getuse_prefix().equalsIgnoreCase("1")) {
                            // El tipo de tarea hace uso de un prefijo para agregarlo al
                            // nombre de cada tarea.                                
                            String prefijoNuevo = valTypeTasks.getprefix();

                            // Obtenemos el consecutivo con base en el tipo de tarea 
                            // que se definio

                            prefijoNuevo += "-" +
                                    brokerTasks.getPrefixForTasks(data.getproject(),
                                    data.gettype_task(), user.getId_account());

                            // Formamos el nuevo nombre de la tarea
                            prefijoNuevo += " " + data.getname();
                            prefijoNuevo = prefijoNuevo.trim();
                            data.setname(prefijoNuevo);
                          }
                        
                        // Verificamos si la fecha de la tarea es superior a la fecha del proyecto
                        // en el cual esta siendo creado. Si es mayor no se permite definirla.
                        projectsData projectTask = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                    
                        java.sql.Timestamp dueDate = projectTask.getend_date();
                        if (dueDate == null ||
                                data.getdue_date().after(dueDate)) {
                            // Hay dos casos, o el proyecto tiene una fecha final no definida
                            // o estoy poniendo una fecha final superior a la permitida.
                            String label = java.util.ResourceBundle.getBundle("ApplicationResources",
                                    new Locale(user.getlanguage(), "")).getString("errors.task.noEndDate");

                            String dueDateLabel = "";
                            try {
                                java.text.DateFormat df = java.text.DateFormat.getDateInstance(java.text.DateFormat.MEDIUM);
                                dueDateLabel = df.format(dueDate);
                            } catch (Exception ex) {
                            }

                            if (dueDate == null) {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", label));
                            } else {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", dueDateLabel));
                            }

                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (mapping.findForward("importTasks"));
                        }
                        
                            data.setcreated(today);
                            data.setmodified(today);
                             /*Se inicializan las tareas */
                            data.setstatus(2);
                            data.setmessage(1);
                            data.setpublished("0");
                            data.setowner(thisForm.getowner()); // El owner es el usuario del proyecto
                            data.setreal_due_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            data.setassigned(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            data.setsend_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            data.setreply_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            data.setactual_time(new BigDecimal(0));
                            data.setcompletion(0);
                            data.setowner(user.getid());
                            data.setcollect("1");
                            data.settolerance(0);
                            data.setcomments("N/A");
                            data.setspread_fix(" ");
                            brokerTasks.add(data);
                            
                            tasksStatusLogData tasksSL= new tasksStatusLogData();
                        
                            tasksSL.setId_account(user.getId_account());
                            tasksSL.setMember(user.getid());
                            tasksSL.setStatus(thisForm.getstatus());
                            tasksSL.setTask(data.getid());
                            tasksSL.setCreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                            brokersl.add(tasksSL);
                            
                            if (data.getassigned_to() > 0) {
                            // Si hay una asignacion real, la misma se registra en el historico
                            // de asignaciones
                            assignmentsData assignData = new assignmentsData();
                            assignData.setassigned(data.getcreated());
                            assignData.setassigned_to(data.getassigned_to());
                            assignData.setid(0);
                            assignData.setowner(data.getowner());
                            assignData.settask(data.getid());
                            assignData.setId_account(user.getId_account());
                            assignBroker.add(assignData);
                            
                             // Se extrae de la sesion el loginData
                                loginData login = (loginData) session.getAttribute("login");
                                membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());
                                membersData to_member = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());
                                if (data.getassigned_to()!=0){
                                    //Se enva notificacin al usuario a quien se le asign la tarea            
                                    sm.send("taskassignment", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                // Adicionalmente se le envia al duenno del proyecto.
                                membersData to_owner = (membersData) memBroker.getData(data.getparentProject().getowner(), user.getId_account());
                               if (to_owner.getid() != to_member.getid()) {
                                    // Evitamos enviarle dobles emails.
                                    sm.send("taskassignment", from_member, to_owner, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                               }
                                
                        }
                    }
                        Dir = "&nbsp;<a href='./projects.do?operation=view&id=" + data.getid() + "'>" + data.getname() +
                                    "</a>&nbsp;/&nbsp;";
                    
                    // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart")  );
                   
                        session.setAttribute("proy_task", String.valueOf(data.getproject()));
                        
                        projBroker.close();
                        assignBroker.close();
                        brokersl.close();
                        brokerTasks.close();
                        thisForm.setid(data.getproject());
                        thisForm.setOperation("view");
                        return (mapping.findForward("viewProject"));
                        //return (mapping.findForward("viewProject"));
                    }     
                }else if (action.equals("reportDetail")) {
                    // Se trata del reporte detallado de gastos de un proyecto
                    buildDetailReport(request, thisForm.getid(), brokerTasks, costBroker, user.getId_account());

                    // Se agrega el link para el menu con la ruta
                    projectsData data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "&nbsp;" + data.getname());

                    request.setAttribute("company", company);
                    return (mapping.findForward("displayDetailReport"));

                } else if (action.equals("reportFile")) {
                    // Se trata del reporte de los archivos ligados a las tareas de este proyecto
                    // Se agrega el link para el menu con la ruta
                    projectsData data = (projectsData) projBroker.getData(thisForm.getid(), user.getId_account());

                    // Traemos todas las tareas asociadas a este proyecto que esten iniciadas y terminadas
                   // Iterator e = brokerTasks.getEndedStartedListByProject(thisForm.getid(), user.getId_account());
                    Iterator e = brokerTasks.getListByProject(thisForm.getid(), user.getId_account());
                    
                    tasksData task;
                    ArrayList filesList = new ArrayList();
                    while (e.hasNext()) {
                        task = (tasksData) e.next();
                        // Se traen todos los archivos ligados
                        Vector files = task.getfilesList();

                        filesList.addAll(files);
                    }

                    java.util.Collections.sort(filesList);
                    request.setAttribute("listFiles", filesList);


                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources",
                            new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "&nbsp;" + data.getname());

                    request.setAttribute("company", company);
                    return (mapping.findForward("displayDetailFiles"));

                } else if (action.equals("sortAll")) {

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");

                    if (request.getParameter("typeOp") != null) {
                        thisForm.setTypeProject(Integer.parseInt(request.getParameter("typeOp").toString()));
                    }

                    Iterator e;

                    if (thisForm.getTypeProject() == 0) {
                        e = projBroker.getListByMemberProject(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                user.getid(), 0, user.getprofile(), user.getId_account());
                    } else {
                        e = projBroker.getListByMember(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                user.getid(), 0, user.getprofile(), user.getId_account(), thisForm.getTypeProject());
                    }

                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();

                    projectsData data = new projectsData();
                    statisticsData statistics = new statisticsData();

                    while (e.hasNext()) {

                        data = (projectsData) e.next();

                        statistics = (statisticsData) brokerTasks.getTotalTasksByProjectStatistics(data.getid());
                        // Total de tareas por projecto.
                        data.settotalprojecttasks(statistics.gettotaltasks());

                        // Total de tareas assignadas por proyecto
                        data.settotalassignedprojecttasks(statistics.gettotalassignedtasks());
                        data.settotalnotassignedprojecttasks(statistics.gettotalnotassignedtasks());

                        //Total de tareas a tiempo por projecto
                        data.settotalontimeprojecttasks(statistics.gettotalontimetasks());
                        data.settotaldelayedprojecttasks(statistics.gettotaldelayedtasks());

                        // Otros totales
                        data.settotalrejectedprojecttasks(statistics.gettotalrejectedtasks());
                        data.settotalsuspendedprojecttasks(statistics.gettotalsuspendedtasks());
                        data.settotalendedprojecttasks(statistics.gettotalendedtasks());

                        // Se agrega a la lista de tareas
                        lista.add(data);

                    }

                    request.setAttribute("listProjects", lista);

                    // Negamos el tipo de ordenamiento                    
                    if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                        thisForm.setsortOrder("DESC");
                    } else {
                        thisForm.setsortOrder("ASC");
                    }

                    request.setAttribute("company", company);
                    // Se regresa el form con la lista completa.
                    return (mapping.findForward("displayAll"));

                } else if (action.equals("sortAllUser")) {
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");

                    Iterator e;
                    e = projBroker.getListByOwner(thisForm.getsortColumn(),
                            thisForm.getsortOrder(),
                            thisForm.getowner(), 0, user.getId_account());

                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();

                    projectsData data = new projectsData();
                    statisticsData statistics = new statisticsData();

                    while (e.hasNext()) {

                        data = (projectsData) e.next();

                        statistics = (statisticsData) brokerTasks.getTotalTasksByProjectStatistics(data.getid());
                        // Total de tareas por projecto.
                        data.settotalprojecttasks(statistics.gettotaltasks());

                        // Total de tareas assignadas por proyecto
                        data.settotalassignedprojecttasks(statistics.gettotalassignedtasks());
                        data.settotalnotassignedprojecttasks(statistics.gettotalnotassignedtasks());

                        //Total de tareas a tiempo por projecto
                        data.settotalontimeprojecttasks(statistics.gettotalontimetasks());
                        data.settotaldelayedprojecttasks(statistics.gettotaldelayedtasks());

                        // Otros totales
                        data.settotalrejectedprojecttasks(statistics.gettotalrejectedtasks());
                        data.settotalsuspendedprojecttasks(statistics.gettotalsuspendedtasks());
                        data.settotalendedprojecttasks(statistics.gettotalendedtasks());

                        // Se agrega a la lista de tareas
                        lista.add(data);

                    }

                    request.setAttribute("listProjects", lista);

                    // Negamos el tipo de ordenamiento
                    if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                        thisForm.setsortOrder("DESC");
                    } else {
                        thisForm.setsortOrder("ASC");
                    }
        // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                
                typetasksBroker.close();
                    request.setAttribute("company", company);
                    // Se regresa el form con la lista completa.
                    return (mapping.findForward("displayAll"));

                } else if (action.equals("applyMove")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado                    
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";

                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }
                    ArrayList items = projBroker.getItems(fields, user.getId_account());

                    // Se toma la referencia del proyecto al cual se quiere trasladar
                    int idNewProject = Integer.parseInt(request.getParameter("project"));

                    // Se procede con el traslado de cada una de ellas.
                    projectsData dataMove = new projectsData();
                    projectsData data2 = (projectsData) projBroker.getData(idNewProject, user.getId_account());

                    for (int i = 0; i < items.size(); i++) {
                        dataMove = (projectsData) items.get(i);
                        dataMove.setProject_id(idNewProject);
                        dataMove.setSec_projects(data2.getSec_projects() + "-" + dataMove.getid() + "-");
                        projBroker.update(dataMove);
                    }
                // We update the object in the DBMS

                } else if (action.equals("applyMoveProj")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado                    
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";

                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }
                    ArrayList items = projBroker.getItems(fields, user.getId_account());

                    // Se toma la referencia del proyecto al cual se quiere trasladar
                    int idNewProject = Integer.parseInt(request.getParameter("project"));
                    // Se procede con el traslado de cada una de ellas.
                    projectsData dataMove = new projectsData();
                    projectsData data2 = (projectsData) projBroker.getData(idNewProject, user.getId_account());

                    for (int i = 0; i < items.size(); i++) {
                        dataMove = (projectsData) items.get(i);
                        dataMove.setProject_id(idNewProject);
                        dataMove.setSec_projects(data2.getSec_projects() + "-" + dataMove.getid() + "-");
                        projBroker.update(dataMove);
                    }
                // We update the object in the DBMS

                } else if (action.equals("applyCreate")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado                    
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";

                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }
                    ArrayList items = projBroker.getItems(fields, user.getId_account());

                    // Se toma la referencia del proyecto al cual se quiere trasladar
                    int idNewProject = Integer.parseInt(request.getParameter("project"));

                    // Se procede con el traslado de cada una de ellas.
                    projectsData dataMove = new projectsData();
                    for (int i = 0; i < items.size(); i++) {
                        dataMove = (projectsData) items.get(i);
                        dataMove.setProject_id(0);
                        dataMove.setSec_projects("-" + String.valueOf(dataMove.getid()) + "-");
                        projBroker.update(dataMove);
                    }
                // We update the object in the DBMS

                } else if (action.equals("sortAllOrg")) {

                    if (request.getParameter("typeOp") != null) {
                        thisForm.setTypeProject(Integer.parseInt(request.getParameter("typeOp").toString()));
                    }

                    if (request.getParameter("organization") != null) {
                        thisForm.setorganization(Integer.parseInt(request.getParameter("organization").toString()));
                    }


                    organizationsData dataOrg = (organizationsData) orgBroker.getData(thisForm.getorganization(), user.getId_account());
                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "<a href='./organizations.do?operation=listing'>" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.ClientOrganizations") + "</a>&nbsp;/" +
                            dataOrg.getname() + "</a>");


                    Iterator e;

                    if (thisForm.getTypeProject() == 0) {
                        e = projBroker.getListByOrganization(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                thisForm.getorganization(), 0, user.getId_account());
                    } else {
                        e = projBroker.getListByOrganization(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                thisForm.getorganization(), 0, user.getId_account(), thisForm.getTypeProject());
                    }

                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();

                    projectsData data = new projectsData();
                    statisticsData statistics = new statisticsData();

                    while (e.hasNext()) {

                        data = (projectsData) e.next();

                        statistics = (statisticsData) brokerTasks.getTotalTasksByProjectStatistics(data.getid());
                        // Total de tareas por projecto.
                        data.settotalprojecttasks(statistics.gettotaltasks());

                        // Total de tareas assignadas por proyecto
                        data.settotalassignedprojecttasks(statistics.gettotalassignedtasks());
                        data.settotalnotassignedprojecttasks(statistics.gettotalnotassignedtasks());

                        //Total de tareas a tiempo por projecto
                        data.settotalontimeprojecttasks(statistics.gettotalontimetasks());
                        data.settotaldelayedprojecttasks(statistics.gettotaldelayedtasks());

                        // Otros totales
                        data.settotalrejectedprojecttasks(statistics.gettotalrejectedtasks());
                        data.settotalsuspendedprojecttasks(statistics.gettotalsuspendedtasks());
                        data.settotalendedprojecttasks(statistics.gettotalendedtasks());

                        // Se agrega a la lista de tareas
                        lista.add(data);

                    }

                    request.setAttribute("listProjects", lista);

                    // Negamos el tipo de ordenamiento                    
                    if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                        thisForm.setsortOrder("DESC");
                    } else {
                        thisForm.setsortOrder("ASC");
                    }
           // Se cierran todos los brokers abiertos.
                projBroker.close();
                orgBroker.close();
                memBroker.close();
                brokerTasks.close();
                brokerTopics.close();
                brokerTeams.close();
                fileBroker.close();
                costBroker.close();
                brokerSchedule.close();
                riskBroker.close();
                typetasksBroker.close();
                    request.setAttribute("company", company);
                    // Se regresa el form con la lista completa.
                    return (mapping.findForward("displayAllOrg"));

                }
            } catch (Exception e) {
                servlet.log("[ERROR] Action at final catch: " + e.getMessage());
                e.printStackTrace();
                logger.logp(Level.SEVERE, "projects.do", "perform",
                        "Fatal Error: " + e.toString());
            } finally {
                // Se cierran todos los brokers abiertos.
                brokersl.close();
                riskBroker.close();
                riskBroker = null;
                costBroker.close();
                costBroker = null;
                orgBroker.close();
                orgBroker = null;
                memBroker.close();
                memBroker = null;
                brokerTasks.close();
                brokerTasks = null;
                brokerTopics.close();
                brokerTopics = null;
                brokerTeams.close();
                brokerTeams = null;
                fileBroker.close();
                fileBroker = null;
                brokerSchedule.close();
                brokerSchedule = null;
                projBroker.close();
                projBroker = null;
                assignBroker.close();
                typetasksBroker.close();
            }
        }
        request.setAttribute("company", company);
        // Default if everthing else fails
        return (mapping.findForward("listing"));
    }

    // Retorna la lista de organizaciones
    private ArrayList getListing(MainBroker broker, String sortCol, String sortOrder, int accountId) {
        Iterator e;
        // Se obtiene el iterador sobre todos los elementos de la lista.

        if (sortCol.equals("")) {
            e = broker.getList(accountId);
        } else {
            e = broker.getList(sortCol, sortOrder, accountId);
        }

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        return lista;
    }

    private ArrayList getListingProy(MainBroker broker, String sortCol, String sortOrder, int accountId) {
        Iterator e;
        // Se obtiene el iterador sobre todos los elementos de la lista.

        if (sortCol.equals("")) {
            e = broker.getList(accountId);
        } else {
            e = broker.getList(sortCol, sortOrder, accountId);
        }

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }
        return lista;
    }

    //////////////////////////////////////////////
    // Mtodo que se encarga de ordernar las tareas dispuestos.
    private void sortSubProjects(HttpServletRequest request, projectsForm thisForm, projectsBroker brokerProj, int idAccount) {
        // Traer los valores para desplegar la lista de tareas disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getPageSubProj();

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("projects")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setPageSubProj(1);
            }
        }

        Iterator e = brokerProj.getListSubProj(thisForm.getid(), thisForm.getTypeProject(), currentPage, idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        // Se retorna la lista de las tareas de este proyecto nada mas.
        request.setAttribute("listSubProj", lista);

        // Se setea el total de paginas
        setPages(brokerProj, request, "listSubProjTasks");


        if (thisForm.getsource().equalsIgnoreCase("projects") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getSortOrderSubProj().equalsIgnoreCase("ASC")) {
                thisForm.setSortOrderSubProj("DESC");
            } else {
                thisForm.setSortOrderSubProj("ASC");
            }
        }
    }

    //////////////////////////////////
    // Método que se encarga de ordernar las tareas dispuestos.
    private void sortTasks(HttpServletRequest request, projectsForm thisForm, tasksBroker brokerTasks, int idAccount) {
        // Traer los valores para desplegar la lista de tareas disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageTasks();
        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("tasks")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageTasks(1);
            }
        }
        /* MODIFICACION PARA AGREGAR TIPOS EN EL LISTADO DE LAS TAREAS*/

        Iterator e = brokerTasks.getListByProjectByType(thisForm.getsortColumnTasks(),
                thisForm.getsortOrderTasks(),
                thisForm.getid(), currentPage, thisForm.gettypeTask(), idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        // Se retorna la lista de las tareas de este proyecto nada mas.
        request.setAttribute("listTasks", lista);

        // Se setea el total de paginas
        setPages(brokerTasks, request, "listPagesTasks");

        if (thisForm.getsource().equalsIgnoreCase("tasks") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderTasks().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderTasks("DESC");
            } else {
                thisForm.setsortOrderTasks("ASC");
            }
        }
        brokerTasks.close();
    }

    // Método que se encarga de ordernar las topics dispuestos.
    private void sortTopics(HttpServletRequest request, projectsForm thisForm, topicsBroker brokerTopics, String timeZone, int idAccount) {
        // Traer los valores para desplegar la lista de topics disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageTopics();


        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("topics")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageTopics(1);
            }
        }

        Iterator e = brokerTopics.getListByProjectByStatus(thisForm.getsortColumnTopics(),
                thisForm.getsortOrderTopics(),
                thisForm.getid(), currentPage, thisForm.gettypeTopic(), idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        topicsData topicData = new topicsData();
        while (e.hasNext()) {
            topicData = (topicsData) e.next();
            topicData.setlast_post(Timestamp.valueOf(topicData.convTimeZone(topicData.getlast_post(), timeZone)));
            lista.add(topicData);
            
        }

        request.setAttribute("listTopics", lista);

        // Se setea el total de paginas
        setPages(brokerTopics, request, "listPagesTopics");

        if (thisForm.getsource().equalsIgnoreCase("topics") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderTopics().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderTopics("DESC");
            } else {
                thisForm.setsortOrderTopics("ASC");
            }
        }
        brokerTopics.close();
    }

    // Método que se encarga de ordernar las Teams dispuestos.
    private void sortTeams(HttpServletRequest request, projectsForm thisForm, teamsBroker brokerTeams, int idAccount) {
        // Traer los valores para desplegar la lista de Teams disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageTeams();


        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("teams")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageTeams(1);
            }
        }
        Iterator e = brokerTeams.getListByProject(thisForm.getsortColumnTeams(),
                thisForm.getsortOrderTeams(),
                thisForm.getid(),
                currentPage, idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        request.setAttribute("list_teams", lista);

        // Se setea el total de paginas
        setPages(brokerTeams, request, "listPagesTeams");

        if (thisForm.getsource().equalsIgnoreCase("teams") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderTeams().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderTeams("DESC");
            } else {
                thisForm.setsortOrderTeams("ASC");
            }
        }
    }

    // Método que se encarga de ordernar los riesgos dispuestos.
    private void sortRisks(HttpServletRequest request, projectsForm thisForm, risksBroker riskBroker, int idAccount) {
        // Traer los valores para desplegar la lista de riesgo disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageRisks();

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("risks")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageRisks(1);
            }
        }
        Iterator e = riskBroker.getListByProject(thisForm.getsortColumnRisks(),
                thisForm.getsortOrderRisks(),
                thisForm.getid(),
                currentPage, idAccount);
        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        risksData data = new risksData();
        tasksBroker taskBroker = new tasksBroker();
        while (e.hasNext()) {
            data = (risksData) e.next();
            if (data.gettask() == 0) {
                data.settaskdesc("");
            } else {
                data.settaskdesc(((tasksData) taskBroker.getData(data.gettask(), idAccount)).getname());
            }

            lista.add(data);
        }
        taskBroker.close();

        request.setAttribute("listrisks", lista);
        // Se setea el total de paginas
        setPages(riskBroker, request, "listPagesRisks");
        if (thisForm.getsource().equalsIgnoreCase("risks") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderRisks().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderRisks("DESC");
            } else {
                thisForm.setsortOrderRisks("ASC");
            }
        }
        riskBroker.close();
    }

    // Metodo que se encarga de ordernar los files dispuestos.
    private void sortFiles(HttpServletRequest request, projectsForm thisForm, filesBroker fileBroker, String timeZone, int idAccount) {
        // Traer los valores para desplegar la lista de files disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageFiles();
        if (thisForm.getpageFiles() == 0)
            currentPage=1;

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("files")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageFiles(1);
            }
        }
        Iterator e;

        e = fileBroker.getListByProject(thisForm.getsortColumnFiles(),
                thisForm.getsortOrderFiles(),
                thisForm.getid(), currentPage, idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        filesData fileData = new filesData();
        int counter=1;
        while (e.hasNext()) {
            fileData = new filesData();
            fileData = (filesData) e.next();
           //if (fileData.gettask()==0 && fileData.gettopic()==0){
                fileData.setupload(Timestamp.valueOf(fileData.convTimeZone(fileData.getupload(), timeZone)));
                fileData.setdate(Timestamp.valueOf(fileData.convTimeZone(fileData.getdate(), timeZone)));
                lista.add(fileData);
            //}
            counter++;
        }
        // Se guarda la lista de files asociados a esta tarea.
        request.setAttribute("listFiles", lista);

        // Se setea el total de paginas
        setPages(fileBroker, request, "listPagesFiles");

        if (thisForm.getsource().equalsIgnoreCase("files") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderFiles().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderFiles("DESC");
            } else {
                thisForm.setsortOrderFiles("ASC");
            }
        }
        fileBroker.close();
    }

    // Metodo que se encarga de ordernar los costos dispuestos.
    private void sortCosts(HttpServletRequest request, projectsForm thisForm, costsBroker costBroker, int idAccount) {
        // Traer los valores para desplegar la lista de costos disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageCosts();

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1
        if (thisForm.getsource().equalsIgnoreCase("costs")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageCosts(1);
            }
        }
        Iterator e;

        e = costBroker.getListByProject(thisForm.getsortColumnCosts(),
                thisForm.getsortOrderCosts(),
                thisForm.getid(), currentPage, idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }
        // Se guarda la lista de files asociados a esta tarea.
        request.setAttribute("listCosts", lista);

        // Se setea el total de paginas
        setPages(costBroker, request, "listPagesCosts");

        if (thisForm.getsource().equalsIgnoreCase("costs") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderCosts().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderCosts("DESC");
            } else {
                thisForm.setsortOrderCosts("ASC");
            }
        }
        costBroker.close();
    }

    // Metodo que se encarga de dejar en el context una lista de todas las paginas
    // necesarias para dar cabida a los datos del ultimo comando de sql ejecutado.
    private void setPages(MainBroker broker, HttpServletRequest request,
            String listName) {
        // Se guarda el total de pàginas en el contexto.
        ArrayList listaPages = new ArrayList();

        // Se obtiene el total de registros reales de la ultima consulta.
        int max = broker.getCount().intValue();


        int totalPage = max / MainBroker.GAP_SIZE;
        if ((max % MainBroker.GAP_SIZE) > 0) {
            totalPage++;
        }

        for (int i = 1; i <= totalPage; i++) {
            listaPages.add(new Integer(i));
        }

        request.setAttribute(listName, listaPages);
    }

    // Metodo que se encarga de crear el reporte de costos asociados a un proyecto dado
    // Para ello extrae todas las tareas y costos miscelaneos.
    private void buildDetailReport(HttpServletRequest request, int idProject, tasksBroker brokerTasks, costsBroker costBroker, int idAccount) {

        //-----------------------------------------------------------------
        //              PASO #1. EXTRAER TODAS LAS TAREAS.
        //-----------------------------------------------------------------
        Iterator e = brokerTasks.getListByProject("name", "ASC", idProject, 0, idAccount);

        // Tomo la lista y la paso a un arrayList
        ArrayList lista = new ArrayList();
        tasksData data;
        BigDecimal horasEstimadas = new BigDecimal(0);
        BigDecimal horasReales = new BigDecimal(0);
        BigDecimal costoTotalEstimado = new BigDecimal(0);
        BigDecimal costoTotalReal = new BigDecimal(0);
        BigDecimal costoProyectoProyectado = new BigDecimal(0);
        BigDecimal costoProyectoActual = new BigDecimal(0);
        BigDecimal costoProyectoReal = new BigDecimal(0);

        String[] split_min = null;
        String replace_min = "";

        BigDecimal hour = new BigDecimal(0);
        BigDecimal min = new BigDecimal(0);

        BigDecimal hourEstim = new BigDecimal(0);
        BigDecimal minEstim = new BigDecimal(0);

        boolean band = false;
        while (e.hasNext()) {
            data = (tasksData) e.next();
            lista.add(data);
            // Se incrementan las variables de control
            //horasEstimadas = horasEstimadas.add(data.getestimated_time());

            /*Se splitea el tiempo estimado para poder sumar los valores de los minutos                                    
            begin 
             */
            System.out.println(" antes getestimated_time");
            System.out.println(data.getestimated_time());
            System.out.println(horasEstimadas);
            if (data.getestimated_time().toString().replace('.', ',').split(",").length > 1) {
                split_min = null;
                replace_min = data.getestimated_time().toString().replace('.', ',');
                split_min = replace_min.split(",");
                hour = new BigDecimal(split_min[0].toString());
                min = new BigDecimal(split_min[1].toString());
                if (split_min[1].toString().length() == 1) {
                    min = min.multiply(new BigDecimal(10));
                }
                if (horasEstimadas.toString().replace('.', ',').split(",").length > 1) {
                    replace_min = horasEstimadas.toString().replace('.', ',');
                    split_min = replace_min.split(",");

                    hourEstim = new BigDecimal(split_min[0].toString());
                    minEstim = new BigDecimal(split_min[1].toString());
                    hour = hour.add(hourEstim);
                    min = min.add(minEstim);
                    split_min = null;
                    replace_min = "";
                    band = false;
                    while (!band) {
                        if (min.compareTo(new BigDecimal("59")) == 1) {
                            min = min.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                            replace_min = min.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            hour = hour.add(new BigDecimal(split_min[0]));
                            min = new BigDecimal("0." + split_min[1]);
                            min = min.multiply(new BigDecimal("60"));
                            if (min.toString().replace('.', ',').split(",").length > 1) {
                                replace_min = min.toString().replace('.', ',');
                                split_min = replace_min.split(",");
                                min = new BigDecimal(split_min[0]);
                            }
                        } else {
                            band = true;
                        }
                    }
                    if (min.toString().length() == 1) {
                        horasEstimadas = new BigDecimal(hour.toString() + ".0" + min.toString());
                    } else {
                        horasEstimadas = new BigDecimal(hour.toString() + "." + min.toString());
                    }
                } else {
                    if (min.toString().length() == 1) {
                        horasEstimadas = horasEstimadas.add(new BigDecimal(hour.toString() + ".0" + min.toString()));
                    } else {
                        horasEstimadas = horasEstimadas.add(new BigDecimal(hour.toString() + "." + min.toString()));
                    }
                }
            } else {
                horasEstimadas = horasEstimadas.add(data.getestimated_time());
            }

            System.out.println("despues getestimated_time");
            System.out.println(horasEstimadas);
            /*end*/

            //horasReales = horasReales.add(data.getactual_time());
              /*Se splitea el tiempo actual para poder sumar los valores de los minutos                                    
            begin 
             */
            System.out.println(" antes getactual_time");
            System.out.println(data.getactual_time());
            System.out.println(horasReales);
            if (data.getactual_time().toString().replace('.', ',').split(",").length > 1) {
                split_min = null;
                replace_min = data.getactual_time().toString().replace('.', ',');
                split_min = replace_min.split(",");
                hour = new BigDecimal(split_min[0].toString());
                min = new BigDecimal(split_min[1].toString());
                if (split_min[1].toString().length() == 1) {
                    min = min.multiply(new BigDecimal(10));
                }
                if (horasReales.toString().replace('.', ',').split(",").length > 1) {
                    replace_min = horasReales.toString().replace('.', ',');
                    split_min = replace_min.split(",");

                    hourEstim = new BigDecimal(split_min[0].toString());
                    minEstim = new BigDecimal(split_min[1].toString());
                    hour = hour.add(hourEstim);
                    min = min.add(minEstim);
                    split_min = null;
                    replace_min = "";
                    band = false;
                    while (!band) {
                        if (min.compareTo(new BigDecimal("59")) == 1) {
                            min = min.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                            replace_min = min.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            hour = hour.add(new BigDecimal(split_min[0]));
                            min = new BigDecimal("0." + split_min[1]);
                            min = min.multiply(new BigDecimal("60"));
                            if (min.toString().replace('.', ',').split(",").length > 1) {
                                replace_min = min.toString().replace('.', ',');
                                split_min = replace_min.split(",");
                                min = new BigDecimal(split_min[0]);
                            }
                        } else {
                            band = true;
                        }
                    }
                    if (min.toString().length() == 1) {
                        horasReales = new BigDecimal(hour.toString() + ".0" + min.toString());
                    } else {
                        horasReales = new BigDecimal(hour.toString() + "." + min.toString());
                    }
                } else {
                    if (min.toString().length() == 1) {
                        horasReales = horasReales.add(new BigDecimal(hour.toString() + ".0" + min.toString()));
                    } else {
                        horasReales = horasReales.add(new BigDecimal(hour.toString() + "." + min.toString()));
                    }
                }
            } else {
                horasReales = horasReales.add(data.getactual_time());
            }

            System.out.println("despues getactual_time");
            System.out.println(horasReales);
            /*end*/
            costoTotalEstimado = costoTotalEstimado.add(data.getEstimatedCost());
            costoTotalReal = costoTotalReal.add(data.getRealCost());

            // Costos generales en el proyecto
            costoProyectoProyectado = costoProyectoProyectado.add(data.getEstimatedCost());
            costoProyectoReal = costoProyectoReal.add(data.getRealCost());

            // El actual es de solo las tareas finalizadas.
            if (data.getstatus() == 0 || data.getstatus() == 1) {
                costoProyectoActual = costoProyectoActual.add(data.getRealCost());
            }
        }

        DecimalFormat n = new DecimalFormat("###,###,###,##0.00");

        request.setAttribute("listTasks", lista);
        request.setAttribute("totalHorasEstimadas", horasEstimadas.toString().replace('.', ':'));
        request.setAttribute("totalHorasReales", horasReales.toString().replace('.', ':'));
        request.setAttribute("costoTotalEstimado", n.format(costoTotalEstimado.doubleValue()));
        request.setAttribute("costoTotalReal", n.format(costoTotalReal.doubleValue()));

        //-----------------------------------------------------------------
        //              PASO #2. EXTRAER TODAS LOS COSTOS.
        //-----------------------------------------------------------------
        e = costBroker.getListByProject("units", "DESC", idProject, 0, idAccount);

        BigDecimal costosSumReal = new BigDecimal(0);
        BigDecimal costosSumEstandard = new BigDecimal(0);
        BigDecimal temp = new BigDecimal(0);
        // Tomo la lista y la paso a un arrayList
        lista = new ArrayList();
        costsData cost;
        while (e.hasNext()) {
            cost = (costsData) e.next();
            lista.add(cost);

            // Se calcula el precio estandar
            temp = cost.getStandard_Cost().multiply(new BigDecimal(cost.getUnits()));
            costosSumEstandard = costosSumEstandard.add(temp);

            // Costos generales en el proyecto
            costoProyectoProyectado = costoProyectoProyectado.add(temp);

            // Se calcula el precio real.
            temp = cost.getReal_Cost().multiply(new BigDecimal(cost.getUnits()));
            costosSumReal = costosSumReal.add(temp);

            // Costos generales en el proyecto
            costoProyectoReal = costoProyectoReal.add(temp);
            costoProyectoActual = costoProyectoActual.add(temp);

        }

        request.setAttribute("listCosts", lista);
        request.setAttribute("costosSumEstandard", n.format(costosSumEstandard.doubleValue()));
        request.setAttribute("costosSumReal", n.format(costosSumReal.doubleValue()));

        // Sumario de todo el proyecto
        request.setAttribute("costoProyectoProyectado", n.format(costoProyectoProyectado.doubleValue()));
        request.setAttribute("costoProyectoActual", n.format(costoProyectoActual.doubleValue()));
        request.setAttribute("costoProyectoReal", n.format(costoProyectoReal.doubleValue()));

    }

    public java.math.BigDecimal addTime(BigDecimal time, BigDecimal tot) {
        BigDecimal salida = new BigDecimal(0);
        // Para evitar una division por 0
        if (time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0 ||
                time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0) {
            salida = tot;
        } else {
            BigDecimal hour = new BigDecimal(0);
            BigDecimal min = new BigDecimal(0);
            BigDecimal hourtot = new BigDecimal(0);
            BigDecimal mintot = new BigDecimal(0);
            String value1 = null;
            String value2 = null;
            if (time.toString().replace('.', ',').split(",").length > 1) {
                String[] split_min = null;
                String[] split_mintot = null;
                String replace_min = time.toString().replace('.', ',');
                split_min = replace_min.split(",");
                hour = new BigDecimal(split_min[0]);
                min = new BigDecimal(split_min[1]);
                if (split_min[1].toString().length() == 1) {
                    min = min.multiply(new BigDecimal(10));
                } else {
                    value1 = split_min[1].toString();
                    value2 = "0" + min;
                }

                if (tot.toString().replace('.', ',').split(",").length > 1) {
                    String replace_mintot = tot.toString().replace('.', ',');
                    split_mintot = replace_mintot.split(",");
                    hourtot = new BigDecimal(split_mintot[0]);
                    mintot = new BigDecimal(split_mintot[1]);
                    if (split_mintot[1].toString().length() == 1) {
                        mintot = mintot.multiply(new BigDecimal(10));
                    }
                }

                min = min.add(mintot);
                hour = hour.add(hourtot);

                boolean band = false;
                while (!band) {

                    if (min.compareTo(new BigDecimal("59")) == 1) {
                        min = min.divide(new BigDecimal(60), 2, BigDecimal.ROUND_UP);
                        replace_min = min.toString().replace('.', ',');
                        split_min = replace_min.split(",");
                        hour = hour.add(new BigDecimal(split_min[0]));
                        min = new BigDecimal("0." + split_min[1]);
                        min = min.multiply(new BigDecimal("60"));
                        if (min.toString().replace('.', ',').split(",").length > 1) {
                            replace_min = min.toString().replace('.', ',');
                            split_min = replace_min.split(",");
                            min = new BigDecimal("0" + split_min[0]);
                        }
                    } else {
                        band = true;
                    }
                }
                /*  if ((value1 != null || value2 != null || "".equals(value1) || "".equals(value2)) && value1.equals(value2)) {
                salida = new BigDecimal(hour + ".0" + min);
                } else {*/
                if (min.toString().length() == 1) {
                    salida = new BigDecimal(hour + ".0" + min);
                } else {
                    salida = new BigDecimal(hour + "." + min);
                }
            //}
            } else {
                salida = tot.add(time);
            }
        }

        return salida;
    }
}
