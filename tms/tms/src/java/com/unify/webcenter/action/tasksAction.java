        /*
 * Generated by Flecha Roja Technologies Auto Generator
 *
 * Created on January 9, 2003, 11:31 AM
 */
package com.unify.webcenter.action;

import java.io.IOException;
import java.util.logging.*;

import java.util.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

import org.apache.struts.action.*;
import org.apache.commons.beanutils.*;

import com.unify.webcenter.data.*;
import com.unify.webcenter.broker.*;
import org.apache.ojb.broker.query.*;
import com.unify.webcenter.form.*;
import com.unify.webcenter.conf.TMSConfigurator;
import com.unify.webcenter.tools.sendMail;
import java.math.BigDecimal;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;

/**
 * <p>This action works with both JSP and Velocity templates.
 * The type of template to be used is defined in the Struts configuration
 * file.</p>
 *
 * <p>The action support an <i>action</i> URL parameter. This URL parameter
 * controls what this action class does. The following values are supported:</p>
 * <ul>
 *   <li>save    Save the record
 *   <li>delete	 Delete the record
 *   <li>edit    Edit the record
 *   <li>show	 Show the record
 * </ul>
 *
 *
 * @author Gerardo Arroyo Arce 
 */
public class tasksAction extends Action {

    private static Logger logger = Logger.getLogger("com.unify");

    /** Creates a new instance of tasksAction */
    public tasksAction() {

    }

    /**
     * Handle server requests.
     *
     * @param mapping The ActionMapping used to select this instance
     * @param actionForm The optional ActionForm bean for this request (if any)
     * @param request The HTTP request we are processing
     * @param response The HTTP response we are creating
     *
     * @exception IOException if an input/output error occurs
     * @exception ServletException if a servlet exception occurs
     */
    public ActionForward execute(ActionMapping mapping,
            ActionForm form,
            HttpServletRequest request,
            HttpServletResponse response)
            throws IOException, ServletException {
        String action;
        HttpSession session;
        tasksBroker taskBroker;
        membersBroker memBroker;
        projectsBroker projBroker;
        filesBroker fileBroker;
        schedulesBroker schBroker;
        assignmentsBroker assignBroker;
        predefined_messagesBroker messageBroker;
        teamsBroker brokerTeams;
        calendarBroker calBroker;
        tasksStatusLogBroker tslBroker;
        type_tasksBroker typetasksBroker;
        schedulesLogBroker schLogBroker;
        String company = null;

        session = request.getSession(false);
        // Si la sesion es nula, se debe redireccionar al login.
        if (session == null || session.getAttribute("login") == null) {

            // forward to display the home page
            String taskid = request.getParameter("id");
            if (taskid != null) {
                session = request.getSession(true);
                session.setAttribute("forwardto", "task");
                session.setAttribute("taskid", taskid);
            }

            return (mapping.findForward("login"));

        } else {
            taskBroker = new tasksBroker();
            memBroker = new membersBroker();
            messageBroker = new predefined_messagesBroker();
            projBroker = new projectsBroker();
            fileBroker = new filesBroker();
            assignBroker = new assignmentsBroker();
            brokerTeams = new teamsBroker();
            schBroker = new schedulesBroker();
            calBroker = new calendarBroker();
            typetasksBroker = new type_tasksBroker();
            tslBroker= new tasksStatusLogBroker();
            schLogBroker= new schedulesLogBroker();
            try {
                if (form == null) {

                    System.out.println(" Creating new tasksForm bean under key " + mapping.getAttribute());
                    form = new tasksForm();
                }

                tasksForm thisForm = (tasksForm) form;


                // Se obtiene la referencia al loginData dentro de la session.
                loginData user = (loginData) session.getAttribute("login");                
                TMSConfigurator tms = new TMSConfigurator(user);
                company = tms.getCompany(user);
                // Intanciar clase para el envio de correo
                com.unify.webcenter.tools.sendMail sm = new com.unify.webcenter.tools.sendMail();


                // fetch action from form
                action = ((tasksForm) form).getOperation();
                ActionErrors errors = new ActionErrors(); 

                System.out.println("ACTION: "+ action);
                servlet.log("[DEBUG] tasksAction at perform(): Action is " + action);

                // Se agrega al contexto la informacion del usuario
                request.setAttribute("userInfo", user);
                   
                if (action.equals("add")) {
                    // En el caso de la operacion add, se despliega el formulario.
                    request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addTask"));
                    thisForm.setOperation("applyAdd");
                    if (request.getParameter("topic2task") != null) {
                        thisForm.settopic(Integer.parseInt(request.getParameter("topic2task")));
                    } else {
                        thisForm.settopic(0);
                    }
                    thisForm.setid(0);
                    thisForm.setowner(user.getid()); // El owner es el usuario logeado
                    thisForm.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    thisForm.setreal_due_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    thisForm.setassigned(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    thisForm.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    thisForm.setsend_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    thisForm.setreply_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    
                    
                    // Si esta tarea que se agrega esta ligada a una discusion, se le
                    // modifica el estado a la discusion enviada y ademas se le indica
                    // cual es la tarea ligada.
                    int topic = thisForm.gettopic2task();

                    if (topic > 0) {
                        // El topico origen es superior a 0, o sea viene de un topico
                        // valido.
                        topicsBroker topBroker = new topicsBroker();
                        topicsData topData = (topicsData) topBroker.getData(topic, user.getId_account());

                        // Se toman los posts y se colocan en el comentario de la tarea
                        Vector v = topData.getdetailPost();
                        postData post;
                        StringBuffer body = new StringBuffer();
                        for (int i = 0; i < v.size(); i++) {
                            post = (postData) v.get(i);
                            body.append(new String(post.getmessage()));
                        }
                        topBroker.close();

                        thisForm.setname(topData.getsubject());
                        thisForm.setdescription(body.toString());
                    }

                    // Se carga el objeto correspondiente al proyecto
                    projectsData projectMember = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());
                    request.setAttribute("assignedProject", projectMember);

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "<a href='./projects.do?operation=view&id=" +
                            projectMember.getid() + "'>" +
                            projectMember.getname() + "</a>&nbsp;/" +
                            "<a href='./projects.do?operation=view&id=" +
                            projectMember.getid() + "'>" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Task") + "</a>&nbsp;/" +
                            "&nbsp;" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.addTask"));

                    //Se define un Calendar.
                    Calendar now = Calendar.getInstance();

                    // Se extrae el componente dia, mes y a?o del start_date
                    request.setAttribute("fecha1", "" + now.get(Calendar.YEAR) +
                            "-" + (now.get(Calendar.MONTH) + 1) +
                            "-" + now.get(Calendar.DAY_OF_MONTH));

                    // Se extrae el componente dia, mes y a?o del due_date
                    request.setAttribute("fecha2", "" + now.get(Calendar.YEAR) +
                            "-" + (now.get(Calendar.MONTH) + 1) +
                            "-" + now.get(Calendar.DAY_OF_MONTH));


                    // Se deben cargar los listados de  Members para los 
                    // combos correspondientes, primeramente a todos los miembros
                    // del equipo que estan asignados.
                    //  teamsBroker brokerTeams = new teamsBroker();
                    Iterator e;

                    // Se extra de la sesion el loginData
                    loginData login = (loginData) session.getAttribute("login");

                    if (projectMember.getowner() == login.getid() ||
                            (login.getprofile().equals("3") || login.getprofile().equals("4"))) {
                        e = brokerTeams.getListByProject("parentMember.name",
                                "ASC",
                                projectMember.getid(),
                                0, user.getId_account());
                    } else {
                        e = brokerTeams.getListByProjectMember("parentMember.name",
                                "ASC",
                                projectMember.getid(),
                                login.getid(), user.getId_account());
                    }
                    brokerTeams.close();

                    ArrayList lista = new ArrayList();

                    // Se extrae el miembro del equipo, a fin de que queden
                    // del mismo tipo
                    teamsData dataTeam;
                    while (e.hasNext()) {
                        dataTeam = (teamsData) e.next();
                        lista.add(dataTeam.getparentMember());
                    }
                    request.setAttribute("listMembers", lista);
                    
                   // Iterator membersList= memBroker.getNonClientMembers("NAME", "ASC", user.getId_account());
                    request.setAttribute("membersList", lista);
                   // Iterator membersList2= memBroker.getNonClientMembers("NAME", "ASC", user.getId_account());
                    request.setAttribute("membersList2", lista);
                    
                    // Se agregan las tareas en caso de que esta tenga predecesores
                    e = taskBroker.getListByProject("name", "DESC",
                            projectMember.getid(), 0, user.getId_account());
                    ArrayList listTasks = new ArrayList();
                    while (e.hasNext()) {
                        listTasks.add(e.next());
                    }
                    // Se agregan al contexto.
                    request.setAttribute("listTasks", listTasks);

                    // Listado de mensajes
                    request.setAttribute("listMessages", getListing(messageBroker, "name", "ASC", user.getId_account(), user.getid()));

                    request.setAttribute("list_type_tasks", getListing(typetasksBroker, "description", "DESC", user.getId_account(), user.getid()));
                    request.setAttribute("company", company);
                    typetasksBroker.close();
                    return (mapping.findForward("displayAddForm"));

                }
                if (action.equals("applyconvert")) {
                    // En el caso de la operacion add, se despliega el formulario.      
                    projectsData data = new projectsData();
                    projectsData projData = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());
                    data.setid(0);
                    data.setId_account(user.getId_account());
                    Calendar calendar = Calendar.getInstance();
                    data.setcreated(new java.sql.Timestamp(calendar.getTimeInMillis()));
                    data.setpublished(thisForm.getpublished());
                    data.setowner(thisForm.getassigned_to());
                  //  data.setstatus(thisForm.getstatus());
                     data.setstatus(getProjectStatus(thisForm.getstatus()));
                    data.setorganization(projData.getorganization());
                    data.setname(thisForm.getname());
                    data.setpriority(thisForm.getpriority());
                    data.setdescription(thisForm.getdescription());
                    data.setupload_max("0");
                    data.setpublished_endtask("0");
                    data.setpublished_assigned("0");
                    data.setProject_id(thisForm.getproject());

                    // data.setorganization(taskBroker.getOrganization(thisForm.getproject()));
                    data.setmodified(thisForm.getmodified());
                    //data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    data.setstart_date(thisForm.getstart_date());
                    data.setend_date(thisForm.getdue_date());
                    //  data.setstart_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    //    data.setend_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                    String auxmonth = "0" + (calendar.get(Calendar.MONTH) + 1);
                    String auxday = "0" + calendar.get(Calendar.DAY_OF_MONTH);

                    if (auxmonth.length() > 2) {
                        auxmonth = auxmonth.substring(1);
                    }
                    if (auxday.length() > 2) {
                        auxday = auxday.substring(1);
                    }

                    // Se extrae el componente dia, mes y a�o del start_date
                    request.setAttribute("fecha1", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);

                    // Se extrae el componente dia, mes y a�o del due_date
                    request.setAttribute("fecha2", "" + calendar.get(Calendar.YEAR) +
                            "-" + auxmonth +
                            "-" + auxday);
                    // We add the new record.
                    projBroker.add(data);
                    data.setSec_projects(projData.getSec_projects() + "-" + String.valueOf(data.getid()) + "-");
                    projBroker.update(data);
                    // Y se auto agrega al equipo
                    teamsData dataNew = new teamsData();
                    dataNew.setid(0);
                    dataNew.setId_account(user.getId_account());
                    dataNew.setauthorized("0");
                    dataNew.setpublished("0");
                    dataNew.setprojects(data.getid());
                    dataNew.setmembers(data.getowner());
                    brokerTeams.add(dataNew);
                    request.setAttribute("company", company);

                    tasksData tasksdata = (tasksData) taskBroker.getData(thisForm.getid(), user.getId_account());
                    tasksdata.setproject(data.getid());
                    taskBroker.update(tasksdata);

                    Iterator fileItera = fileBroker.getList("name", "ASC", thisForm.getid(), 0, user.getId_account());

                    // Se procesa cada archivo, primero creando una entrada nueva 
                    // para esta tarea y despues copiando los files fisicos
                    filesData fileData, fileDataNew;
                    while (fileItera.hasNext()) {
                        fileData = (filesData) fileItera.next();

                        try {
                            // Se toma la direccion del archivo
                            String fileDir = fileData.getPath();

                            fileDataNew = new filesData(fileData);
                            // Se liga el archivo a la tarea
                            fileDataNew.setid(0);  // Nuevo Registro
                            fileDataNew.settopic(0);
                            fileDataNew.setproject(data.getid());
                            // Se agrega el nuevo archivo a la tarea                                    
                            fileBroker.add(fileDataNew);

                            // Ahora se copia de un lado a otro.
                            copyFile(fileDir, fileDataNew.getid() + "-" + fileDataNew.getname(),
                                    data.getid(), thisForm.getid(), user);

                            // Y se borra el puntero original de la tarea a su viejo archivo y ademas
                            // fisicamente.
                            fileBroker.delete(fileData);

                            File theFile = new File(fileData.getPath());
                            theFile.delete();

                        } catch (Exception ex) {
                            System.out.println("Fatal Error: " + ex.toString());
                            logger.logp(Level.SEVERE, "tasks.do", "perform",
                                    "Fatal Error During Topic2Task: " + ex.toString());
                        }
                    }



                    System.out.println("actualizo");
                    System.out.println(thisForm.getproject());
                    session.setAttribute("proy_task", String.valueOf(thisForm.getproject()));
                    return (mapping.findForward("viewProject"));
                } else if (action.equals("copy")) {
                    // Se trata del copy de una tarea determinada.
                    tasksData copyTask = (tasksData) taskBroker.getData(thisForm.getid(), user.getId_account());

                    // Se copia la tarea en cuestion
                    tasksData newTask = new tasksData();
                    newTask.setproject(copyTask.getproject());
                      newTask.setId_account(copyTask.getId_account());
                    newTask.setname("Copy " + copyTask.getname());
                    newTask.setdescription(copyTask.getdescription());
                    newTask.setfare(copyTask.getfare());
                    newTask.setowner(copyTask.getowner());
                    newTask.setpredecessor(copyTask.getpredecessor());
                    newTask.setpredecessor_required(copyTask.getpredecessor_required());
                    newTask.setpriority(copyTask.getpriority());
                    newTask.settolerance(copyTask.gettolerance());
                    newTask.setassigned_to(0);
                    newTask.setactual_time(new java.math.BigDecimal(0));
                    newTask.setcompletion(0);
                    newTask.setpublished("0");
                    newTask.setstatus(2);
                    newTask.settopic(copyTask.gettopic());
                    java.sql.Timestamp today = new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis());
                    newTask.setstart_date(today);
                    newTask.setdue_date(copyTask.getdue_date());
                    newTask.setreply_quotation_date(today);
                    newTask.setsend_quotation_date(today);
                    newTask.setreal_due_date(today);
                    newTask.setestimated_time(copyTask.getestimated_time());
                    newTask.setcomments(copyTask.getcomments());
                    newTask.setcollect(copyTask.getcollect());
                    newTask.setmessage(copyTask.getmessage());
                    newTask.setcreated(today);
                    newTask.setmodified(today);
                    newTask.setassigned(today);
                    newTask.setspread_fix(" ");

 
                    taskBroker.add(newTask);

                    // if el source es home
                    if (thisForm.getfromPage().equals("home")) {
                        request.setAttribute("company", company);
                        return (mapping.findForward("listing"));
                    } else {
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("viewingProjects").
                                getPath() + "?operation=view&id=" + copyTask.getproject()));
                    }


                } else if (action.equals("edit")) {
                    // Si se trata de un edit, se debe de cargar los datos del bean
                    // en el formulario.
                    tasksData data = (tasksData) taskBroker.getData(thisForm.getid(), user.getId_account());
                    data.setdue_date(Timestamp.valueOf(data.convTimeZone(data.getdue_date(), user.getTime_zone())));
                    data.setstart_date(Timestamp.valueOf(data.convTimeZone(data.getstart_date(), user.getTime_zone())));

                    thisForm.setEmailNotifyTQA(data.getEmailNotifyTQA());
                    thisForm.setEmailNotifyFQA(data.getEmailNotifyFQA()); 
                    
                    if (data.getEmailNotifyFQA()!= 0){
                        membersData dataMember = (membersData) memBroker.getData(data.getEmailNotifyFQA(), user.getId_account());
                    
                        // Se carga el objeto correspondiente al miembro que esta asignado
                        request.setAttribute("assignedMember1", dataMember);
                    }
                    
                    if (data.getEmailNotifyTQA()!= 0){
                        membersData dataMember2 = (membersData) memBroker.getData(data.getEmailNotifyTQA(), user.getId_account());
                    
                        // Se carga el objeto correspondiente al miembro que esta asignado
                        request.setAttribute("assignedMember2", dataMember2);
                    }
                            
                    projectsData projectMember = (projectsData) projBroker.getData(data.getproject(), user.getId_account());

                    // Se edita si y solo si soy el dueno o el usuario asignado.
                    // o el admin  Modify Jury 04/06/04                  
                    if (user.getid() == projectMember.getowner() ||
                            user.getid() == data.getassigned_to() ||
                            //user.getid() == 1) {
                            (user.getprofile().equals("3") || user.getprofile().equals("4"))) {
                        // Se verifica que el usuario sea un member, sino, NO tiene acceso.
                        if (brokerTeams.isMember(data.getproject(), user.getid(), user.getId_account()) ||
                                (user.getprofile().equals("3") || user.getprofile().equals("4"))) {
                            //user.getid() == 1) {
                            // We copy all the properties from the form to the bean.

                            // DEST->SOURCE
                            System.out.println("STA bf:" + data.getstatus());
                            PropertyUtils.copyProperties(thisForm, data);

                    thisForm.setFinalizado(0);
                    if ((data.getstatus()==0 || data.getstatus()==1 || data.getstatus()==4 || data.getstatus()==6 || data.getstatus()==7) && user.getprofile().equals("0")) {
                        thisForm.setFinalizado(1);
                    }
                            thisForm.setestimated_time(this.getEstimated_timeHour(data.getestimated_time()));
                            thisForm.setEstimated_time_min(this.getEstimated_timeMinutes(data.getestimated_time()));

                            thisForm.setOperation("applyEdit");

                            membersData dataMember = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());

                            // Se carga el objeto correspondiente al miembro que esta asignado
                            request.setAttribute("assignedMember", dataMember);


                            // Se carga el objeto correspondiente al proyecto                        
                            request.setAttribute("assignedProject", projectMember);
                            request.setAttribute("listMessages",
                                    getListing(messageBroker, "name", "DESC", user.getId_account(), user.getid()));

                            // Se agrega el link para el menu con la ruta
                            request.setAttribute("menuRoute",
                                    "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                    "<a href='./projects.do?operation=view&id=" +
                                    projectMember.getid() + "'>" +
                                    projectMember.getname() + "</a>&nbsp;/" +
                                    "<a href='./projects.do?operation=view&id=" +
                                    projectMember.getid() + "'>" +
                                    java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Task") + "</a>&nbsp;/" +
                                    "<a href='./tasks.do?operation=view&id=" +
                                    data.getid() + "'>" +
                                    data.getname() + "</a>&nbsp;/" +
                                    "&nbsp;" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.editTask"));


                            //Se define un Calendar.
                            Calendar now = Calendar.getInstance();

                            // Se extrae el componente dia, mes y a?o del start_date
                            now.setTime(thisForm.getstart_date());
                            request.setAttribute("fecha1", "" + now.get(Calendar.YEAR) +
                                    "-" + (now.get(Calendar.MONTH) + 1) +
                                    "-" + now.get(Calendar.DAY_OF_MONTH));

                            // Se extrae el componente dia, mes y a?o del due_date
                            now.setTime(thisForm.getdue_date());
                            request.setAttribute("fecha2", "" + now.get(Calendar.YEAR) +
                                    "-" + (now.get(Calendar.MONTH) + 1) +
                                    "-" + now.get(Calendar.DAY_OF_MONTH));

                            // Se extra de la sesion el loginData
                            loginData login = (loginData) session.getAttribute("login");


                            // Se agregan las tareas en caso de que esta tenga predecesores
                            Iterator e = taskBroker.getListByProject("name", "DESC",
                                    projectMember.getid(),
                                    data.getid(), 0);
                            ArrayList listTasks = new ArrayList();
                            while (e.hasNext()) {
                                listTasks.add(e.next());
                            }
                            // Se agregan al contexto.
                            request.setAttribute("listTasks", listTasks);

                            request.setAttribute("list_type_tasks", getListing(typetasksBroker, "description", "ASC", user.getId_account(), user.getid()));

                            request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.editTask"));

                            if (projectMember.getowner() == login.getid() ||
                                    (login.getprofile().equals("3") || login.getprofile().equals("4"))) {
                                //login.getid() == 1) {
                                // Se trata de un usuario que es el due?o del proyecto
                                // Se deben cargar los listados de  Members para los 
                                // combos correspondientes.    

                                e = brokerTeams.getListByProject("id",
                                        "DESC",
                                        projectMember.getid(),
                                        0, user.getId_account());
                            } else {
                                e = brokerTeams.getListByProjectMember("id",
                                        "DESC",
                                        projectMember.getid(),
                                        login.getid(), user.getId_account());
                            }
                            brokerTeams.close();
 
                            ArrayList lista = new ArrayList();
                            // Se extrae el miembro del equipo, a fin de que queden
                            // del mismo tipo
                            teamsData dataTeam;
                            while (e.hasNext()) {
                                dataTeam = (teamsData) e.next();
                                lista.add(dataTeam.getparentMember());
                            }
                            request.setAttribute("listMembers", lista);
                              
                          //  Iterator membersList= memBroker.getList("NAME", "ASC", user.getId_account());
                            request.setAttribute("membersList", lista);
                           // Iterator membersList2= memBroker.getList("NAME", "ASC", user.getId_account());
                            request.setAttribute("membersList2", lista);
                    
                            if (projectMember.getowner() == login.getid() ||
                                    //login.getid() == 1) {
                                    (login.getprofile().equals("3") || login.getprofile().equals("4"))) {
                                request.setAttribute("company", company);
                                return (mapping.findForward("displayEditFormOwner"));
                            } else {
                                request.setAttribute("company", company);
                                // Se trata de un usuario que no es el due?o
                                return (mapping.findForward("displayEditForm"));
                            }
                        } else {
                            // No hay acceso, se redirecciona a una pagina donde se le notifica
                            // de eso.
                            // Se agrega el link para el menu con la ruta
                            request.setAttribute("menuRoute",
                                    "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");
                            request.setAttribute("company", company);
                            return (mapping.findForward("accessDenied"));
                        }
                    } else {
                            System.out.println("STA ULT:" + data.getstatus());
                        // No se puede editar esta tarea.
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");
                        request.setAttribute("company", company);
                        return (mapping.findForward("accessDenied"));
                    }
                } else if (action.equals("view") || action.equals("sort") ||
                        action.equals("paging")) {
                    // Si se trata de un view, se debe de cargar los datos del bean
                    // en el formulario.
                    tasksData data = (tasksData) taskBroker.getData(thisForm.getid(), user.getId_account());

                    String auxRealHours = null;
                    System.out.println(data.getactual_time().toString());
                    String replaceRealHours = data.getactual_time().toString().replace('.', '-');
                    System.out.println(replaceRealHours);
                    String[] splitRealHours = replaceRealHours.split("-");
                    System.out.println(replaceRealHours);
                    if (splitRealHours.length > 1) {
                        if (splitRealHours[1].length() == 1) {
                            auxRealHours = splitRealHours[0].toString() + ":" + splitRealHours[1].toString() + "0";
                        } else {
                            auxRealHours = splitRealHours[0].toString() + ":" + splitRealHours[1].toString();
                        }
                    } else {
                        auxRealHours = splitRealHours[0].toString() + ":00";
                    }
                    request.setAttribute("real_hours", auxRealHours);



                    membersData dataMember = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());

                    projectsData projectMember = (projectsData) projBroker.getData(data.getproject(), user.getId_account());
                    
                    ArrayList listLog= new ArrayList();
                    Iterator e= tslBroker.getListByTasks(thisForm.getid(), user.getId_account(), "DESC");

                        while (e.hasNext()) {
                            listLog.add(e.next());
                        }
                            // Se guarda la bitacora de estados
                    request.setAttribute("listLog", listLog);
                    
                    
                    ArrayList listSchLog= new ArrayList();
                    Iterator e1= schLogBroker.getListByTasks(thisForm.getid(), user.getId_account(), "DESC");

                        while (e1.hasNext()) {
                            listSchLog.add(e1.next());
                        }
                            // Se guarda la bitacora de estados
                    request.setAttribute("listSchLog", listSchLog);
                    
                    // Se verifica que el usuario sea un member, sino, NO tiene acceso.
                    if (brokerTeams.isMember(data.getproject(), user.getid(), user.getId_account()) ||
                            //user.getid() == 1) {
                            (user.getprofile().equals("3") || user.getprofile().equals("4"))) {
                        // Se carga el objeto correspondiente al miembro que esta asignado
                        request.setAttribute("assignedMember", dataMember);

                        // Se carga el objeto correspondiente al proyecto
                        request.setAttribute("assignedProject", projectMember);

                        membersData ownerMember = (membersData) memBroker.getData(data.getowner(), user.getId_account());

                        request.setAttribute("ownerMember", ownerMember);

                        //We convert the date to the specific member timezone
                        data.setcreated(Timestamp.valueOf(data.convTimeZone(data.getcreated(), user.getTime_zone())));
                        data.setmodified(Timestamp.valueOf(data.convTimeZone(data.getmodified(), user.getTime_zone())));
                        data.setassigned(Timestamp.valueOf(data.convTimeZone(data.getassigned(), user.getTime_zone())));
                        data.setstart_date(Timestamp.valueOf(data.convTimeZone(data.getstart_date(), user.getTime_zone())));
                        data.setdue_date(Timestamp.valueOf(data.convTimeZone(data.getdue_date(), user.getTime_zone())));
                        // We copy all the properties from the form to the bean.  
                        PropertyUtils.copyProperties(thisForm, data);
                        
                        
                        membersData qt= new membersData();
                        membersData qf= new membersData();
                        if (data.getEmailNotifyTQA()!= 0){
                            qt=(membersData)memBroker.getData(data.getEmailNotifyTQA());
                        }
                        if (data.getEmailNotifyFQA()!= 0){
                            qf=(membersData)memBroker.getData(data.getEmailNotifyFQA());
                        }
                        
                        if (data.getEmailNotifyFQA()!= 0){
                        request.setAttribute("qf", qf.getname());
                        }else{
                        request.setAttribute("qf", "Sin Asignar");
                        }
                        if (data.getEmailNotifyTQA()!= 0){
                            request.setAttribute("qt", qt.getname());
                        }else{
                            request.setAttribute("qt", "Sin Asignar");
                        }
                        thisForm.setOperation("view");

                        // Se coloca el nombre de la tarea predecesora
                        thisForm.setpredecessorName(((tasksData) taskBroker.getData(data.getpredecessor(), user.getId_account())).getname());
                        /////////////////////////
                        String Dir = null;
                        System.out.println("MEMBER ID");
                        System.out.println(projectMember.getid());

                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                                "<a href='./projects.do?operation=view&id=" +
                                projectMember.getid() + "'>" +
                                projectMember.getname() + "</a>&nbsp;/" +
                                "<a href='./projects.do?operation=view&id=" +
                                projectMember.getid() + "'>" +
                                java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Task") + "</a>&nbsp;/" +
                                "&nbsp;" + data.getname());


                        // Ahora se cargan las lista de files y assigments.
                        sortAssignments(request, thisForm, assignBroker, fileBroker, user.getTime_zone(), user.getId_account());
                        sortFiles(request, thisForm, fileBroker, user.getId_account());
                        request.setAttribute("company", company);
                        return (mapping.findForward("displayViewForm"));
                    } else {
                        // No hay acceso, se redirecciona a una pagina donde se le notifica
                        // de eso.
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");
                        request.setAttribute("company", company);
                        return (mapping.findForward("accessDenied"));
                    }

                } else if (action.equals("delete")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado

                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());


                    if (user.isAdmin() || ((tasksData) items.get(0)).getparentProject().getowner() == user.getid()) {
                        // Solo un usuario administrador, o el dueno del proyecto puede eliminar tareas
                        String param = "";
                        if (request.getParameter("fromPage").equalsIgnoreCase("viewProject")) {
                            param = "" + thisForm.getproject();
                        }

                        request.setAttribute("fromPage", request.getParameter("fromPage"));
                        request.setAttribute("param", "" + param);
                        request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                        request.setAttribute("items", items);
                        request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Task"));
                        request.setAttribute("do", request.getRequestURI());
                        request.setAttribute("company", company);
                        // forward to display the list 
                        return (mapping.findForward("confirmDelete"));
                    } else {
                        // No hay acceso, se redirecciona a una pagina donde se le notifica
                        // de eso.
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources",
                                new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");
                        request.setAttribute("company", company);
                        return (mapping.findForward("deleteDenied"));
                    }

                } else if (action.equals("applyDelete")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado                    
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";
                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());

                    // Se procede con el borrado de cada una de ellas.
                    tasksData dataDelete;
                    for (int i = 0; i < items.size(); i++) {
                        dataDelete = (tasksData) items.get(i);
                        assignBroker.deleteAssignments(dataDelete.getowner(), dataDelete.getid(), dataDelete.getId_account());
                        schLogBroker.deleteAllReferencesbyTask(dataDelete.getid(), dataDelete.getId_account());
                        schBroker.deleteAllReferencesByTask(dataDelete.getid(), dataDelete.getId_account());
                        fileBroker.deleteAllReferencesByTask(dataDelete.getid(), dataDelete.getproject(), dataDelete.getId_account());
                        calBroker.deleteAllReferencesbyTask(dataDelete.getid(), dataDelete.getId_account());
                        tslBroker.deleteAllReferencesbyTask(dataDelete.getid(), dataDelete.getId_account());
                        // We delete the object in the DBMS
                        taskBroker.delete(dataDelete);
                    }

                    // if el source es home
                    if (thisForm.getfromPage().equals("home")) {
                        request.setAttribute("company", company);
                        return (mapping.findForward("listing"));
                    } else {
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("viewProject").
                                getPath() + "&id=" + request.getParameter("param"), false));
                    }

                } else if (action.equals("applyAdd")) {
                    // Se validan los datos ingresados
                    errors = thisForm.validate(mapping, request);

                    if (errors.isEmpty()) {
                        // Se trata de la aplicacion de un insert en la BD
                        tasksData data = new tasksData();

                        // We copy all the properties from the form to the bean.
                        PropertyUtils.copyProperties(data, thisForm);
                        data.setId_account(user.getId_account());
                        // Control del manejo de las tareas predecesoras y requeridas
                        if (data.getpredecessor_required().equals("1")) {
                            // La tarea predecesora es requerida, se debe ver si su 
                            // estado es finalizado y si el cliente desea ponerle a 
                            // esta un estado de avance diferente de no iniciada.                            
                            if (data.getstatus() != 2) {
                                // Esta tarea se desea poner en un estado diferente de
                                // NOT STARTED (2). Hay que ver que la tarea predecesora
                                // este en estado (0) Client Ended o (1) Ended
                                tasksData predecesora = (tasksData) taskBroker.getData(data.getpredecessor(), user.getId_account());

                                int stat = predecesora.getstatus();
                                if (stat != 0 && stat != 1) {
                                    // La tarea predecesora NO ha sido concluida,
                                    // no puede cambiar el estado de esta tarea!.                                    
                                    errors.add("predecessorConflict",
                                            new ActionError("errors.task.predecessorNotFinished"));
                                    saveErrors(request, errors);
                                    request.setAttribute("company", company);
                                    return (new ActionForward(mapping.findForward("displayAddEditError").
                                            getPath() + "?operation=add"));

                                }
                            }
                        }

                        if (data.getstart_date().after(data.getdue_date())) {
                            // La fecha final debe ser superior a la inicial 
                            errors.add("DateConflict",
                                    new ActionError("errors.task.dueDateNotsuperior"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=add"));
                        }

                        // Verificamos si la fecha de la tarea es superior a la fecha del proyecto
                        // en el cual esta siendo creado. Si es mayor no se permite definirla.
                        projectsData projectTask = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());
                        java.sql.Timestamp dueDate = projectTask.getend_date();
                        if (dueDate == null ||
                                thisForm.getdue_date().after(dueDate)) {
                            // Hay dos casos, o el proyecto tiene una fecha final no definida
                            // o estoy poniendo una fecha final superior a la permitida.
                            String label = java.util.ResourceBundle.getBundle("ApplicationResources",
                                    new Locale(user.getlanguage(), "")).getString("errors.task.noEndDate");

                            String dueDateLabel = "";
                            try {
                                java.text.DateFormat df = java.text.DateFormat.getDateInstance(java.text.DateFormat.MEDIUM);
                                dueDateLabel = df.format(dueDate);
                            } catch (Exception e) {
                            }

                            if (dueDate == null) {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", label));
                            } else {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", dueDateLabel));
                            }

                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=add"));
                        }

                        if (data.getstatus() == 12) {
                            // No se puede insertar una tarea nueva como rechazada :>> Jury
                            errors.add("TaskRejectedConflict",
                                    new ActionError("errors.task.rejected"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=add"));
                        }
                        // Se deben ajustar los datos correspondientes a la tarifa.
                        if (thisForm.getcheck_monto_fijo() == 1) {
                            data.setfare(thisForm.getmonto_manual());
                        }

                        // We set the create date & time
                        data.setcreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                        // Se toma una referencia hacia el tipo de tarea que tiene ligado
                        // este nuevo registro.
                        type_tasksData valTypeTasks = (type_tasksData) typetasksBroker.getData(data.gettype_task(), user.getId_account());

                        if (valTypeTasks.getuse_prefix() != null &&
                                valTypeTasks.getuse_prefix().equalsIgnoreCase("1")) {
                            // El tipo de tarea hace uso de un prefijo para agregarlo al
                            // nombre de cada tarea.                                
                            String prefijoNuevo = valTypeTasks.getprefix();

                            // Obtenemos el consecutivo con base en el tipo de tarea 
                            // que se definio

                            prefijoNuevo += "-" +
                                    taskBroker.getPrefixForTasks(data.getproject(),
                                    data.gettype_task(), user.getId_account());

                            // Formamos el nuevo nombre de la tarea
                            prefijoNuevo += " " + data.getname();
                            prefijoNuevo = prefijoNuevo.trim();
                            data.setname(prefijoNuevo);
                        }


                        // Si esta tarea que se agrega esta ligada a una discusion, se le
                        // modifica el estado a la discusion enviada y ademas se le indica
                        // cual es la tarea ligada.

                        int topic = thisForm.gettopic2task();
                        if (topic > 0) {
                            // Como viene de un topic, se pone publicada
                            data.setpublished("1");
                        }
                        data.setestimated_time(new BigDecimal(data.getestimated_time() + "." + thisForm.getEstimated_time_min()));
                       data.setEmailNotifyFQA(thisForm.getEmailNotifyFQA());
                       data.setEmailNotifyTQA(thisForm.getEmailNotifyTQA());
                        // We add the new record.
                        taskBroker.add(data);

                     tasksStatusLogData tasksSL= new tasksStatusLogData();
                        
                        tasksSL.setId_account(user.getId_account());
                        tasksSL.setMember(user.getid());
                        tasksSL.setStatus(thisForm.getstatus());
                        tasksSL.setTask(data.getid());
                        tasksSL.setCreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        
                        tslBroker.add(tasksSL);
                        
                        
                        if (data.getassigned_to() > 0) {
                            // Si hay una asignacion real, la misma se registra en el historico
                            // de asignaciones
                            assignmentsData assignData = new assignmentsData();
                            assignData.setassigned(data.getcreated());
                            assignData.setassigned_to(data.getassigned_to());
                            assignData.setid(0);
                            assignData.setowner(data.getowner());
                            assignData.settask(data.getid());
                            assignData.setId_account(user.getId_account());
                            assignBroker.add(assignData);
                        }

                        // Se extra de la sesion el loginData
                        loginData login = (loginData) session.getAttribute("login");
                        membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());

                        membersData to_member = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());


                        // Si esta tarea que se agrega esta ligada a una discusion, se le
                        // modifica el estado a la discusion enviada y ademas se le indica
                        // cual es la tarea ligada.
                        topic = thisForm.gettopic2task();

                        if (topic > 0) {
                            // El topico origen es superior a 0, o sea viene de un topico
                            // valido.
                            topicsBroker topBroker = new topicsBroker();
                            topicsData topData = (topicsData) topBroker.getData(topic, user.getId_account());
                            topData.settotasks("1"); // Indica que tiene un task
                            topData.settasks(data.getid()); // Link al task
                            topData.setstatus("0");
                            topData.setId_account(user.getId_account());
                            topBroker.update(topData);
                            topBroker.close();

                            // Y ahora se deben de copiar los archivos de ese topico al
                            // directorio pertinente. Y ademas crear las entradas en la
                            // tabla de files
                            Iterator fileItera = fileBroker.getListByTopic("name", "ASC",
                                    topic, 0, user.getId_account());

                            // Se procesa cada archivo, primero creando una entrada nueva 
                            // para esta tarea y despues copiando los files fisicos
                            filesData fileData, fileDataNew;
                            while (fileItera.hasNext()) {

                                fileData = (filesData) fileItera.next();

                                try {
                                    // Se toma la direccion del archivo
                                    String fileDir = fileData.getPath();

                                    fileDataNew = new filesData(fileData);
                                    // Se liga el archivo a la tarea
                                    fileDataNew.setid(0);  // Nuevo Registro
                                    fileDataNew.settopic(0);
                                    fileDataNew.settask(data.getid()); // Tarea
                                    fileDataNew.setId_account(user.getId_account());
                                    // Se agrega el nuevo archivo a la tarea                                    
                                    fileBroker.add(fileDataNew);

                                    // Ahora se copia de un lado a otro.
                                    copyFile(fileDir, fileDataNew.getid() + "-" + fileDataNew.getname(),
                                            data.getproject(), data.getid(), user);

                                } catch (Exception ex) {
                                    System.out.println("Fatal Error: " + ex.toString());
                                    logger.logp(Level.SEVERE, "tasks.do", "perform",
                                            "Fatal Error During Topic2Task: " + ex.toString());
                                }
                            }
                        }

                        //send the notification a la persona en cuestion.                      
                        if (to_member.getid() > 0) {

                            sm.send("taskassignment", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));

                            // Adicionalmente se le envia al duenno del proyecto.
                            membersData to_owner = (membersData) memBroker.getData(data.getparentProject().getowner(), user.getId_account());
                            if (to_owner.getid() != to_member.getid()) {
                                // Evitamos enviarle dobles emails.
                                sm.send("taskassignment", from_member, to_owner, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            }
                        // Adicionalmente se le envia al duenno del ticket.
                        }
                        if (topic > 0) {
                            // El topico origen es superior a 0, o sea viene de un topico
                            // valido.
                            topicsBroker topBroker = new topicsBroker();
                            topicsData topData = (topicsData) topBroker.getData(topic, user.getId_account());
                            int owner_top = topData.getowner();

                            membersData to_owner_topic = (membersData) memBroker.getData(owner_top, user.getId_account());
                            System.out.println("member");
                            System.out.println(to_owner_topic);
                            System.out.println("from member");
                            System.out.println(from_member);
                            sm.send("taskassignment", from_member, to_owner_topic, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));

                        }
                         
                        if(data.getstatus() == 13 ){  
                            
                                if (data.getEmailNotifyTQA()!= 0){
                               membersData toTQA= (membersData)memBroker.getData(data.getEmailNotifyTQA());
                                 sm.send("sendqatnotification", from_member, toTQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                        }
                        if(data.getstatus() == 11){ 
                                if (data.getEmailNotifyFQA()!= 0){
                                membersData toFQA= (membersData)memBroker.getData(data.getEmailNotifyFQA());
                                 sm.send("sendqafnotification", from_member, toFQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                        }                        
                       /* if (data.getEmailNotifyFQA()!= 0){ 
                            membersData toFQA= (membersData)memBroker.getData(data.getEmailNotifyFQA());
                              sm.send("sendqafnotification", from_member, toFQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                        }
                        
                        if (data.getEmailNotifyTQA()!= 0){ 
                             membersData toTQA= (membersData)memBroker.getData(data.getEmailNotifyTQA());
                              sm.send("sendqatnotification", from_member, toTQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                        }*/

                        typetasksBroker.close();
                        // if el source es home
                        if (thisForm.getfromPage().equals("home")) {
                            request.setAttribute("company", company);
                            return (mapping.findForward("listing"));
                        } else {
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("viewingProjects").
                                    getPath() + "?operation=view&id=" + thisForm.getproject()));
                        }
                            
                    } else {
                        typetasksBroker.close();
                        // Se detecto un error de validacion, se retorna
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("displayAddEditError").
                                getPath() + "?operation=add"));
                    }
                } else if (action.equals("applyEdit")) {
                    // Se validan los datos ingresados
                    errors = thisForm.validate(mapping, request);
                    boolean changeday = false, changestatus = false, changepriority = false, changeassigned = false;

                    if (errors.isEmpty()) {
                        // Se trata de la aplicacion de un update en la BD
                        tasksData data = new tasksData();
                        tasksData dataOld = new tasksData();
                        
                        // We copy all the properties from the form to the bean.
                        PropertyUtils.copyProperties(data, thisForm);
                        //Obtengo datos actuales de tarea 
                        dataOld=(tasksData)taskBroker.getData(data.getid());

                        if (request.getParameter("status") != null )
                        data.setstatus(Integer.parseInt(request.getParameter("status")));
                        else
                        data.setstatus(dataOld.getstatus());
                        
                        data.setcollect(thisForm.getcollect());
                        
                        // Se extra de la sesion el loginData
                        loginData login = (loginData) session.getAttribute("login");
                        
                        membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());
                        membersData to_member = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());
                        membersData to_member2 = (membersData) memBroker.getData(dataOld.getassigned_to(), user.getId_account());

                    

                        // Control del manejo de las tareas predecesoras y requeridas
                        if (data.getpredecessor_required().equals("1")) {
                            // La tarea predecesora es requerida, se debe ver si su 
                            // estado es finalizado y si el cliente desea ponerle a 
                            // esta un estado de avance diferente de no iniciada.                            
                            if (data.getstatus() != 2) {
                                // Esta tarea se desea poner en un estado diferente de
                                // NOT STARTED (2). Hay que ver que la tarea predecesora
                                // este en estado (0) Client Ended o (1) Ended
                                tasksData predecesora = (tasksData) taskBroker.getData(data.getpredecessor(), user.getId_account());

                                int stat = predecesora.getstatus();
                                if (stat != 0 && stat != 1) {
                                    // La tarea predecesora NO ha sido concluida,
                                    // no puede cambiar el estado de esta tarea!.                                    
                                    errors.add("predecessorConflict",
                                            new ActionError("errors.task.predecessorNotFinished"));
                                    saveErrors(request, errors);
                                    request.setAttribute("company", company);
                                    return (new ActionForward(mapping.findForward("displayAddEditError").
                                            getPath() + "?operation=edit"));

                                }
                            }
                        }

                        // Si se rechaza la tarea, es obligatorio poner los comentarios
                        // que respalden ese hecho.
                        if (data.getstatus() == 7 && String.valueOf(data.getcomments()).length() <= 0) {
                            errors.add("taskRejected",
                                    new ActionError("errors.task.commentsMandatory"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));
                        }

                        if (data.getstart_date().after(data.getdue_date())) {
                            // La fecha final debe ser superior a la inicial 
                            errors.add("DateConflict",
                                    new ActionError("errors.task.dueDateNotsuperior"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));
                        }


                        // Si le esta poniendo el estado finalizado o finalizado por el cliente
                        // es decir, estado 0 u 1, y no le estipulo un valor de spread fix diferente
                        // de Si o No
                        if ((data.getstatus() == 0 || data.getstatus() == 1) &&
                                data.getspread_fix().equalsIgnoreCase(" ")) {
                            errors.add("SpreadFixConflict",
                                    new ActionError("errors.task.spreadFix"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));
                        }

                        // Si no es terminada por cliente o terminada y tiene un spread fix
                        // diferente de " "
                        if (data.getstatus() != 0 && data.getstatus() != 1 &&
                                data.getspread_fix().equalsIgnoreCase(" ") == false) {
                            errors.add("SpreadFixConflict",
                                    new ActionError("errors.task.spreadFixNotValid"));
                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));
                        }

                        // Verificamos si la fecha de la tarea es superior a la fecha del proyecto
                        // en el cual esta siendo creado. Si es mayor no se permite definirla.

                        projectsData projectTask = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());

                       // SimpleDateFormat dateFormat = new SimpleDateFormat("dd/MM/yyyy");
                        Date dueDate = new Date();
                        //Date date2 = new Date();
                        if (thisForm.getdue_date() == null ||
                                thisForm.getdue_date().after(projectTask.getend_date())) {
                            // Hay dos casos, o el proyecto tiene una fecha final no definida
                            // o estoy poniendo una fecha final superior a la permitida.
                            String label = java.util.ResourceBundle.getBundle("ApplicationResources",
                                    new Locale(user.getlanguage(), "")).getString("errors.task.noEndDate");

                            String dueDateLabel = "";
                            try {
                                java.text.DateFormat df = java.text.DateFormat.getDateInstance(java.text.DateFormat.MEDIUM);
                                dueDateLabel = df.format(projectTask.getend_date());
                            } catch (Exception e) {
                            }

                            if (dueDate == null) {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", label));
                            } else {
                                errors.add("TaskOverDue",
                                        new ActionError("errors.task.dueDateLaterProject", dueDateLabel));
                            }

                            saveErrors(request, errors);
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));
                        }

                        // Se deben ajustar los datos correspondientes a la tarifa.
                        if (thisForm.getcheck_monto_fijo() == 1) {
                            data.setfare(thisForm.getmonto_manual());
                        }

                        // Determinamos si hubo un cambio en el usuario asignado
                        // a la tarea.
                        tasksData originalTask = (tasksData) taskBroker.getData(data.getid(), user.getId_account());

                        if (originalTask.getassigned_to() != data.getassigned_to() &&
                                data.getassigned_to() > 0) {
                            // Se cambio el usuario asignado, se debe de grabar el
                            // nuevo registro en la bit?cora
                            assignmentsData assignData = new assignmentsData();
                            assignData.setassigned(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                            assignData.setassigned_to(data.getassigned_to());
                            assignData.setid(0);
                            assignData.setowner(data.getowner());
                            assignData.settask(data.getid());
                            assignData.setId_account(user.getId_account());
                            assignBroker.add(assignData);
                        }

                        if (data.getstatus() == 9) {
                            data.setstatus(10);
                        }

                        // Si esta concluida, le ponemos el 100
                        if (data.getstatus() == 1) {
                            data.setcompletion(100);
                            data.setreal_due_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        }

                        // Si la tarea se termina por control de calidad, se pone al 100%
                        if (data.getstatus() == 13) {
                            data.setcompletion(100);
                        }

                        // Si la persona que edita el registro no es el duenno
                        // o no es el admin, entonces la descripcion de la tarea
                        // no se ve modificada, esto es por si tiene ENTERS y como es
                        // un campo invisible pues se trunca
                        if (projectTask.getowner() != user.getid() &&
                                //user.getid() != 1) {
                                (!user.getprofile().equals("3") && !user.getprofile().equals("4"))) {
                            data.setdescription(originalTask.getdescription());
                        }

                        // Actualiza la tarea en cuestion.
                        data.setmodified(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        data.setId_account(user.getId_account());

                        System.out.println("task estimated ti : "+thisForm.getEstimated_time_min());
                        System.out.println("estimated time::: "+thisForm.getestimated_time().toString());

                        if (thisForm.getEstimated_time_min() != null) {
                            if (thisForm.getEstimated_time_min().toString().length() == 1) {
                                data.setestimated_time(new BigDecimal(data.getestimated_time() + ".0" + thisForm.getEstimated_time_min()));
                            } else {
                                data.setestimated_time(new BigDecimal(data.getestimated_time() + "." + thisForm.getEstimated_time_min()));
                            }
                        }else
                            if (thisForm.getestimated_time().toString().length() ==1)
                            data.setestimated_time(new BigDecimal(data.getestimated_time() + ".00"));


                        data.setactual_time(originalTask.getactual_time());
                        data.setEmailNotifyFQA(thisForm.getEmailNotifyFQA());
                        data.setEmailNotifyTQA(thisForm.getEmailNotifyTQA());
                        taskBroker.update(data);
                        

                                              //Si la tarea a sido reasignada a otro usuario, se le enva una notificacin.
                        if (dataOld.getassigned_to()!= data.getassigned_to()){

                                sm.send("taskreasigned", from_member, to_member2, data.getid(),  new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                        }

                        Calendar oldday = Calendar.getInstance();
                        Calendar newday = Calendar.getInstance();

                        oldday.setTime(originalTask.getdue_date());
                        newday.setTime(thisForm.getdue_date());

                        // Determinar si el usuario cambio el dia de entrega
                        if ((oldday.get(Calendar.YEAR) != newday.get(Calendar.YEAR)) || (oldday.get(Calendar.DAY_OF_YEAR) != newday.get(Calendar.DAY_OF_YEAR))) {
                            changeday = true;
                        }

                        // Determinar si cambio la prioridad
                        if (originalTask.getpriority() != thisForm.getpriority()) {
                            changepriority = true;
                        }

                        // Determinar si cambio el status
                        if (originalTask.getstatus() != thisForm.getstatus()) {
                            changestatus = true;
                        }

                        // Si se dio un cambio en los comentarios.
                        if (String.valueOf(originalTask.getcomments()).equalsIgnoreCase(thisForm.getcomments()) == false) {
                            changestatus = true;
                        }

                        // Determinar si cambio el usuario asignado a esta tarea
                        if (originalTask.getassigned_to() != thisForm.getassigned_to()) {
                            changeassigned = true;
                        }
                        
                        boolean qa=false;
                        boolean qa1=false;
                        if(data.getstatus() == 11 ){ 
                            
                            if (originalTask.getEmailNotifyFQA()!= thisForm.getEmailNotifyFQA()){
                                qa=true;
                                membersData toFQA= (membersData)memBroker.getData(data.getEmailNotifyFQA());
                                  sm.send("sendqafnotification", from_member, toFQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            }
                        }
                        if(data.getstatus() == 13 ){
                            if (originalTask.getEmailNotifyTQA()!= thisForm.getEmailNotifyTQA()){
                                qa1=true;
                                 membersData toTQA= (membersData)memBroker.getData(data.getEmailNotifyTQA());
                                  sm.send("sendqatnotification", from_member, toTQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            }   
                        }


                        // Variable definida para evitar enviar "n" veces un correo por temas diversos, pero asociados
                        // a la misma tarea
                        boolean emailSended = false;

                        if (changestatus) {
                            if (data.getstatus() == 6 || data.getstatus() == 7 ||
                                    data.getstatus() == 8) {
                             
                                // Cargar una lista con todos los miembros de una organizacion que reciben cotizaciones
                                projectsData project = (projectsData) projBroker.getData(data.getproject(), user.getId_account());
                                Iterator lista = memBroker.getMembersQuotation(project.getid(), user.getId_account());
                        
                                String status = "";
                                if (data.getstatus() == 6) {
                                    status = "quotesended";
                                }
                                if (data.getstatus() == 7) {
                                    status = "quoterejected";
                                }
                                if (data.getstatus() == 8) {
                                    status = "quoteacepted";
                                }

                                String reason = request.getParameter("reason_for_rejected");
                                if (reason == null) {
                                    reason = "";
                                }   
                                
                                while (lista.hasNext()) {
                                    membersData mb = (membersData) lista.next();
                                    sm.send(status, from_member, mb, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                
                                Iterator listaAdm = memBroker.getQuotationMembers(""+user.getId_account());
                                while (listaAdm.hasNext()) {
                                    membersData mb = (membersData) listaAdm.next();
                                    sm.send(status, from_member, mb, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                
                                sm.send(status, from_member, project.getparentOwner(), data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                
                            }
                            if (data.getstatus() == 13) {
                                int projowner = ((projectsData) projBroker.getData(data.getproject(), user.getId_account())).getowner();                               
                                membersData adminMembers = (membersData) memBroker.getData(projowner, user.getId_account());
                                sm.send("statustaskchange", from_member, adminMembers, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                
                            }
                            
                            // Se trata de una tarea que se ha cerrado. Se debe enviar un email al
                            // lider del proyecto del cliente como referencia.
                            if (data.getstatus() == 0 || data.getstatus() == 1 ||  data.getstatus() == 14) {
                                   System.out.println("aca entro");
                                try {
                                    teamsData team;
                                    membersData clientManager;
                                    Iterator teamIterator = brokerTeams.getListByProjectWithCloseRoleOrClientManager("id", "ASC",
                                            projectTask.getid(), 0, user.getId_account());
                                    
                                    if (!data.getpublished().equals("0")){
                                        System.out.println("---------Team Members--------");
                                        while (teamIterator.hasNext()) {
                                            team = (teamsData) teamIterator.next();
                                            clientManager = (membersData) memBroker.getData(team.getmembers(), user.getId_account());
                                            sm.send("statustaskchange", from_member, clientManager, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));

                                        }
                                       
                                        System.out.println("-------------------------");
                                    }else{
                                        System.out.println("---------Tarea NO pblica: NO notificar al CLIENTE--------");
                                    }
                                    boolean band = false;
                                    int idSubProject = projectTask.getid();
                                    ArrayList repetidos = new ArrayList();
                                    projectsData subProject;
                                    membersData proyManager;
                                    while (!band) {
                                        subProject = new projectsData();
                                        subProject = (projectsData) projBroker.getData(idSubProject, user.getId_account());
                                        if (subProject.getid() != 0) {
                                            if (subProject.getSend_email().equals("1")) {
                                          //emailSended = true;
                                                proyManager = new membersData();
                                                proyManager = (membersData) memBroker.getData(subProject.getowner(), user.getId_account());
                                                
                                                    System.out.println("---------Proyect Manager--------");
                                                if (!repetidos.contains(new Integer(proyManager.getid()))) {
                                                    repetidos.add(new Integer(proyManager.getid()));
                                                    
                                                    sm.send("statustaskchange", from_member, proyManager, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                                }
                                                System.out.println("-------------------------");
                                            }
                                            idSubProject = subProject.getProject_id();
                                        } else {
                                            band = true;
                                        }
                                    }
                                    
                                    
                                } catch (Exception e) {
                                    servlet.log("[DEBUG] tasksAction Fatal error on sending email to clientManager " +  e.toString());
                                    System.out.println("Fatal error on sending email to clientManager " +
                                            e.toString());
                                }
                            }

                            if (data.getstatus() == 12) {
                                int projowner = ((projectsData) projBroker.getData(data.getproject(), user.getId_account())).getowner();
                                Iterator lista = memBroker.getProjectAdmin(1, user.getId_account());
                                membersData adminMembers = (membersData) memBroker.getData(projowner, user.getId_account());
                                
                                membersData mData= (membersData) memBroker.getData(data.getassigned_to());

                                String reason = request.getParameter("reason_for_rejected");
                                if (reason == null) {
                                    reason = "";
                                }
                                
                                        System.out.println("6-");
                                //Se le envia la notificacin de Rechazo al Administrador 
                                
                                System.out.println("--------- Reject Task Notification: Admin --------");
                                if (lista.hasNext()){
                                    sm.send("taskrejected", from_member, (membersData) lista.next(), data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                //Se le envia la notificacin de Rechazo al Dueo del Proyecto 
                                System.out.println("-------------------------");
                                        System.out.println("--------- Reject Task Notification: Project Owner --------");
                                sm.send("taskrejected", from_member, adminMembers, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                //Se le envia la notificacin de Rechazo al Dueo de la Tarea
                                System.out.println("-------------------------");
                                        System.out.println("--------- Reject Task Notification: Task Owner --------");
                                sm.send("taskrejected", from_member, mData, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                System.out.println("-------------------------");                                

                                String desc = "";
                                if (data.getdescription() != null) {
                                    desc = new String(data.getdescription());
                                }
                                java.text.DateFormat df = java.text.DateFormat.getDateInstance(java.text.DateFormat.MEDIUM);

                                // Se forma la descripcion del rechazo.
                                desc += "\n------------------------------------------" +
                                        "\nTarea Rechazada el " + df.format(Calendar.getInstance().getTime()) +
                                        " por " + user.gefullname() + "\n" +
                                        reason;
                                data.setdescription(desc);
                                taskBroker.update(data);
                                
                      
                            }

                            // Si es cotizacion o cotizacion enviada, enviar el correo pero tomar el monto 
                            // basado en horas estimadas
                            if ((data.getstatus() == 10 && data.getestimated_time().multiply(data.getfare()).intValue() > 0)) {                                
                           
                                System.out.println("---------ASDASD--------");
                                sm.send("accounting", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                emailSended = true;
                                System.out.println("-------------------------");
                            }
                            
                            if(data.getstatus() == 11 && qa==false){
                                if (data.getEmailNotifyFQA() != 0){
                                    membersData toFQA= (membersData)memBroker.getData(data.getEmailNotifyFQA());
                                    sm.send("sendqafnotification", from_member, toFQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                            }   
                            if(data.getstatus() == 13 && qa1==false){  
                                if (data.getEmailNotifyTQA() != 0){
                                    membersData toTQA= (membersData)memBroker.getData(data.getEmailNotifyTQA());
                                    sm.send("sendqatnotification", from_member, toTQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                             }

                      
                            // Se envia el email al usuario asignado de la tarea
                            if (to_member.getid() > 0 && emailSended == false) {

                     //           if (data.getstatus() != 0 && !data.getpublished().equalsIgnoreCase("0")) {
                                // Si esta finalizada por el cliente y no esta publicada
//                                } else {
                                
                                
                             //   if ( (data.getstatus()!=12) && !data.getpublished().equalsIgnoreCase("0")) {
                                if ( data.getstatus()!=12){
                                    System.out.println("---------Task Owner Member--------");
                                    sm.send("statustaskchange", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                    System.out.println("----------Control Version---------------");
                                     membersData clientManager2 =  new membersData();
                                    String svn = TMSConfigurator.getSvn();
                                    clientManager2.setemail_work(svn);
                                    sm.send("statustaskchange", from_member, clientManager2, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                    System.out.println("-------------------------");
                                }
                                emailSended = true;
                            }
                                        
                            if (originalTask.getstatus() != thisForm.getstatus()){
                                    //Se actualiza la bitacora si cambia el esado de la tarea
                                    tasksStatusLogData tasksSL = new tasksStatusLogData();
                                    tasksSL.setId_account(user.getId_account());
                                    tasksSL.setMember(user.getid());
                                    tasksSL.setStatus(thisForm.getstatus());
                                    tasksSL.setTask(thisForm.getid());
                                    tasksSL.setCreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                                    tslBroker.add(tasksSL);
                            }
                        }

                        // Enviar los email de notificacion segun los cambios
                        
                        
                        System.out.println("---------Otros--------");
                        if (changeassigned && to_member.getid() > 0 && emailSended == false) {
                            sm.send("taskassignment", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            emailSended = true;
                        }
                        if (changeday && to_member.getid() > 0 && emailSended == false) {
                            sm.send("duedatetaskchange", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            emailSended = true;
                        }
                        if (changepriority && to_member.getid() > 0 && emailSended == false) {
                            sm.send("prioritytaskchange", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                        }

                        System.out.println("---------------------");
                        
  
                        // if el source es home
                        if (thisForm.getfromPage().equals("home")) {
                            request.setAttribute("company", company);
                            return (mapping.findForward("listing"));
                        } else {
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("viewingProjects").
                                    getPath() + "?operation=view&id=" + thisForm.getproject()));
                        }
                    } else {
                        // Se detecto un error de validacion, se retorna
                        saveErrors(request, errors);
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("displayAddEditError").
                                getPath() + "?operation=edit"));
                    }

                } else if (action.equals(
                        "addToSite")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado

                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());
                    tasksData data;

                    // Debido a que se puede hacer un add masivo
                    for (int i = 0; i < items.size(); i++) {
                        data = (tasksData) items.get(i);

                        data.setpublished("1");
                        taskBroker.update(data);
                    
                    // Se notifica a los usuarios cliente del proyecto.     
                    // Se extra de la sesion el loginData
                    loginData login = (loginData) session.getAttribute("login");
                    membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());
                    
                    projectsData projectTask = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());
                                   teamsData team;
                                        System.out.println("aca entro1 "+user.getId_account());
                                    membersData clientManager;
                                        System.out.println("aca entro2 "+ projectTask.getid());
                                    Iterator teamIterator = brokerTeams.getListByProjectWithCloseRoleOrClientManager("id", "ASC",
                                            projectTask.getid(), 0, user.getId_account());
                                    
                                    if (!data.getpublished().equals("0")){
                                        System.out.println("---------Team Members--------");
                                        while (teamIterator.hasNext()) {
                                            team = (teamsData) teamIterator.next();
                                            clientManager = (membersData) memBroker.getData(team.getmembers(), user.getId_account());
                                             System.out.println("LOGIN: "+ clientManager.getlogin() + " EMAIL: "+ clientManager.getemail_work());
                                            sm.send("taskassignment", from_member, clientManager, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));

                                        }
                                        
                                        System.out.println("-------------------------");
                                    }else{
                                        System.out.println("---------Tarea NO pblica: NO notificar al CLIENTE--------");
                                    }
                    }
                    // if el source es home
                    if (thisForm.getfromPage().equals("home")) {
                        request.setAttribute("company", company);
                        return (mapping.findForward("listing"));
                    } else {
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("viewingProjects").
                                getPath() + "?operation=view&id=" + thisForm.getproject()));
                    }

                } else if (action.equals(
                        "removeFromSite")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado
                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());
                    tasksData data;

                    // Debido a que se puede hacer un add masivo
                    for (int i = 0; i < items.size(); i++) {
                        data = (tasksData) items.get(i);

                        data.setpublished("0");
                        taskBroker.update(data);
                    }

                    // if el source es home
                    if (thisForm.getfromPage().equals("home")) {
                        request.setAttribute("company", company);
                        return (mapping.findForward("listing"));
                    } else {
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("viewingProjects").
                                getPath() + "?operation=view&id=" + thisForm.getproject()));
                    }

                } else if (action.equals(
                        "sendQuote")) {
                    // Cargar una lista con todos los miembros de una organizacion que reciben cotizaciones
                    projectsData project = (projectsData) projBroker.getData(
                            Integer.parseInt(request.getParameter("project")), user.getId_account());

                    Iterator lista = memBroker.getMembersQuotation(project.getid(), user.getId_account());

                    // Se modifica el estado de la tarea al valor 6 que en sended
                    tasksData tdata = (tasksData) taskBroker.getData(Integer.parseInt(request.getParameter("id")), user.getId_account());

                    tdata.setstatus(6);
                    tdata.setpublished("1");
                    tdata.setsend_quotation_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                    taskBroker.update(tdata);

                    String status = "";
                    status = "quotesended";

                    String reason = request.getParameter("reason_for_rejected");
                    if (reason == null) {
                        reason = "";
                    }
                    membersData from_member = (membersData) memBroker.getData(user.getid(), user.getId_account());

                    while (lista.hasNext()) {
                        membersData mb = (membersData) lista.next();
                        sm.send(status, from_member, mb,
                                Integer.parseInt(request.getParameter("id")),
                                reason, user,String.valueOf(session.getAttribute("mainUrl")));
                    }
                    
                    
                                Iterator listaAdm = memBroker.getQuotationMembers(""+user.getId_account());
                                while (listaAdm.hasNext()) {
                                    membersData mb = (membersData) listaAdm.next();
                                    sm.send(status, from_member, mb,  Integer.parseInt(request.getParameter("id"))
                                            , reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                
                                sm.send(status, from_member, project.getparentOwner(),  Integer.parseInt(request.getParameter("id"))
                                        , reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                
                    // Redirect al project list
                    request.setAttribute("company", company);
                    return (new ActionForward(mapping.findForward("viewingProjects").
                            getPath() + "?operation=view&id=" + request.getParameter("project")));


                } else if (action.equals(
                        "showAll") || action.equals("sortAll")) {
                    if (request.getParameter("typeOp") != null) {
                        thisForm.settype_task(Integer.parseInt(request.getParameter("typeOp").toString()));
                    }
                    Iterator e;
                    if (thisForm.gettype_task() == 0) // Se trata de un showAll de las tareas asociadas a un proyecto determinado.                    
                    {
                        e = taskBroker.getListByProject(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                thisForm.getproject(), 0, user.getId_account());
                    } else {
                        e = taskBroker.getListByProjectByType(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                thisForm.getproject(), 0, thisForm.gettype_task(), user.getId_account());
                    }
                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();
                    while (e.hasNext()) {
                        lista.add(e.next());
                    }

                    // Se retorna la lista de las tareas de este proyecto nada mas.
                    request.setAttribute("listTasks", lista);

                    if (thisForm.getOperation().equalsIgnoreCase("sortAll")) {
                        // Negamos el tipo de ordenamiento
                        if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                            thisForm.setsortOrder("DESC");
                        } else {
                            thisForm.setsortOrder("ASC");
                        }
                    }

                    projectsData projectMember = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            "<a href='./projects.do?operation=view&id=" +
                            projectMember.getid() + "'>" +
                            projectMember.getname() + "</a>&nbsp;/" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.allTask"));
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAllTasks"));

                } else if (action.equals(
                        "showAllMyTasks") || action.equals("sortAllMyTasks")) {
                    // Se trata de un showAll de las tareas asociadas al usuario que
                    // se encuentra conectado.

                    if (request.getParameter("typeOp") != null) {
                        thisForm.settype_task(Integer.parseInt(request.getParameter("typeOp").toString()));
                    }
                    Iterator e;
                    if (thisForm.gettype_task() == 0) {
                        e = taskBroker.getAllListByMemberFiltered(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                user.getid(), 0, user.getId_account());
                    } else {
                        e = taskBroker.getListByMemberFiltered(thisForm.getsortColumn(),
                                thisForm.getsortOrder(),
                                user.getid(), 0, user.getId_account(), thisForm.gettype_task());
                    }

                    // Debemos convertir el iterador en un arraylist.
                    ArrayList lista = new ArrayList();
                    while (e.hasNext()) {
                        lista.add(e.next());
                    }

                    // Se retorna la lista de las tareas de este proyecto nada mas.
                    request.setAttribute("listTasks", lista);

                    if (thisForm.getOperation().equalsIgnoreCase("sortAllMyTasks")) {
                        // Negamos el tipo de ordenamiento
                        if (thisForm.getsortOrder().equalsIgnoreCase("ASC")) {
                            thisForm.setsortOrder("DESC");
                        } else {
                            thisForm.setsortOrder("ASC");
                        }
                    }

                    projectsData projectMember = (projectsData) projBroker.getData(thisForm.getproject(), user.getId_account());

                    // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;/" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.allTask"));
                    request.setAttribute("company", company);
                    return (mapping.findForward("displayAllMyTasks"));

                } else if (action.equals(
                        "moveTask")) {
                    // Si la operacion es mover una TAREA a otro proyecto.

                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());


                    if (user.isAdmin() || ((tasksData) items.get(0)).getparentProject().getowner() == user.getid()) {
                        // Solo un usuario administrador, o el dueno del proyecto puede mover tareas
                        String param = "";
                        if (request.getParameter("fromPage").equalsIgnoreCase("viewProject")) {
                            param = "" + thisForm.getproject();
                        }

                        request.setAttribute("fromPage", request.getParameter("fromPage"));
                        request.setAttribute("param", "" + param);
                        request.setAttribute("checkedItems", request.getParameter("checkedItems"));
                        request.setAttribute("items", items);
                        request.setAttribute("title", java.util.ResourceBundle.getBundle("ApplicationResources",
                                new Locale(user.getlanguage(), "")).getString("common.Task"));
                        request.setAttribute("do", request.getRequestURI());

                        if (user.isAdmin()) {
                            // Es el admin, tiene acceso a todo
                            request.setAttribute("projectList", this.getListing(projBroker, "name", "ASC", user.getId_account(), user.getid()));
                        } else {
                            // Es un administrador de proyectos y por ende solo se muestran
                            // los proyectos que tiene ligados.
                            Iterator e = projBroker.getListByOwner("id", "ASC", user.getid(), 0, user.getId_account());
                            ArrayList lista = new ArrayList();

                            while (e.hasNext()) {
                                lista.add(e.next());
                            }

                            request.setAttribute("projectList", lista);
                        }
                        request.setAttribute("company", company);
                        // forward to display the list 
                        return (mapping.findForward("confirmMove"));
                    } else {
                        // No hay acceso, se redirecciona a una pagina donde se le notifica
                        // de eso.
                        // Se agrega el link para el menu con la ruta
                        request.setAttribute("menuRoute",
                                "<a href='./home.do'>" + java.util.ResourceBundle.getBundle("ApplicationResources",
                                new Locale(user.getlanguage(), "")).getString("header.displayStart") + "</a>&nbsp;");
                        request.setAttribute("company", company);
                        return (mapping.findForward("deleteDenied"));
                    }

                } else if (action.equals(
                        "applyMove")) {
                    // Tomamos el bean correspondiente a este objeto a fin
                    // de proceder con su borrado                    
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    String lista = "";

                    for (int i = 0; i < fields.length; i++) {
                        lista += fields[i] + " - ";
                    }
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());

                    // Se toma la referencia del proyecto al cual se quiere trasladar
                    int idNewProject = Integer.parseInt(request.getParameter("project"));

                    // Se procede con el traslado de cada una de ellas.
                    tasksData dataMove;
                    type_tasksData valTypeTasks;
                    for (int i = 0; i < items.size(); i++) {
                        dataMove = (tasksData) items.get(i);
                        dataMove.setproject(idNewProject);

                        // Se toma una referencia hacia el tipo de tarea que tiene ligado
                        // este nuevo registro.
                        valTypeTasks = (type_tasksData) typetasksBroker.getData(dataMove.gettype_task(), user.getId_account());

                        // Si aplica actualizamos el id del consecutivo
                        if (valTypeTasks.getuse_prefix() != null &&
                                valTypeTasks.getuse_prefix().equalsIgnoreCase("1")) {
                            // El tipo de tarea hace uso de un prefijo para agregarlo al
                            // nombre de cada tarea.                                
                            String prefijoNuevo = valTypeTasks.getprefix();

                            // Obtenemos el consecutivo con base en el tipo de tarea 
                            // que se definio
                            prefijoNuevo += "-" +
                                    taskBroker.getPrefixForTasks(idNewProject, dataMove.gettype_task(), user.getId_account());

                            // Formamos el nuevo nombre de la tarea
                            prefijoNuevo += " " + dataMove.getname();
                            prefijoNuevo = prefijoNuevo.trim();
                            dataMove.setname(prefijoNuevo);

                            // Y ademas actualizamos el campo de comments para indicar que
                            // fue trasladada.
                            String newComment = java.util.ResourceBundle.getBundle("ApplicationResources",
                                    new Locale(user.getlanguage(), "")).getString("common.CommentMovedTask") +
                                    dataMove.getparentProject().getname() + " " +
                                    dataMove.getcomments();

                            // El espacio es de 600 caracteres, por si acaso lo recortamos.
                            int largo = newComment.length();
                            if (largo > 599) {
                                largo = 599;
                            }
                            newComment = newComment.substring(0, largo);
                            dataMove.setcomments(newComment);
                        }


                        // We update the object in the DBMS
                        taskBroker.update(dataMove);

                        // El usuario asignado no es miembro del equipo del nuevo proyecto, lo movemos tambien
                        if (dataMove.getassigned_to() > 0 &&
                                brokerTeams.isMember(idNewProject, dataMove.getassigned_to(), user.getId_account()) == false) {
                            teamsData team = new teamsData();
                            team.setid(0);
                            team.setauthorized("0");
                            team.setpublished("0");
                            team.setprojects(idNewProject);
                            team.setmembers(dataMove.getassigned_to());
                            team.setId_account(user.getId_account());
                            brokerTeams.add(team);
                        }

                        // Se deben de trasladar todos los archivos que estaban ligados a esta tarea que se esta moviendo.                      
                        Iterator fileItera = fileBroker.getList("name",
                                "ASC",
                                dataMove.getid(), 0, user.getId_account());

                        // Se procesa cada archivo, primero creando una entrada nueva 
                        // para esta tarea y despues copiando los files fisicos
                        filesData fileData, fileDataNew;
                        while (fileItera.hasNext()) {
                            fileData = (filesData) fileItera.next();

                            try {
                                // Se toma la direccion del archivo
                                String fileDir = fileData.getPath();

                                fileDataNew = new filesData(fileData);
                                // Se liga el archivo a la tarea
                                fileDataNew.setid(0);  // Nuevo Registro
                                fileDataNew.settopic(0);
                                fileDataNew.setproject(idNewProject);
                                fileDataNew.setId_account(user.getId_account());
                                // Se agrega el nuevo archivo a la tarea                                    
                                fileBroker.add(fileDataNew);

                                // Ahora se copia de un lado a otro.
                                copyFile(fileDir, fileDataNew.getid() + "-" + fileDataNew.getname(),
                                        idNewProject, dataMove.getid(), user);

                                // Y se borra el puntero original de la tarea a su viejo archivo y ademas
                                // fisicamente.
                                fileBroker.delete(fileData);

                                File theFile = new File(fileData.getPath());
                                theFile.delete();

                            } catch (Exception ex) {
                                System.out.println("Fatal Error: " + ex.toString());
                                logger.logp(Level.SEVERE, "tasks.do", "perform",
                                        "Fatal Error During Topic2Task: " + ex.toString());
                            }
                        }

                    }

                    // if el source es home
                    if (thisForm.getfromPage().equals("home")) {
                        request.setAttribute("company", company);
                        return (mapping.findForward("listing"));
                    } else {
                        request.setAttribute("company", company);
                        return (new ActionForward(mapping.findForward("viewProject").
                                getPath() + "&id=" + request.getParameter("param"), false));
                    }
                } else if (action.equals("applyChangeStatus")) {
                    tasksData data= new tasksData();
                    // get the string with ids separate by "," character, and split in array os strings
                    String[] fields = (request.getParameter("checkedItems") + ",").split(",");
                    ArrayList items = taskBroker.getItems(fields, user.getId_account());
                    ArrayList failed= new ArrayList();
                    boolean flag=false;
                    
                    int status= Integer.parseInt(request.getParameter("status"));
                     request.setAttribute("menuRoute",
                                            "<a href='./admin.do'>" +
                                            ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Administration") + "</a>&nbsp;/&nbsp;" 
                                            + "</a><a href='./reports.do?operation=addTaskChange2'>"
                                             + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayTaskChange")
                                            + "</a>&nbsp;/&nbsp;"
                                        + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));

                    for (int i=0; i<items.size(); i++){
                        flag=false;
                        data= (tasksData)items.get(i);
                        /*Si el Estado de la Tarea es Diferente al Nuevo Estado, entonces actualiza el Estado*/
                        if (data.getstatus()!= status){
                            
                            data.setstatus(status);
                            data.setspread_fix("N");
                             
                                 // Si se rechaza la tarea, es obligatorio poner los comentarios
                        // que respalden ese hecho.
                        if (data.getstatus() == 7 && String.valueOf(data.getcomments()).length() <= 0) {
                            flag=true;
                            /*errors.add("taskRejected",
                                    new ActionError("errors.task.commentsMandatory"));
                            saveErrors(request, errors);
                            request.setAttribute("menuRoute",
                                "<a href='./admin.do'>" +
                                ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Administration") + "</a>&nbsp;/&nbsp;" 
                                + "</a><a href='./reports.do?operation=addTaskChange2'>"
                                 + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayTaskChange")
                                + "</a>&nbsp;/&nbsp;"
                            + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));
                    
                            request.setAttribute("company", company);
                            return (new ActionForward(mapping.findForward("displayAddEditError").
                                    getPath() + "?operation=edit"));*/
                            
                                            failed.add(data);
                        }

                         if (data.getstatus() == 9) {
                            data.setstatus(10);
                        }

                        // Si esta concluida, le ponemos el 100
                        if (data.getstatus() == 1) {
                            data.setcompletion(100);
                            data.setreal_due_date(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));
                        }

                        // Si la tarea se termina por control de calidad, se pone al 100%
                        if (data.getstatus() == 13) {
                            data.setcompletion(100);
                        }
                        
                        
                            if (!flag){
                                 
                                taskBroker.update(data);     
                            tasksStatusLogData tasksSL= new tasksStatusLogData();
                            tasksStatusLogBroker brokersl= new tasksStatusLogBroker();
                            tasksSL.setId_account(user.getId_account());
                            tasksSL.setMember(user.getid());
                            tasksSL.setStatus(thisForm.getstatus());
                            tasksSL.setTask(data.getid());
                            tasksSL.setCreated(new java.sql.Timestamp(Calendar.getInstance().getTimeInMillis()));

                            brokersl.add(tasksSL);
                            brokersl.close();
                            
                            if (data.getassigned_to() > 0) {
                            // Si hay una asignacion real, la misma se registra en el historico
                            // de asignaciones
                            assignmentsData assignData = new assignmentsData();
                            assignData.setassigned(data.getcreated());
                            assignData.setassigned_to(data.getassigned_to());
                            assignData.setid(0);
                            assignData.setowner(data.getowner());
                            assignData.settask(data.getid());
                            assignData.setId_account(user.getId_account());
                            assignBroker.add(assignData);

                        Calendar oldday = Calendar.getInstance();
                        Calendar newday = Calendar.getInstance();

                        // Variable definida para evitar enviar "n" veces un correo por temas diversos, pero asociados
                        // a la misma tarea
                        boolean emailSended = false;
   // Se extra de la sesion el loginData
                                loginData login = (loginData) session.getAttribute("login");
                                membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());

                                membersData to_member = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());

                            if (data.getstatus() == 6 || data.getstatus() == 7 ||
                                    data.getstatus() == 8) {
                             
                                // Cargar una lista con todos los miembros de una organizacion que reciben cotizaciones
                                projectsData project = (projectsData) projBroker.getData(data.getproject(), user.getId_account());
                                Iterator lista = memBroker.getMembersQuotation(project.getid(), user.getId_account());

                                
                        
                                String status1 = "";
                                if (data.getstatus() == 6) {
                                    status1 = "quotesended";
                                }
                                if (data.getstatus() == 7) {
                                    status1 = "quoterejected";
                                }
                                if (data.getstatus() == 8) {
                                    status1 = "quoteacepted";
                                }

                                String reason = request.getParameter("reason_for_rejected");
                                if (reason == null) {
                                    reason = "";
                                }   
                             
                                while (lista.hasNext()) {
                                    membersData mb = (membersData) lista.next();
                                    sm.send(status1, from_member, mb, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                Iterator listaAdm = memBroker.getQuotationMembers(""+user.getId_account());
                                while (listaAdm.hasNext()) {
                                    membersData mb = (membersData) listaAdm.next();
                                    sm.send(status1, from_member, mb, data.getid()
                                            , reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                
                                sm.send(status1, from_member, project.getparentOwner(),  data.getid()
                                        , reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                
                            }
                            if (data.getstatus() == 13) {
                                int projowner = ((projectsData) projBroker.getData(data.getproject(), user.getId_account())).getowner();                               
                                membersData adminMembers = (membersData) memBroker.getData(projowner, user.getId_account());
                                sm.send("statustaskchange", from_member, adminMembers, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                            }
                            
                            // Se trata de una tarea que se ha cerrado. Se debe enviar un email al
                            // lider del proyecto del cliente como referencia.
                            if (data.getstatus() == 0 || data.getstatus() == 1 ||  data.getstatus() == 14) {
                                   System.out.println("aca entro");
                                try {
                                    teamsData team;
                                        System.out.println("aca entro1");
                                    membersData clientManager;
                                        System.out.println("aca entro2 ");
                                    Iterator teamIterator = brokerTeams.getListByProjectWithCloseRoleOrClientManager("id", "ASC",
                                            data.getparentProject().getid(), 0, user.getId_account());
                                    
                                    if (!data.getpublished().equals("0")){
                                        System.out.println("---------Team Members--------");
                                        while (teamIterator.hasNext()) {
                                            team = (teamsData) teamIterator.next();
                                            clientManager = (membersData) memBroker.getData(team.getmembers(), user.getId_account());
                                            sm.send("statustaskchange", from_member, clientManager, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                            
                                        }
                                        
                                        System.out.println("-------------------------");
                                    }else{
                                        System.out.println("---------Tarea NO pblica: NO notificar al CLIENTE--------");
                                    }
                                    boolean band = false;
                                    int idSubProject = data.getparentProject().getid();
                                    ArrayList repetidos = new ArrayList();
                                    projectsData subProject;
                                    membersData proyManager;
                                    while (!band) {
                                        subProject = new projectsData();
                                        subProject = (projectsData) projBroker.getData(idSubProject, user.getId_account());
                                        if (subProject.getid() != 0) {
                                            if (subProject.getSend_email().equals("1")) {
                                          //emailSended = true;
                                                proyManager = new membersData();
                                                proyManager = (membersData) memBroker.getData(subProject.getowner(), user.getId_account());
                                                
                                                    System.out.println("---------Proyect Manager--------");
                                                if (!repetidos.contains(new Integer(proyManager.getid()))) {
                                                    repetidos.add(new Integer(proyManager.getid()));
                                                    
                                                    sm.send("statustaskchange", from_member, proyManager, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                                }
                                                System.out.println("-------------------------");
                                            }
                                            idSubProject = subProject.getProject_id();
                                        } else {
                                            band = true;
                                        }
                                    }
                                    
                                    
                                } catch (Exception e) {
                                    servlet.log("[DEBUG] tasksAction Fatal error on sending email to clientManager " +  e.toString());
                                    System.out.println("Fatal error on sending email to clientManager " +
                                            e.toString());
                                }
                            }

                            if (data.getstatus() == 12) {
                                int projowner = ((projectsData) projBroker.getData(data.getproject(), user.getId_account())).getowner();
                                Iterator lista = memBroker.getProjectAdmin(1, user.getId_account());
                                membersData adminMembers = (membersData) memBroker.getData(projowner, user.getId_account());
                                
                                membersData mData= (membersData) memBroker.getData(data.getassigned_to());

                                String reason = request.getParameter("reason_for_rejected");
                                if (reason == null) {
                                    reason = "";
                                }
                                
                                        System.out.println("6-");
                                //Se le envia la notificacin de Rechazo al Administrador 
                                
                                System.out.println("--------- Reject Task Notification: Admin --------");
                                if (lista.hasNext()){
                                    sm.send("taskrejected", from_member, (membersData) lista.next(), data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                //Se le envia la notificacin de Rechazo al Dueo del Proyecto 
                                System.out.println("-------------------------");
                                        System.out.println("--------- Reject Task Notification: Project Owner --------");
                                sm.send("taskrejected", from_member, adminMembers, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                //Se le envia la notificacin de Rechazo al Dueo de la Tarea
                                System.out.println("-------------------------");
                                        System.out.println("--------- Reject Task Notification: Task Owner --------");
                                sm.send("taskrejected", from_member, mData, data.getid(), reason, user,String.valueOf(session.getAttribute("mainUrl")));
                                System.out.println("-------------------------");                                

                                String desc = "";
                                if (data.getdescription() != null) {
                                    desc = new String(data.getdescription());
                                }
                                java.text.DateFormat df = java.text.DateFormat.getDateInstance(java.text.DateFormat.MEDIUM);

                                // Se forma la descripcion del rechazo.
                                desc += "\n------------------------------------------" +
                                        "\nTarea Rechazada el " + df.format(Calendar.getInstance().getTime()) +
                                        " por " + user.gefullname() + "\n" +
                                        reason;
                                data.setdescription(desc);
                                taskBroker.update(data);
                                
                      
                            }

                            // Si es cotizacion o cotizacion enviada, enviar el correo pero tomar el monto 
                            // basado en horas estimadas
                            if ((data.getstatus() == 10 && data.getestimated_time().multiply(data.getfare()).intValue() > 0)) {                                
                           
                                System.out.println("---------ASDASD--------");
                                sm.send("accounting", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                emailSended = true;
                                System.out.println("-------------------------");
                            }

                      
                            // Se envia el email al usuario asignado de la tarea
                            if (to_member.getid() > 0 && emailSended == false) {

                     //           if (data.getstatus() != 0 && !data.getpublished().equalsIgnoreCase("0")) {
                                // Si esta finalizada por el cliente y no esta publicada
//                                } else {
                                
                                
                             //   if ( (data.getstatus()!=12) && !data.getpublished().equalsIgnoreCase("0")) {
                                if ( data.getstatus()!=12){
                                    System.out.println("---------Task Owner Member--------");
                                    sm.send("statustaskchange", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                    System.out.println("-------------------------");
                                }
                                emailSended = true;
                            }
                            
                            if(data.getstatus() == 13 ){  
                                if (data.getEmailNotifyTQA()!= 0){
                                   membersData toTQA= (membersData)memBroker.getData(data.getEmailNotifyTQA());
                                     sm.send("sendqatnotification", from_member, toTQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                            }
                            if(data.getstatus() == 11){ 
                                if (data.getEmailNotifyFQA()!= 0){
                                    membersData toFQA= (membersData)memBroker.getData(data.getEmailNotifyFQA());
                                     sm.send("sendqafnotification", from_member, toFQA, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                            }
                                        
                            
                      
                        
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                            
                             // Se extrae de la sesion el loginData
                          /*      loginData login = (loginData) session.getAttribute("login");
                                membersData from_member = (membersData) memBroker.getData(login.getid(), user.getId_account());
                                membersData to_member = (membersData) memBroker.getData(data.getassigned_to(), user.getId_account());
                                if (data.getassigned_to()!=0){
                                    //Se enva notificacin al usuario a quien se le asign la tarea            
                                    sm.send("taskassignment", from_member, to_member, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                                // Adicionalmente se le envia al duenno del proyecto.
                                membersData to_owner = (membersData) memBroker.getData(data.getparentProject().getowner(), user.getId_account());
                                if (to_owner.getid() != to_member.getid()) {
                                    // Evitamos enviarle dobles emails.
                                    sm.send("taskassignment", from_member, to_owner, data.getid(), new String(data.getname()), user,String.valueOf(session.getAttribute("mainUrl")));
                                }
                         */       
                        }
                            }
                                
                        }
                    }
                    request.setAttribute("company", company);
                    /*  Existen errores?   */
                    if (failed.size()!=0){
                        String errores= "";
                        for (int i=0; i<items.size(); i++){
                            errores+="Faltan los comentarios de la tarea: "+data.getname()+ "<br>";
                            
                        
                        }
                        errors.add("taskRejected",
                                        new ActionError(errores));
                                saveErrors(request, errors);
                          request.setAttribute("menuRoute",
                                "<a href='./admin.do'>" +
                                ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Administration") + "</a>&nbsp;/&nbsp;" 
                                + "</a><a href='./reports.do?operation=addTaskChange2'>"
                                 + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("header.displayTaskChange")
                                + "</a>&nbsp;/&nbsp;"
                            + java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Reports.reportResultsName"));
                    
                        return (mapping.findForward("viewReportChangeTask"));
                    }else{
                  
                         // Se agrega el link para el menu con la ruta
                    request.setAttribute("menuRoute",
                            "<a href='./admin.do'>" +
                            java.util.ResourceBundle.getBundle("ApplicationResources", new Locale(user.getlanguage(), "")).getString("common.Administration") + "</a>");

                        // Se redirecciona a la pagina de administracion
                        return (mapping.findForward("main"));
                    }
                }
            } catch (Exception e) {
                servlet.log("[ERROR] Action at final catch: " + e.getMessage());
                e.printStackTrace();
                logger.logp(Level.SEVERE, "tasks.do", "perform",
                        "Fatal Error: " + e.toString());

            } finally {
                // Se cierran los brokers definidos.
                taskBroker.close();
                memBroker.close();
                projBroker.close();
                fileBroker.close();
                assignBroker.close();
                messageBroker.close();
                brokerTeams.close();
                schBroker.close();
                schLogBroker.close();
            }

        }
        request.setAttribute("company", company);
        // Default if everthing else fails
        return (mapping.findForward("listing"));
    }

// Retorna la lista de organizaciones 
    private ArrayList getListing(MainBroker broker, String sortCol, String sortOrder, int accountId, int memberId) {
        Iterator e;
        // Se obtiene el iterador sobre todos los elementos de la lista.

        // if (sortCol.equals("")) {
        //     e = broker.getList();
        // } else {
        //     e = broker.getList(sortCol, sortOrder);
        // }

        e =
                broker.getList(sortCol, sortOrder, accountId);
        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }

        return lista;
    }

// Metodo que se encarga de ordernar los files dispuestos.
    private void sortFiles(HttpServletRequest request, tasksForm thisForm, filesBroker fileBroker, int accountId) {
        // Traer los valores para desplegar la lista de files disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.                                              
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageFiles();

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1     
        if (thisForm.getsource().equalsIgnoreCase("files")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageFiles(1);
            }

        }

        Iterator e = fileBroker.getList(thisForm.getsortColumnFiles(),
                thisForm.getsortOrderFiles(),
                thisForm.getid(),
                currentPage, accountId);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        while (e.hasNext()) {
            lista.add(e.next());
        }
// Se guarda la lista de files asociados a esta tarea.
        request.setAttribute("listFiles", lista);

        // Se setea el total de paginas
        setPages(fileBroker, request, "listPagesFiles");

        if (thisForm.getsource().equalsIgnoreCase("files") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderFiles().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderFiles("DESC");
            } else {
                thisForm.setsortOrderFiles("ASC");
            }

        }

    }

    // Metodo que se encarga de ordernar los assignments dispuestos.
    private void sortAssignments(HttpServletRequest request, tasksForm thisForm, assignmentsBroker assignBroker, filesBroker fileBroker, String timeZone, int idAccount) {
        // Traer los valores para desplegar la lista de Assignments disponibles.
        // Constituye un listado completo y para ello nos valemos del broker.                                              
        // Y por ultimo lo agregramos al contexto
        int currentPage = thisForm.getpageAssignments();

        // Si se trata de un sort, SIEMPRE se pasa a la pagina 1     
        if (thisForm.getsource().equalsIgnoreCase("assignments")) {
            if (thisForm.getOperation().equalsIgnoreCase("sort")) {
                // Es un sort. Siempre se pasa a la pagina 1
                currentPage = 1;
                thisForm.setpageAssignments(1);
            }

        }
        Iterator e;
        e =
                assignBroker.getList(thisForm.getsortColumnAssignments(),
                thisForm.getsortOrderAssignments(),
                thisForm.getid(), currentPage, idAccount);

        // Debemos convertir el iterador en un arraylist.
        ArrayList lista = new ArrayList();
        assignmentsData assigmentData = new assignmentsData();
        while (e.hasNext()) {
            assigmentData = new assignmentsData();
            assigmentData =
                    (assignmentsData) e.next();
            assigmentData.setassigned(Timestamp.valueOf(assigmentData.convTimeZone(assigmentData.getassigned(), timeZone)));
            lista.add(assigmentData);
        }

        request.setAttribute("listAssignments", lista);

        // Se setea el total de paginas
        setPages(assignBroker, request, "listPagesAssignments");
        assignBroker.close();
        if (thisForm.getsource().equalsIgnoreCase("assignments") &&
                thisForm.getOperation().equalsIgnoreCase("sort")) {
            // Negamos el tipo de ordenamiento
            if (thisForm.getsortOrderAssignments().equalsIgnoreCase("ASC")) {
                thisForm.setsortOrderAssignments("DESC");
            } else {
                thisForm.setsortOrderAssignments("ASC");
            }

        }

    }

    // Metodo que se encarga de dejar en el context una lista de todas las paginas
    // necesarias para dar cabida a los datos del ultimo comando de sql ejecutado.
    private void setPages(MainBroker broker, HttpServletRequest request,
            String listName) {
        // Se guarda el total de pginas en el contexto.
        ArrayList listaPages = new ArrayList();

        // Se obtiene el total de registros reales de la ultima consulta.
        int max = broker.getCount().intValue();
        int totalPage = max / broker.GAP_SIZE;
        if ((max % MainBroker.GAP_SIZE) > 0) {
            totalPage++;
        }

        for (int i = 1; i <=
                totalPage; i++) {
            listaPages.add(new Integer(i));
        }

        request.setAttribute(listName, listaPages);
    }

    private void copyFile(String source, String target, int projectId, int taskId, loginData user) {
        // Save the file
        String separator = File.separator;

        String sub = TMSConfigurator.getDownloadPath();
        // Si el string no termina con el separador de files, se agrgega
        if (!sub.endsWith(separator)) {
            sub = sub + separator;
        }

        String subdir = sub;
        if (projectId > 0) {
            subdir = subdir + "PR" + projectId + separator;
            if (taskId > 0) {
                subdir = subdir + "TK" + taskId + separator;
            }

        }
        String fullpath = subdir + target;

        File theFile = new File(fullpath);


        // Create directory for the file, if requested.
        if (theFile.getParentFile() != null) {
            theFile.getParentFile().mkdirs();
        }

        try {
            //write the file to the file specified
            InputStream in = new FileInputStream(source);
            OutputStream bos = new FileOutputStream(theFile);
            int bytesRead = 0;
            byte[] buffer = new byte[8192];
            while ((bytesRead = in.read(buffer, 0, 8192)) != -1) {
                bos.write(buffer, 0, bytesRead);
            }

            bos.close();
            in.close();
        } catch (Exception e) {
            System.out.println("Fatal Error During Copy file " + source + ": " + e.toString());
        }

    }

    public java.math.BigDecimal getEstimated_timeHour(BigDecimal time) {
        if (time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0 ||
                time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0) {
            return new BigDecimal("00");
        } else {
            BigDecimal hour = new BigDecimal(0);
            if (time.toString().replace('.', ',').split(",").length > 1) {
                String[] split_min = null;
                String replace_min = time.toString().replace('.', ',');
                split_min =
                        replace_min.split(",");
                hour =
                        new BigDecimal(split_min[0]);
                return hour;
            } else {
                return time;
            }

        }
    }

    public java.math.BigDecimal getEstimated_timeMinutes(BigDecimal time) {
        if (time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0 ||
                time.compareTo(new BigDecimal(0.0)) == 0 ||
                time.compareTo(new BigDecimal(0)) == 0) {
            return new BigDecimal(0);
        } else {
            BigDecimal min = new BigDecimal(0);
            if (time.toString().replace('.', ',').split(",").length > 1) {
                String[] split_min = null;
                String replace_min = time.toString().replace('.', ',');
                split_min = replace_min.split(",");
                min =
                        new BigDecimal(split_min[1]);
                if (time.toString().length() <= 3) {
                    min = min.multiply(new BigDecimal(10));
                }

                return min;
            } else {
                return new BigDecimal(0);
            }
        }
    }


    public int getProjectStatus(int taskStatus){
        ArrayList listStatus= new ArrayList();
        listStatus.add("1");
        listStatus.add("1");
        listStatus.add("2");
        listStatus.add("3");
        listStatus.add("4");
        listStatus.add("5");
        listStatus.add("5");
        listStatus.add("5");
        listStatus.add("5");
        listStatus.add("3");
        listStatus.add("3");
        listStatus.add("3");
        listStatus.add("3");
        listStatus.add("3");
        listStatus.add("3");

        return Integer.parseInt(""+listStatus.get(taskStatus));
    }
}
    